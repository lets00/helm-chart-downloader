---
# Source: edp-tekton/templates/dashboard/service-account.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/name: tekton-dashboard
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  name: tekton-dashboard
---
# Source: edp-tekton/templates/interceptor/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: tekton-interceptor
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
---
# Source: edp-tekton/templates/resources/pruner/rbac.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: tekton-resource-pruner
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
---
# Source: edp-tekton/templates/resources/serviceaccount-tekton.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: tekton
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
# -- Define secrets which will be mounted to service account. This allow signed image while push to Harbor
---
# Source: edp-tekton/templates/triggers/rbac.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: tekton-triggers-sa-edp-tekton-0.12.0.tgz
  namespace: edp-tekton-0.12.0.tgz
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
---
# Source: edp-tekton/templates/interceptor/interceptor-secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: tekton-edp-interceptor-certs #The edp interceptor relies on this name of the secret for populating certificates.
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
# The data is populated at install time by edp interceptor.
---
# Source: edp-tekton/templates/dashboard/cm-dashboard.yaml
apiVersion: v1
data:
  version: v0.46.0
kind: ConfigMap
metadata:
  labels:
    app: tekton-dashboard
  name: dashboard-info
---
# Source: edp-tekton/templates/resources/cm-autotest-workspace.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: autotests-workspace-template
data:
  volumeclaimtemplate.yaml: |
    metadata:
      name: shared-workspace
    spec:
      accessModes:
        - ReadWriteOnce
      volumeMode: Filesystem
      resources:
        requests:
          storage: 5Gi
---
# Source: edp-tekton/templates/resources/cm-codenarc-settings.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: custom-codenarc-settings
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
data:
  init.gradle: |
    // Copyright 2022 EPAM Systems.
    //
    // Licensed under the Apache License, Version 2.0 (the "License");
    // you may not use this file except in compliance with the License.
    // You may obtain a copy of the License at
    // http://www.apache.org/licenses/LICENSE-2.0
    //
    // Unless required by applicable law or agreed to in writing, software
    // distributed under the License is distributed on an "AS IS" BASIS,
    // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    //
    // See the License for the specific language governing permissions and
    // limitations under the License.

    allprojects {
        buildscript {
            repositories {
                maven {
                    name "maven-group"
                    credentials {
                        username nexusLogin
                        password nexusPassword
                    }
                    url "${nexusMavenRepositoryUrl}"
                    allowInsecureProtocol = true
                }
            }
            dependencies {
                classpath "org.sonarsource.scanner.gradle:sonarqube-gradle-plugin:3.3"
            }
        }

        apply plugin: 'java'
        apply plugin: 'jacoco'
        apply plugin: 'maven-publish'

        afterEvaluate { project ->
            project.apply plugin: 'org.sonarqube'
        }
    }
---
# Source: edp-tekton/templates/resources/cm-gradle-settings.yaml
# Default configuration map for provisioning Gradle init.gradle file.
# To change it, prepare another configuration map and update "tekton.configs.gradleConfigMap"
apiVersion: v1
kind: ConfigMap
metadata:
  name: custom-gradle-settings
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
data:
  SNAPSHOTS_REPO_PATH: "/repository/edp-maven-snapshots"
  RELEASES_REPO_PATH: "/repository/edp-maven-releases"
  init.gradle: |
    // Copyright 2024 EPAM Systems.
    //
    // Licensed under the Apache License, Version 2.0 (the "License");
    // you may not use this file except in compliance with the License.
    // You may obtain a copy of the License at
    // http://www.apache.org/licenses/LICENSE-2.0
    //
    // Unless required by applicable law or agreed to in writing, software
    // distributed under the License is distributed on an "AS IS" BASIS,
    // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    //
    // See the License for the specific language governing permissions and
    // limitations under the License.

    allprojects {
        buildscript {
            repositories {
                maven {
                    name "nexus"
                    credentials {
                        username = System.getenv("CI_USERNAME")
                        password = System.getenv("CI_PASSWORD")
                    }
                    url = System.getenv("NEXUS_HOST_URL") + "/repository/edp-maven-group"
                    allowInsecureProtocol = true
                }
            }
            dependencies {
                classpath "org.sonarsource.scanner.gradle:sonarqube-gradle-plugin:3.3"
            }
        }

        repositories {
            maven {
                name "nexus"
                credentials {
                    username = System.getenv("CI_USERNAME")
                    password = System.getenv("CI_PASSWORD")
                }
                url = System.getenv("NEXUS_HOST_URL") + "/repository/edp-maven-group"
                allowInsecureProtocol = true
            }
            maven {
                name "gitlab-registry"
                url = "https://gitlab.example.com/api/v4/projects/PROJECT_ID/packages/maven"
                credentials(HttpHeaderCredentials) {
                    name = System.getenv("CI_GITLAB_TOKEN_TYPE")
                    value = System.getenv("CI_GITLAB_TOKEN")
                }
                authentication {
                    header(HttpHeaderAuthentication)
                }
            }
            maven {
                name "github-registry"
                url = "https://maven.pkg.github.com/OWNER/REPOSITORY"
                credentials {
                    username = System.getenv("CI_GITHUB_USERNAME")
                    password = System.getenv("CI_GITHUB_PASSWORD")
                }
            }
            maven {
                name "azure-devops-registry"
                url 'https://pkgs.dev.azure.com'
                credentials {
                    username = System.getenv("CI_AZURE_DEVOPS_USERNAME")
                    password = System.getenv("CI_AZURE_DEVOPS_PASSWORD")
                }
            }
        }

        apply plugin: 'java'
        apply plugin: 'jacoco'
        apply plugin: 'maven-publish'

        afterEvaluate { project ->
            project.apply plugin: 'org.sonarqube'
        }
    }
---
# Source: edp-tekton/templates/resources/cm-maven-settings.yaml
# Default configuration map for provisioning Maven settings.xml file.
# To change it, prepare another configuration map and update "tekton.configs.mavenConfigMap"
apiVersion: v1
kind: ConfigMap
metadata:
  name: custom-maven-settings
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
data:
  settings.xml: |
    <?xml version="1.0" encoding="UTF-8"?>
    <!--Copyright 2024 EPAM Systems.
    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at
    http://www.apache.org/licenses/LICENSE-2.0
    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License. -->
    <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd">
        <localRepository>/workspace/source/cache</localRepository>

        <pluginGroups>
            <pluginGroup>org.sonarsource.scanner.maven</pluginGroup>
        </pluginGroups>
        <servers>
            <!-- The "nexus" server is defined to provide credentials required by the mirror. -->
            <server>
                <id>nexus</id>
                <username>${env.CI_USERNAME}</username>
                <password>${env.CI_PASSWORD}</password>
            </server>
            <!-- The "gitlab-registry" server is defined to provide credentials required by the GitLab registry.
            A token is used for authentication which is passed in HTTP headers.
            More documentation: https://docs.gitlab.com/ee/user/packages/maven_repository/ -->
            <server>
                <id>gitlab-registry</id>
                <configuration>
                    <httpHeaders>
                        <property>
                            <name>${env.CI_GITLAB_TOKEN_TYPE}</name>
                            <value>${env.CI_GITLAB_TOKEN}</value>
                        </property>
                    </httpHeaders>
                </configuration>
            </server>
            <!-- The "github-registry" server is defined to provide credentials required by the GitHub registry.
            Username and password are used for authentication.
            More documentation: https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-apache-maven-registry -->
            <server>
                <id>github-registry</id>
                <username>${env.CI_GITHUB_USERNAME}</username>
                <password>${env.CI_GITHUB_PASSWORD}</password>
            </server>
            <!-- The "azure-devops-registry" server is defined to provide credentials required by the Azure DevOps registry.
            Username and password are used for authentication.
            More documentation: https://learn.microsoft.com/en-us/azure/devops/artifacts/get-started-maven?view=azure-devops -->
            <server>
                <id>azure-devops-registry</id>
                <username>${env.CI_AZURE_DEVOPS_USERNAME}</username>
                <password>${env.CI_AZURE_DEVOPS_PASSWORD}</password>
            </server>
        </servers>

        <mirrors>
            <mirror>
                <!--This sends everything else to /public -->
                <id>nexus</id>
                <mirrorOf>*</mirrorOf>
                <url>http://nexus.nexus:8081/repository/edp-maven-group</url>
            </mirror>
        </mirrors>

        <profiles>
            <profile>
                <id>sonar</id>
                <activation>
                     <activeByDefault>true</activeByDefault>
                </activation>
                <properties>
                    <sonar.login>
                        ${env.SONAR_TOKEN}
                    </sonar.login>
                    <sonar.host.url>
                        ${env.SONAR_HOST_URL}
                    </sonar.host.url>
                </properties>
            </profile>
            <!-- Nexus profile for managing artifacts within Nexus repository. -->
            <profile>
                <id>nexus</id>
                <properties>
                    <altSnapshotDeploymentRepository>nexus::http://nexus.nexus:8081/repository/edp-maven-snapshots</altSnapshotDeploymentRepository>
                    <altReleaseDeploymentRepository>nexus::http://nexus.nexus:8081/repository/edp-maven-releases</altReleaseDeploymentRepository>
                </properties>
            </profile>
            <!-- GitLab registry profile for managing artifacts within GitLab. -->
            <profile>
                <id>gitlab-registry</id>
                <properties>
                    <altSnapshotDeploymentRepository>gitlab-registry::https://gitlab.example.com/api/v4/projects/PROJECT_ID/packages/maven</altSnapshotDeploymentRepository>
                    <altReleaseDeploymentRepository>gitlab-registry::https://gitlab.example.com/api/v4/projects/PROJECT_ID/packages/maven</altReleaseDeploymentRepository>
                </properties>
            </profile>
            <!-- GitHub registry profile for managing artifacts within GitHub. -->
            <profile>
                <id>github-registry</id>
                <properties>
                    <altSnapshotDeploymentRepository>github-registry::https://maven.pkg.github.com/OWNER/REPOSITORY</altSnapshotDeploymentRepository>
                    <altReleaseDeploymentRepository>github-registry::https://maven.pkg.github.com/OWNER/REPOSITORY</altReleaseDeploymentRepository>
                </properties>
            </profile>
            <!-- Azure DevOps registry profile for managing artifacts within Azure DevOps. -->
            <profile>
                <id>azure-devops-registry</id>
                <properties>
                    <altSnapshotDeploymentRepository>azure-devops-registry::https://pkgs.dev.azure.com</altSnapshotDeploymentRepository>
                    <altReleaseDeploymentRepository>azure-devops-registry::https://pkgs.dev.azure.com</altReleaseDeploymentRepository>
                </properties>
            </profile>
        </profiles>
        <!-- Specify the active profile here. If you want to push packages to nexus (default), gitlab registry, github registry,
        or Azure DevOps registry, change the activeProfile id to the required profile id. -->
        <activeProfiles>
            <activeProfile>nexus</activeProfile>
        </activeProfiles>
    </settings>
---
# Source: edp-tekton/templates/resources/cm-npm-settings.yaml
# Default configuration maps for provisioning NPM .npmrc files.
# To change it, prepare another configuration map and update "tekton.configs.npmConfigMap"
apiVersion: v1
kind: ConfigMap
metadata:
  name: custom-npm-settings
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
data:
  .npmrc-ci: |
    registry=${NEXUS_HOST_URL}/repository/edp-npm-group
    ${NEXUS_HOST}/repository/:email=ci.user@edp.com
    ${NEXUS_HOST}/repository/:_auth=${upBase64}
    cache=${NPM_CACHE_DIR}

  .npmrc-publish-snapshots: |
    registry=${NEXUS_HOST_URL}/repository/edp-npm-snapshots
    ${NEXUS_HOST}/repository/:email=ci.user@edp.com
    ${NEXUS_HOST}/repository/:_auth=${upBase64}
    cache=${NPM_CACHE_DIR}

  .npmrc-publish-releases: |
    registry=${NEXUS_HOST_URL}/repository/edp-npm-releases
    ${NEXUS_HOST}/repository/:email=ci.user@edp.com
    ${NEXUS_HOST}/repository/:_auth=${upBase64}
    cache=${NPM_CACHE_DIR}

  # Example of how to push changes when using Node.js version 18.10.0 with the node:18.10-alpine3.16 image
  # .npmrc-ci: |
  #   registry=${NEXUS_HOST_URL}/repository/edp-npm-group
  #   _auth=${upBase64}
  #   cache=${NPM_CACHE_DIR}

  # .npmrc-publish-snapshots: |
  #   registry=${NEXUS_HOST_URL}/repository/edp-npm-snapshots
  #   _auth=${upBase64}
  #   cache=${NPM_CACHE_DIR}

  # .npmrc-publish-releases: |
  #   registry=${NEXUS_HOST_URL}/repository/edp-npm-releases
  #   _auth=${upBase64}
  #   cache=${NPM_CACHE_DIR}

  # Example for pushing a snapshot package to GitLab
  # Ref: https://docs.gitlab.com/ee/user/packages/npm_registry/
  #.npmrc-publish-snapshots: |
  #  registry=https://gitlab.example.com/api/v4/projects/PROJECT_ID/packages/npm
  #  _authToken=${CI_GITLAB_TOKEN}
  #  cache=${NPM_CACHE_DIR}

  # Example for pushing a release package to GitLab
  # Ref: https://docs.gitlab.com/ee/user/packages/npm_registry/
  #.npmrc-publish-releases: |
  #  registry=https://gitlab.example.com/api/v4/projects/PROJECT_ID/packages/npm
  #  _authToken=${CI_GITLAB_TOKEN}
  #  cache=${NPM_CACHE_DIR}

  # Example for pushing a snapshot package to GitHub
  # Ref: https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-npm-registry
  #.npmrc-publish-snapshots: |
  #  registry=https://npm.pkg.github.com
  #  _authToken=${CI_GITHUB_PASSWORD}
  #  cache=${NPM_CACHE_DIR}

  # Example for pushing a release package to GitHub
  # Ref: https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-npm-registry
  #.npmrc-publish-releases: |
  #  registry=https://npm.pkg.github.com
  #  _authToken=${CI_GITHUB_PASSWORD}
  #  cache=${NPM_CACHE_DIR}
---
# Source: edp-tekton/templates/resources/cm-nuget-settings.yaml
# Default configuration maps for provisioning nuget.config file.
# To change it, prepare another configuration map and update "tekton.configs.nugetConfigMap"
apiVersion: v1
kind: ConfigMap
metadata:
  name: custom-nuget-settings
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
data:
  nuget.config: |
    <?xml version="1.0" encoding="utf-8"?>
    <configuration>
        <packageSources>
            <add key="nugetStorageSnapshots" value="%NEXUS_HOST_URL%/repository/edp-dotnet-snapshots" />
            <add key="nugetStorageReleases" value="%NEXUS_HOST_URL%/repository/edp-dotnet-releases" />
        </packageSources>
        <packageSourceCredentials>
            <nugetStorageSnapshots>
                <add key="Username" value="%CI_USERNAME%" />
                <add key="ClearTextPassword" value="%CI_PASSWORD%" />
            </nugetStorageSnapshots>
            <nugetStorageReleases>
                <add key="Username" value="%CI_USERNAME%" />
                <add key="ClearTextPassword" value="%CI_PASSWORD%" />
            </nugetStorageReleases>
        </packageSourceCredentials>
    </configuration>
---
# Source: edp-tekton/templates/resources/cm-python-settings.yaml
# Default configuration maps for provisioning PIP_TRUSTED_HOST, PIP_INDEX, PIP_INDEX_URL,
# REPOSITORY_URL_SNAPSHOTS and REPOSITORY_URL_RELEASES environment variables for Python tasks.
# To change it, prepare another configuration map and update "tekton.configs.pythonConfigMap"
apiVersion: v1
kind: ConfigMap
metadata:
  name: custom-python-settings
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
data:
  # Private repo index path PIP searches through. It is used by 'pip search' command.
  # e.g. '/repository/edp-python-group/pypi'
  PIP_INDEX_PATH: "/repository/edp-python-group/pypi"

  # Repo index path from wich PIP downloads private packages and public packages via proxy.
  # PIP_INDEX_URL can have only one URL while PIP_EXTRA_INDEX_URL can hold
  # multiple URLs if passed with spaces. It is used by 'pip install' command.
  # To access index via web, add slash at the end of 'simple/'.
  # e.g. '/repository/edp-python-group/simple'
  PIP_INDEX_URL_PATH: "/repository/edp-python-group/simple"

  # Path for the snapshots repository in artifact storage.
  REPOSITORY_SNAPSHOTS_PATH: "/repository/edp-python-snapshots/"

  # Path for the releases repository in artifact storage
  REPOSITORY_RELEASES_PATH: "/repository/edp-python-releases/"

  # Example for pushing a snapshot and a release packages package to GitLab
  # Ref: https://docs.gitlab.com/ee/user/packages/pypi_repository/
  #PIP_INDEX_URL_PATH: "/api/v4/projects/PROJECT_ID/packages/pypi/simple"
  #REPOSITORY_SNAPSHOTS_PATH: "/api/v4/projects/PROJECT_ID/packages/pypi/"
  #REPOSITORY_RELEASES_PATH: "/api/v4/projects/PROJECT_ID/packages/pypi/"

  # Example for pushing a snapshot and a release packages to Azure Devops Artifacts
  # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/quickstarts/python-packages?view=azure-devops
  #PIP_INDEX_URL_PATH: "/<ORGANIZATION_NAME>/<PROJECT_NAME>/_packaging/<FEED_NAME>/pypi/simple"
  #REPOSITORY_SNAPSHOTS_PATH: "/<ORGANIZATION_NAME>/<PROJECT_NAME>/_packaging/<FEED_NAME>/pypi/upload"
  #REPOSITORY_RELEASES_PATH: "/<ORGANIZATION_NAME>/<PROJECT_NAME>/_packaging/<FEED_NAME>/pypi/upload"
---
# Source: edp-tekton/templates/resources/cm-tekton-cache.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: tekton-cache
data:
  url: http://tekton-cache:8080
---
# Source: edp-tekton/templates/resources/ct-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: ct-config
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
data:
  ct.yaml: |
    validate-maintainers: false
  chart_schema.yaml:
    |
      name: str()
      home: str()
      version: str()
      type: str()
      apiVersion: str()
      appVersion: any(str(), num())
      description: str()
      keywords: list(str(), required=False)
      sources: list(str(), required=True)
      maintainers: list(include('maintainer'), required=True)
      dependencies: list(include('dependency'), required=False)
      icon: str(required=False)
      engine: str(required=False)
      condition: str(required=False)
      tags: str(required=False)
      deprecated: bool(required=False)
      kubeVersion: str(required=False)
      annotations: map(str(), str(), required=False)
      ---
      maintainer:
        name: str(required=True)
        email: str(required=False)
        url: str(required=False)
      ---
      dependency:
        name: str()
        version: str()
        repository: str()
        condition: str(required=False)
        tags: list(str(), required=False)
        enabled: bool(required=False)
        import-values: any(list(str()), list(include('import-value')), required=False)
        alias: str(required=False)
  lintconf.yaml:
    |
      ---
      rules:
        braces:
          min-spaces-inside: 0
          max-spaces-inside: 0
          min-spaces-inside-empty: -1
          max-spaces-inside-empty: -1
        brackets:
          min-spaces-inside: 0
          max-spaces-inside: 0
          min-spaces-inside-empty: -1
          max-spaces-inside-empty: -1
        colons:
          max-spaces-before: 0
          max-spaces-after: 1
        commas:
          max-spaces-before: 0
          min-spaces-after: 1
          max-spaces-after: 1
        comments:
          require-starting-space: true
          min-spaces-from-content: 2
        document-end: disable
        document-start: disable           # No --- to start a file
        empty-lines:
          max: 2
          max-start: 0
          max-end: 0
        hyphens:
          max-spaces-after: 1
        indentation:
          spaces: consistent
          indent-sequences: whatever      # - list indentation will handle both indentation and without
          check-multi-line-strings: false
        key-duplicates: enable
        line-length: disable              # Lines can be any length
        new-line-at-end-of-file: enable
        new-lines:
          type: unix
        trailing-spaces: enable
        truthy:
          level: warning
---
# Source: edp-tekton/templates/resources/pruner/configmap.yaml
kind: ConfigMap
apiVersion: v1
metadata:
  name: tekton-resource-pruner-scripts
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
data:
  tekton-prune.sh: |
    #!/usr/bin/env bash
  
    set -o errtrace
    trap 'echo "error occurred on line ${LINENO}"; exit 1' ERR
  
    verify() {
      echo 'Verify that kubectl is installed'
      if ! command -v kubectl &> /dev/null; then
        echo "kubectl could not be found"
        exit 1
      fi
      echo 'Ok'
      echo 'Verify that namespace variables are defined'
      if test -z "${NAMESPACE}"; then
        echo 'NAMESPACE env variable not defined.'
        exit 1
      fi
      echo 'Ok'
    }
  
    get_pipelinerun_to_file() {
      pods_file_path="$1"
      kubectl get -n "${NAMESPACE}" pipelinerun -o name > "${pods_file_path}"
    }
  
  
    get_active_pipelineruns() {
      kubectl get -n "${NAMESPACE}" pipelineruns \
        -o jsonpath='{.items[?(@.status.conditions[0].reason=="Running")].metadata.name}'
    }
  
  
    delete_lines_from_file() {
      file="$1"
      lines_to_delete="$2"
      for line in ${lines_to_delete[@]}; do
        sed -i "/${line}/d" "${file}"
      done
    }
  
    prune_resources() {
      resources_to_delete_file_path="$1"
      type="$2"
      resource_list=''
      while IFS= read -r line || [[ -n "${line}" ]]; do
        if ! test -z "${line}"; then resource_list="${resource_list} ${type}${line}"; fi
      done < "$resources_to_delete_file_path"
      if test -z "${resource_list// }"; then
        echo 'No resources to delete'
      else
        kubectl delete -n "${NAMESPACE}" ${resource_list} --force --grace-period=0;
      fi
    }
  
    main() {
      separator=';'
      pvc_owner_kind='PipelineRun'
      pipelinerun_to_delete_file_path='/tmp/runs-to-delete.txt'
  
      verify
  
      echo 'Get active pipelineruns'
      active_pipelineruns=$(get_active_pipelineruns)
      echo "Running pipelineruns: $active_pipelineruns"
  
      echo "Get pipelinerun list"
      get_pipelinerun_to_file "${pipelinerun_to_delete_file_path}"
      cat "${pipelinerun_to_delete_file_path}"
  
      echo 'Exclude running pipelineruns from deletion list':
      delete_lines_from_file "${pipelinerun_to_delete_file_path}" "${active_pipelineruns}"
      cat "${pipelinerun_to_delete_file_path}"
  
      echo 'Delete pipelineruns'
      prune_resources "${pipelinerun_to_delete_file_path}" ''
      echo 'Ok'
  
    }
  
    main
---
# Source: edp-tekton/charts/tekton-cache/templates/pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cache
  labels:
    helm.sh/chart: tekton-cache-0.3.3
    app.kubernetes.io/name: tekton-cache
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "0.3.3"
    app.kubernetes.io/managed-by: Helm
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
---
# Source: edp-tekton/templates/triggers/rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: tekton-triggers-eventlistener-clusterbinding-edp-tekton-0.12.0.tgz
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
subjects:
  - kind: ServiceAccount
    name: tekton-triggers-sa-edp-tekton-0.12.0.tgz
    namespace: edp-tekton-0.12.0.tgz
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: tekton-triggers-eventlistener-clusterroles
---
# Source: edp-tekton/templates/dashboard/role.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/name: tekton-dashboard
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  name: tekton-dashboard-info
  namespace: edp-tekton-0.12.0.tgz
rules:
  - apiGroups:
      - ""
    resourceNames:
      - dashboard-info
    resources:
      - configmaps
    verbs:
      - get
---
# Source: edp-tekton/templates/dashboard/role.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/name: tekton-dashboard
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  name: tekton-dashboard-backend
  namespace: edp-tekton-0.12.0.tgz
rules:
  - apiGroups:
      - apiextensions.k8s.io
    resources:
      - customresourcedefinitions
    verbs:
      - get
      - list
  - apiGroups:
      - security.openshift.io
    resources:
      - securitycontextconstraints
    verbs:
      - use
  - apiGroups:
      - ""
    resources:
      - serviceaccounts
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - dashboard.tekton.dev
    resources:
      - extensions
    verbs:
      - create
      - update
      - delete
      - patch
---
# Source: edp-tekton/templates/dashboard/role.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/name: tekton-dashboard
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  name: tekton-dashboard-tenant
  namespace: edp-tekton-0.12.0.tgz
rules:
  - apiGroups:
      - dashboard.tekton.dev
    resources:
      - extensions
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - ""
    resources:
      - events
      - namespaces
      - pods
      - pods/log
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - tekton.dev
    resources:
      - tasks
      - taskruns
      - pipelines
      - pipelineruns
      - pipelineresources
      - runs
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - triggers.tekton.dev
    resources:
      - eventlisteners
      - triggerbindings
      - triggers
      - triggertemplates
      - interceptors
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - tekton.dev
    resources:
      - tasks
      - taskruns
      - pipelines
      - pipelineruns
      - pipelineresources
      - runs
    verbs:
      - create
      - update
      - delete
      - patch
  - apiGroups:
      - triggers.tekton.dev
    resources:
      - eventlisteners
      - triggerbindings
      - triggers
      - triggertemplates
      - interceptors
    verbs:
      - create
      - update
      - delete
      - patch
---
# Source: edp-tekton/templates/interceptor/role.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: tekton-triggers-edp-interceptor
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
rules:
  - verbs:
      - get
      - list
      - watch
      - update
    apiGroups:
      - triggers.tekton.dev
    resources:
      - interceptors

  - verbs:
      - get
      - list
      - watch
      - update
      - create
    apiGroups:
      - ''
    resources:
      - secrets
    resourceNames:
      - tekton-edp-interceptor-certs

  - verbs:
      - get
    apiGroups:
      - ''
    resources:
      - secrets

  - verbs:
      - get
      - list
      - watch
    apiGroups:
      - v2.edp.epam.com
    resources:
      - codebases
      - codebases/status
      - codebases/finalizers

  - verbs:
      - get
      - list
      - watch
    apiGroups:
      - v2.edp.epam.com
    resources:
      - codebasebranches
      - codebasebranches/status
      - codebasebranches/finalizers

  - verbs:
      - get
      - list
      - watch
    apiGroups:
      - v2.edp.epam.com
    resources:
      - gitservers
      - gitservers/status
      - gitservers/finalizers
---
# Source: edp-tekton/templates/resources/pruner/rbac.yaml
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: tekton-resource-pruner
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
rules:
  - apiGroups:
      - tekton.dev
    verbs:
      - get
      - list
      - delete
    resources:
      - pipelineruns
  - apiGroups:
      - ''
    verbs:
      - get
    resources:
      - ConfigMap
    resourceNames:
      - tekton-resource-pruner-scripts
---
# Source: edp-tekton/templates/resources/role-tekton-autotest.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  name: tekton-autotests-role
rules:
  - verbs:
      - create
      - get
      - list
      - watch
      - patch
      - update
    apiGroups:
      - tekton.dev
    resources:
      - pipelines
      - pipelineruns
  - verbs:
      - get
      - list
      - watch
    apiGroups:
      - v2.edp.epam.com
    resources:
      - codebases
      - gitservers
      - stages
  - verbs:
      - list
      - get
    apiGroups:
      - argoproj.io
    resources:
      - applications
---
# Source: edp-tekton/templates/resources/role-tekton.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  name: tekton-pipeline-role
rules:
  # allow to get configs for EDP from configmap
  - apiGroups:
      - ""
    resources:
      - configmaps
    verbs:
      - get
      - list
      - watch

  # baseline operations with codebase and cbis
  - apiGroups:
      - 'v2.edp.epam.com'
    resources:
      - cdpipelines
      - codebasebranches
      - codebasebranches/status
      - codebaseimagestreams
      - codebases
      - stages
    verbs:
      - get
      - update
      - patch
      - list

  # we need to create jira issues
  - apiGroups:
      - 'v2.edp.epam.com'
    resources:
      - jiraissuemetadatas
    verbs:
      - create
      - get

  # we need to get information about the taskRun running in ns containers
  - verbs:
      - get
      - list
      - watch
    apiGroups:
      - tekton.dev
    resources:
      - taskruns

  # we need to manage Argo ApplicationSet (except create, delete)
  - verbs:
      - get
      - list
      - watch
      - update
      - patch
    apiGroups:
      - argoproj.io
    resources:
      - applicationsets
---
# Source: edp-tekton/templates/dashboard/role-binding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/name: tekton-dashboard
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  name: tekton-dashboard-info
  namespace: edp-tekton-0.12.0.tgz
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: tekton-dashboard-info
subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: Group
    name: system:authenticated
---
# Source: edp-tekton/templates/dashboard/role-binding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/name: tekton-dashboard
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  name: tekton-dashboard-backend
  namespace: edp-tekton-0.12.0.tgz
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: tekton-dashboard-backend
subjects:
  - kind: ServiceAccount
    name: tekton-dashboard
    namespace: edp-tekton-0.12.0.tgz
---
# Source: edp-tekton/templates/dashboard/role-binding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/name: tekton-dashboard
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  name: tekton-dashboard-tenant
  namespace: edp-tekton-0.12.0.tgz
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: tekton-dashboard-tenant
subjects:
  - kind: ServiceAccount
    name: tekton-dashboard
    namespace: edp-tekton-0.12.0.tgz
---
# Source: edp-tekton/templates/interceptor/rolebinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: tekton-triggers-edp-interceptor
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
subjects:
  - kind: ServiceAccount
    name: tekton-interceptor
    namespace: edp-tekton-0.12.0.tgz
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: tekton-triggers-edp-interceptor
---
# Source: edp-tekton/templates/resources/pruner/rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: tekton-resource-pruner
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
subjects:
  - kind: ServiceAccount
    name: tekton-resource-pruner
    namespace: edp-tekton-0.12.0.tgz
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: tekton-resource-pruner
---
# Source: edp-tekton/templates/resources/rolebinding-tekton-autotest.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  name: tekton-autotests-rolebinding
subjects:
  - kind: ServiceAccount
    name: tekton
    namespace: edp-tekton-0.12.0.tgz
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: tekton-autotests-role
---
# Source: edp-tekton/templates/resources/rolebinding-tekton.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  name: tekton-pipeline-role
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: tekton-pipeline-role
subjects:
  - kind: ServiceAccount
    name: tekton
    namespace: edp-tekton-0.12.0.tgz
---
# Source: edp-tekton/templates/triggers/rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: tekton-triggers-eventlistener-binding-edp-tekton-0.12.0.tgz
  namespace: edp-tekton-0.12.0.tgz
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
subjects:
  - kind: ServiceAccount
    name: tekton-triggers-sa-edp-tekton-0.12.0.tgz
    namespace: edp-tekton-0.12.0.tgz
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: tekton-triggers-eventlistener-roles
---
# Source: edp-tekton/charts/tekton-cache/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: tekton-cache
  labels:
    helm.sh/chart: tekton-cache-0.3.3
    app.kubernetes.io/name: tekton-cache
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "0.3.3"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: tekton-cache
    app.kubernetes.io/instance: my-release
---
# Source: edp-tekton/templates/dashboard/service.yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/name: tekton-dashboard
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  name: tekton-dashboard
  
spec:
  type: ClusterIP
  ports:
    - port: 8080
    
      targetPort: 9097
    
      protocol: TCP
      name: http
  selector:
    
    app.kubernetes.io/name: tekton-dashboard
    app.kubernetes.io/instance: my-release
---
# Source: edp-tekton/templates/interceptor/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: tekton-triggers-edp-interceptor
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 8443
      targetPort: https
      protocol: TCP
      name: https
  selector:
    app.kubernetes.io/name: tekton-interceptor
    app.kubernetes.io/instance: my-release
---
# Source: edp-tekton/charts/tekton-cache/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tekton-cache
  labels:
    helm.sh/chart: tekton-cache-0.3.3
    app.kubernetes.io/name: tekton-cache
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "0.3.3"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: tekton-cache
      app.kubernetes.io/instance: my-release
  template:
    metadata:
      labels:
        app.kubernetes.io/name: tekton-cache
        app.kubernetes.io/instance: my-release
    spec:
      volumes:
        - name: cache
          persistentVolumeClaim:
            claimName: cache
      securityContext:
        {}
      initContainers:
        - name: fix-permissions
          image: busybox:1.36.1
          command:
            - chmod
            - '-R'
            - '0775'
            - /uploads
          resources: {}
          volumeMounts:
            - name: cache
              mountPath: /uploads
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          imagePullPolicy: Always
          securityContext:
            privileged: true
            runAsUser: 0
      containers:
        - name: tekton-cache
          volumeMounts:
            - mountPath: "/uploads"
              name: cache
          securityContext:
            {}
          image: "epamedp/tekton-cache:0.1.2"
          imagePullPolicy: IfNotPresent
          env:
            - name: UPLOADER_HOST
              value: "0.0.0.0"
            - name: UPLOADER_PORT
              value: "8080"
            - name: UPLOADER_DIRECTORY
              value: "/uploads"
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          resources:
            {}
---
# Source: edp-tekton/templates/dashboard/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/name: tekton-dashboard
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  name: tekton-dashboard
spec:
  replicas: 1
  selector:
    matchLabels:
      
      app.kubernetes.io/name: tekton-dashboard
      app.kubernetes.io/instance: my-release
  template:
    metadata:
      labels:
        helm.sh/chart: edp-tekton-0.12.0
        app.kubernetes.io/name: tekton-dashboard
        app.kubernetes.io/instance: my-release
        app.kubernetes.io/version: "0.12.0"
        app.kubernetes.io/managed-by: Helm
    spec:
      containers:
      
        - args:
            - --port=9097
            - --logout-url=
            - --pipelines-namespace=tekton-pipelines
            - --triggers-namespace=tekton-pipelines
            - --read-only=false
            - --log-level=info
            - --log-format=json
            - --stream-logs=true
            - --external-logs=
            - --namespaces=edp-tekton-0.12.0.tgz
          env:
            - name: INSTALLED_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          image: gcr.io/tekton-releases/github.com/tektoncd/dashboard/cmd/dashboard:v0.46.0
          livenessProbe:
            httpGet:
              path: /health
              port: 9097
          name: tekton-dashboard
          ports:
            - containerPort: 9097
          readinessProbe:
            httpGet:
              path: /readiness
              port: 9097
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            runAsGroup: 65532
            runAsNonRoot: true
            runAsUser: 65532
            seccompProfile:
              type: RuntimeDefault
          resources:
            limits:
              cpu: 60m
              memory: 70Mi
            requests:
              cpu: 50m
              memory: 40Mi
      serviceAccount: tekton-dashboard
      serviceAccountName: tekton-dashboard
---
# Source: edp-tekton/templates/interceptor/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tekton-interceptor
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: tekton-interceptor
      app.kubernetes.io/instance: my-release
  template:
    metadata:
      labels:
        app.kubernetes.io/name: tekton-interceptor
        app.kubernetes.io/instance: my-release
    spec:
      serviceAccountName: tekton-interceptor
      securityContext:
        {}
      containers:
        - command:
          - /edpinterceptor
          args:
            - '-logtostderr'
            - '-stderrthreshold'
            - INFO
          env:
            - name: SYSTEM_NAMESPACE
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
            - name: CONFIG_LOGGING_NAME
              value: config-logging-triggers
            - name: CONFIG_OBSERVABILITY_NAME
              value: config-observability-triggers
            - name: METRICS_DOMAIN
              value: tekton.dev/triggers
            - name: INTERCEPTOR_NAME
              value: edp
          name: tekton-triggers-edp-interceptor
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - ALL
            readOnlyRootFilesystem: true
            runAsGroup: 65532
            runAsNonRoot: true
            runAsUser: 65532
          image: "epamedp/edp-tekton:0.12.0"
          imagePullPolicy: IfNotPresent
          ports:
            - name: https
              containerPort: 8443
              protocol: TCP
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /ready
              port: 8443
              scheme: HTTPS
            initialDelaySeconds: 5
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 5
          resources:
            limits:
              cpu: 70m
              memory: 60Mi
            requests:
              cpu: 50m
              memory: 40Mi
---
# Source: edp-tekton/templates/resources/pruner/cron-job.yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: tekton-resource-pruner
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  schedule: "0 10 */1 * *"
  suspend: false
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 3
      template:
        spec:
          volumes:
            - name: scripts
              configMap:
                name: tekton-resource-pruner-scripts
          containers:
            - name: kubectl
              image: "bitnami/kubectl:1.25"
              env:
                - name: NAMESPACE
                  valueFrom:
                    fieldRef:
                      apiVersion: v1
                      fieldPath: metadata.namespace
              command:
                - bash
                - /scripts/tekton-prune.sh
              volumeMounts: [{name: scripts, mountPath: /scripts}]
              resources:
                limits:
                  cpu: 100m
                  memory: 70Mi
                requests:
                  cpu: 50m
                  memory: 50Mi
          restartPolicy: OnFailure
          serviceAccountName: tekton-resource-pruner
          serviceAccount: tekton-resource-pruner
      ttlSecondsAfterFinished: 10
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
---
# Source: edp-tekton/templates/dashboard/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: tekton-dashboard
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/name: tekton-dashboard
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  rules:
    - host: tekton-edp-tekton-0.12.0.tgz.
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: tekton-dashboard
                port:
                  name: http
---
# Source: edp-tekton/templates/interceptor/interceptor.yaml
apiVersion: triggers.tekton.dev/v1alpha1
kind: Interceptor
metadata:
  name: edp
  labels:
    server/type: https
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  clientConfig:
    service:
      name: tekton-triggers-edp-interceptor
      namespace: edp-tekton-0.12.0.tgz
      port: 8443
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java11-aut-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-gradle'
      description: "Project name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - sonar
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java17-aut-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-gradle'
      description: "Project name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - sonar
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java8-aut-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-gradle'
      description: "Project name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - sonar
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java11-aut-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - sonar
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java17-aut-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - sonar
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java8-aut-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - sonar
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java11-aut-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'java11-gradle'
      description: "Project name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-refspec) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java17-aut-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'java17-gradle'
      description: "Project name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-refspec) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java8-aut-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'java8-gradle'
      description: "Project name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-refspec) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java11-aut-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-gradle'
      description: "Project name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - sonar
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java17-aut-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-gradle'
      description: "Project name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - sonar
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java8-aut-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-gradle'
      description: "Project name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - sonar
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java11-aut-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - sonar
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java17-aut-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - sonar
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java8-aut-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - sonar
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java11-aut-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java11-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java17-aut-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java17-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java8-aut-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java8-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java11-aut-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-gradle'
      description: "Project name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - sonar
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java17-aut-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-gradle'
      description: "Project name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - sonar
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java8-aut-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-gradle'
      description: "Project name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - sonar
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java11-aut-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - sonar
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java17-aut-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - sonar
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java8-aut-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - sonar
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java11-aut-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java11-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java17-aut-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java17-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java8-aut-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java8-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java11-aut-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - get-version
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - update-build-number
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java17-aut-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - get-version
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - update-build-number
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java8-aut-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - get-version
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - update-build-number
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java11-aut-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - get-version
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - get-version
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java17-aut-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - get-version
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - get-version
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java8-aut-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - get-version
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - get-version
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java11-aut-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)

    - name: test
      taskRef:
        kind: Task
        name: run-tests-for-autotests
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-refspec)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java17-aut-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)

    - name: test
      taskRef:
        kind: Task
        name: run-tests-for-autotests
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-refspec)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java8-aut-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)

    - name: test
      taskRef:
        kind: Task
        name: run-tests-for-autotests
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-refspec)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/maven/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java11-aut-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - get-version
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - update-build-number
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/maven/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java17-aut-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - get-version
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - update-build-number
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/maven/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java8-aut-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - get-version
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - update-build-number
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/maven/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java11-aut-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - get-version
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - get-version
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/maven/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java17-aut-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - get-version
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - get-version
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/maven/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java8-aut-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - get-version
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - get-version
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/maven/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java11-aut-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: test
      taskRef:
        kind: Task
        name: run-tests-for-autotests
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/autotests/maven/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java17-aut-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: test
      taskRef:
        kind: Task
        name: run-tests-for-autotests
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/autotests/maven/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java8-aut-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: test
      taskRef:
        kind: Task
        name: run-tests-for-autotests
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java11-aut-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - get-version
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - update-build-number
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java17-aut-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - get-version
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - update-build-number
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java8-aut-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - get-version
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - update-build-number
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java11-aut-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - get-version
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - get-version
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java17-aut-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - get-version
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - get-version
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java8-aut-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - get-version
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - get-version
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java11-aut-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: test
      taskRef:
        kind: Task
        name: run-tests-for-autotests
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java17-aut-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: test
      taskRef:
        kind: Task
        name: run-tests-for-autotests
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java8-aut-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: "maven:3.9.0-eclipse-temurin-17"
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: test
      taskRef:
        kind: Task
        name: run-tests-for-autotests
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/cd-autotests/autotest.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: autotests-maven
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/SergK/autotests.git"
    - name: git-source-revision
      default: "master"
    - name: stage-name
      default: "dev"
    - name: base-image
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
          kind: Task
          name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: run-autotest
      taskRef:
        kind: Task
        name: run-autotests-maven
      runAfter:
        - fetch-repository
      params:
        - name: base-image
          value: "$(params.base-image)"
        - name: stage-name
          value: "$(params.stage-name)"
      workspaces:
        - name: source
          workspace: shared-workspace
---
# Source: edp-tekton/templates/pipelines/cd-autotests/autotest.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: autotests-gradle
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/SergK/autotests.git"
    - name: git-source-revision
      default: "master"
    - name: stage-name
      default: "dev"
    - name: base-image
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
          kind: Task
          name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: run-autotest
      taskRef:
        kind: Task
        name: run-autotests-gradle
      runAfter:
        - fetch-repository
      params:
        - name: base-image
          value: "$(params.base-image)"
        - name: stage-name
          value: "$(params.stage-name)"
      workspaces:
        - name: source
          workspace: shared-workspace
---
# Source: edp-tekton/templates/pipelines/cd/deploy-with-autotests.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: deploy-with-autotests
  labels:
    app.edp.epam.com/pipelinetype: deploy
spec:
  description: |
    This Pipeline is used to deploy applications to the target Stage (Environment).
  workspaces:
    - name: shared-workspace
  params:
    - name: pipelineUrl
      description: |
        URL of the pipeline run in Tekton Dashboard.
      type: string
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
    - name: CDPIPELINE
      description: |
        EDP kind:CDPipeline name used for deployment. For example: mypipe, myfeature
      type: string
    - name: CDSTAGE
      description: |
        EDP kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
      type: string
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: {"codebase1": {"imageTag": "version1", "customValues": true}, "codebase2": {"imageTag": "version2", "customValues": true}}. For example: {"demo": {"imageTag": "main-20240103-141431", "customValues": true}, "myapp": {"imageTag": "0.1.0-SNAPSHOT.1", "customValues": true}}
      type: string
    - name: KUBECONFIG_SECRET_NAME
      description: The name of secret with Kubeconfig to connect to the remote cluster
      type: string
    - name: autotes-pipeline
      default: "autotes-pipeline"
    - name: codebase_tags
      default: "codebase_tags"
    - name: parent-pipeline-name
      default: $(context.pipelineRun.name)
  tasks:
    - name: pre-deploy
      taskRef:
        kind: Task
        name: run-quality-gate
      params:
        - name: KUBECONFIG_SECRET_NAME
          value: $(params.KUBECONFIG_SECRET_NAME)
        - name: BASE_IMAGE
          value: "bitnami/kubectl:1.25.4"
        - name: EXTRA_COMMANDS
          value:
            echo "Hello World"

    - name: deploy-app
      taskRef:
        kind: Task
        name: deploy-applicationset-cli
      runAfter:
        - pre-deploy
      params:
        - name: PIPELINE
          value: $(params.CDPIPELINE)
        - name: STAGE
          value: $(params.CDSTAGE)
        - name: APPLICATIONS_PAYLOAD
          value: $(params.APPLICATIONS_PAYLOAD)

    - name: post-deploy
      taskRef:
        kind: Task
        name: run-quality-gate
      runAfter:
        - deploy-app
      params:
        - name: KUBECONFIG_SECRET_NAME
          value: $(params.KUBECONFIG_SECRET_NAME)
        - name: BASE_IMAGE
          value: "bitnami/kubectl:1.25.4"
        - name: EXTRA_COMMANDS
          value:
            echo "Hello World"

    - name: init-autotest
      taskRef:
          kind: Task
          name: init-autotest
      runAfter:
         - post-deploy
      params:
        - name: stage-name
          value: $(params.CDSTAGE)
        - name: cd-pipeline-name
          value: $(params.CDPIPELINE)
        - name: AUTOTEST_PIPELINES
          value: $(params.autotes-pipeline)
        - name: codebase_tags
          value: $(params.codebase_tags)
        - name: parent-pipeline-name
          value: $(params.parent-pipeline-name)
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: wait-for-autotests
      taskRef:
          kind: Task
          name: wait-for-autotests
      runAfter:
         - init-autotest
      params:
        - name: AUTOTEST_PIPELINES
          value: $(params.autotes-pipeline)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: promote-images
      taskRef:
        kind: Task
        name: promote-images
      runAfter:
        - wait-for-autotests
      params:
        - name: APPLICATIONS_PAYLOAD
          value: $(params.APPLICATIONS_PAYLOAD)
        - name: CDPIPELINE_STAGE
          value: $(params.CDSTAGE)
        - name: CDPIPELINE_CR
          value: $(params.CDPIPELINE)
---
# Source: edp-tekton/templates/pipelines/cd/deploy.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: deploy
  labels:
    app.edp.epam.com/pipelinetype: deploy
spec:
  description: |
    This Pipeline is used to deploy applications to the target Stage (Environment).
  params:
    - name: pipelineUrl
      description: |
        URL of the pipeline run in Tekton Dashboard.
      type: string
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
    - name: CDPIPELINE
      description: |
        EDP kind:CDPipeline name used for deployment. For example: mypipe, myfeature
      type: string
    - name: CDSTAGE
      description: |
        EDP kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
      type: string
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: {"codebase1": {"imageTag": "version1", "customValues": true}, "codebase2": {"imageTag": "version2", "customValues": true}}. For example: {"demo": {"imageTag": "main-20240103-141431", "customValues": true}, "myapp": {"imageTag": "0.1.0-SNAPSHOT.1", "customValues": true}}
      type: string
    - name: KUBECONFIG_SECRET_NAME
      description: The name of secret with Kubeconfig to connect to the remote cluster
      type: string
  tasks:
    - name: pre-deploy
      taskRef:
        kind: Task
        name: run-quality-gate
      params:
        - name: KUBECONFIG_SECRET_NAME
          value: $(params.KUBECONFIG_SECRET_NAME)
        - name: BASE_IMAGE
          value: "bitnami/kubectl:1.25.4"
        - name: EXTRA_COMMANDS
          value:
            echo "Hello World"

    - name: deploy-app
      taskRef:
        kind: Task
        name: deploy-applicationset-cli
      runAfter:
        - pre-deploy
      params:
        - name: PIPELINE
          value: $(params.CDPIPELINE)
        - name: STAGE
          value: $(params.CDSTAGE)
        - name: APPLICATIONS_PAYLOAD
          value: $(params.APPLICATIONS_PAYLOAD)

    - name: post-deploy
      taskRef:
        kind: Task
        name: run-quality-gate
      runAfter:
        - deploy-app
      params:
        - name: KUBECONFIG_SECRET_NAME
          value: $(params.KUBECONFIG_SECRET_NAME)
        - name: BASE_IMAGE
          value: "bitnami/kubectl:1.25.4"
        - name: EXTRA_COMMANDS
          value:
            echo "Hello World"

    - name: promote-images
      taskRef:
        kind: Task
        name: promote-images
      runAfter:
        - post-deploy
      params:
        - name: APPLICATIONS_PAYLOAD
          value: $(params.APPLICATIONS_PAYLOAD)
        - name: CDPIPELINE_STAGE
          value: $(params.CDSTAGE)
        - name: CDPIPELINE_CR
          value: $(params.CDPIPELINE)
---
# Source: edp-tekton/templates/pipelines/csharp/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-dotnet-dotnet-3.1-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-3.1"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-3.1'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:3.1.423-alpine3.16"
      description: "dotnet-sdk image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-dotnet-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dotnet-publish
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - push
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            dotnet publish --configuration Release --output app
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - dotnet-publish
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-dotnet-dotnet-6.0-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-6.0"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-6.0'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:6.0.407-alpine3.17"
      description: "dotnet-sdk image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-dotnet-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dotnet-publish
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - push
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            dotnet publish --configuration Release --output app
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - dotnet-publish
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-dotnet-dotnet-3.1-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-3.1"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-3.1'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:3.1.423-alpine3.16"
      description: "dotnet-sdk image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-csharp
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dotnet-publish
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - push
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            dotnet publish --configuration Release --output app
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - dotnet-publish
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-dotnet-dotnet-6.0-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-6.0"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-6.0'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:6.0.407-alpine3.17"
      description: "dotnet-sdk image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-csharp
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dotnet-publish
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - push
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            dotnet publish --configuration Release --output app
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - dotnet-publish
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/gerrit-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-dotnet-dotnet-3.1-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-3.1"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-3.1'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:3.1.423-alpine3.16"
      description: "dotnet-sdk image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-dotnet-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/gerrit-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-dotnet-dotnet-6.0-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-6.0"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-6.0'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:6.0.407-alpine3.17"
      description: "dotnet-sdk image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-dotnet-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/gerrit-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-dotnet-dotnet-3.1-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-3.1"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-3.1'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:3.1.423-alpine3.16"
      description: "dotnet-sdk image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-csharp
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/gerrit-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-dotnet-dotnet-6.0-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-6.0"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-6.0'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:6.0.407-alpine3.17"
      description: "dotnet-sdk image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-csharp
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/gerrit-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-dotnet-dotnet-3.1-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-3.1"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-3.1'
      description: "Project name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:3.1.423-alpine3.16"
      description: "dotnet-sdk image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-refspec)
        - name: key-id
          value: $(params.changeNumber)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.pullrequest.key=${KEY_ID} \
              /d:sonar.pullrequest.branch=${SOURCE_BRANCH} \
              /d:sonar.pullrequest.base=${TARGET_BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/csharp/gerrit-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-dotnet-dotnet-6.0-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-6.0"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-6.0'
      description: "Project name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:6.0.407-alpine3.17"
      description: "dotnet-sdk image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-refspec)
        - name: key-id
          value: $(params.changeNumber)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.pullrequest.key=${KEY_ID} \
              /d:sonar.pullrequest.branch=${SOURCE_BRANCH} \
              /d:sonar.pullrequest.base=${TARGET_BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/csharp/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-dotnet-dotnet-3.1-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-3.1"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-3.1'
      description: "Project name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:3.1.423-alpine3.16"
      description: "dotnet-sdk image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-refspec)
        - name: key-id
          value: $(params.changeNumber)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.pullrequest.key=${KEY_ID} \
              /d:sonar.pullrequest.branch=${SOURCE_BRANCH} \
              /d:sonar.pullrequest.base=${TARGET_BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dotnet-publish
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            dotnet publish --configuration Release --output app
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - dotnet-publish
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/csharp/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-dotnet-dotnet-6.0-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-6.0"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-6.0'
      description: "Project name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:6.0.407-alpine3.17"
      description: "dotnet-sdk image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-refspec)
        - name: key-id
          value: $(params.changeNumber)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.pullrequest.key=${KEY_ID} \
              /d:sonar.pullrequest.branch=${SOURCE_BRANCH} \
              /d:sonar.pullrequest.base=${TARGET_BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dotnet-publish
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            dotnet publish --configuration Release --output app
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - dotnet-publish
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/csharp/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-dotnet-dotnet-3.1-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-3.1"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-3.1'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:3.1.423-alpine3.16"
      description: "dotnet-sdk image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-dotnet-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dotnet-publish
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - push
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            dotnet publish --configuration Release --output app
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - dotnet-publish
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-dotnet-dotnet-6.0-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-6.0"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-6.0'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:6.0.407-alpine3.17"
      description: "dotnet-sdk image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-dotnet-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dotnet-publish
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - push
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            dotnet publish --configuration Release --output app
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - dotnet-publish
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-dotnet-dotnet-3.1-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-3.1"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-3.1'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:3.1.423-alpine3.16"
      description: "dotnet-sdk image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-csharp
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dotnet-publish
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - push
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            dotnet publish --configuration Release --output app
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - dotnet-publish
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-dotnet-dotnet-6.0-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-6.0"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-6.0'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:6.0.407-alpine3.17"
      description: "dotnet-sdk image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-csharp
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dotnet-publish
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - push
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            dotnet publish --configuration Release --output app
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - dotnet-publish
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/github-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-dotnet-dotnet-3.1-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-3.1"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-3.1'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:3.1.423-alpine3.16"
      description: "dotnet-sdk image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-dotnet-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/github-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-dotnet-dotnet-6.0-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-6.0"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-6.0'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:6.0.407-alpine3.17"
      description: "dotnet-sdk image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-dotnet-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/github-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-dotnet-dotnet-3.1-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-3.1"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-3.1'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:3.1.423-alpine3.16"
      description: "dotnet-sdk image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-csharp
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/github-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-dotnet-dotnet-6.0-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-6.0"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-6.0'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:6.0.407-alpine3.17"
      description: "dotnet-sdk image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-csharp
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/github-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-dotnet-dotnet-3.1-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-3.1"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-3.1'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:3.1.423-alpine3.16"
      description: "dotnet-sdk image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.pullrequest.key=${KEY_ID} \
              /d:sonar.pullrequest.branch=${SOURCE_BRANCH} \
              /d:sonar.pullrequest.base=${TARGET_BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/csharp/github-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-dotnet-dotnet-6.0-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-6.0"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-6.0'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:6.0.407-alpine3.17"
      description: "dotnet-sdk image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.pullrequest.key=${KEY_ID} \
              /d:sonar.pullrequest.branch=${SOURCE_BRANCH} \
              /d:sonar.pullrequest.base=${TARGET_BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/csharp/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-dotnet-dotnet-3.1-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-3.1"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-3.1'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:3.1.423-alpine3.16"
      description: "dotnet-sdk image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.pullrequest.key=${KEY_ID} \
              /d:sonar.pullrequest.branch=${SOURCE_BRANCH} \
              /d:sonar.pullrequest.base=${TARGET_BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dotnet-publish
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            dotnet publish --configuration Release --output app
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - dotnet-publish
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/csharp/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-dotnet-dotnet-6.0-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-6.0"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-6.0'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:6.0.407-alpine3.17"
      description: "dotnet-sdk image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.pullrequest.key=${KEY_ID} \
              /d:sonar.pullrequest.branch=${SOURCE_BRANCH} \
              /d:sonar.pullrequest.base=${TARGET_BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dotnet-publish
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            dotnet publish --configuration Release --output app
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - dotnet-publish
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/csharp/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-dotnet-dotnet-3.1-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-3.1"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-3.1'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:3.1.423-alpine3.16"
      description: "dotnet-sdk image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-dotnet-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dotnet-publish
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - push
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            dotnet publish --configuration Release --output app
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - dotnet-publish
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-dotnet-dotnet-6.0-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-6.0"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-6.0'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:6.0.407-alpine3.17"
      description: "dotnet-sdk image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-dotnet-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dotnet-publish
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - push
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            dotnet publish --configuration Release --output app
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - dotnet-publish
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-dotnet-dotnet-3.1-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-3.1"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-3.1'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:3.1.423-alpine3.16"
      description: "dotnet-sdk image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-csharp
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dotnet-publish
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - push
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            dotnet publish --configuration Release --output app
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - dotnet-publish
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-dotnet-dotnet-6.0-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-6.0"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-6.0'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:6.0.407-alpine3.17"
      description: "dotnet-sdk image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-csharp
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dotnet-publish
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - push
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            dotnet publish --configuration Release --output app
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - dotnet-publish
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-dotnet-dotnet-3.1-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-3.1"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-3.1'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:3.1.423-alpine3.16"
      description: "dotnet-sdk image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-dotnet-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-dotnet-dotnet-6.0-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-6.0"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-6.0'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:6.0.407-alpine3.17"
      description: "dotnet-sdk image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-dotnet-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-dotnet-dotnet-3.1-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-3.1"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-3.1'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:3.1.423-alpine3.16"
      description: "dotnet-sdk image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-csharp
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-dotnet-dotnet-6.0-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-6.0"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-6.0'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:6.0.407-alpine3.17"
      description: "dotnet-sdk image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-csharp
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.branch.name=${BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            slnFilename=$(ls *.sln)
            nugetPackagesPath="/tmp/project-nupkgs/"
            dotnet pack ${slnFilename} --no-build --output ${nugetPackagesPath} "-p:PackageVersion=$(tasks.get-version.results.VERSION)"
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageSnapshots"
            else
                ARTIFACT_REPOSITORY_SOURCE="nugetStorageReleases"
            fi
            
            # Note: The api-key is only used as a placeholder. 
            # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/nuget/dotnet-exe?view=azure-devops#publish-packages
            dotnet nuget push ${nugetPackagesPath} --source ${ARTIFACT_REPOSITORY_SOURCE} --api-key key
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/csharp/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-dotnet-dotnet-3.1-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-3.1"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-3.1'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:3.1.423-alpine3.16"
      description: "dotnet-sdk image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.pullrequest.key=${KEY_ID} \
              /d:sonar.pullrequest.branch=${SOURCE_BRANCH} \
              /d:sonar.pullrequest.base=${TARGET_BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/csharp/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-dotnet-dotnet-6.0-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-6.0"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-6.0'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:6.0.407-alpine3.17"
      description: "dotnet-sdk image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.pullrequest.key=${KEY_ID} \
              /d:sonar.pullrequest.branch=${SOURCE_BRANCH} \
              /d:sonar.pullrequest.base=${TARGET_BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/csharp/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-dotnet-dotnet-3.1-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-3.1"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-3.1'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:3.1.423-alpine3.16"
      description: "dotnet-sdk image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.pullrequest.key=${KEY_ID} \
              /d:sonar.pullrequest.branch=${SOURCE_BRANCH} \
              /d:sonar.pullrequest.base=${TARGET_BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dotnet-publish
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            dotnet publish --configuration Release --output app
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - dotnet-publish
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/csharp/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-dotnet-dotnet-6.0-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/csharp-dotnet-dotnet-6.0"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'csharp-dotnet-dotnet-6.0'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: "mcr.microsoft.com/dotnet/sdk:6.0.407-alpine3.17"
      description: "dotnet-sdk image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-dotnet
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-dotnet
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
        - name: BASE_IMAGE
          value: 'epamedp/tekton-dotnet:6.0.2'
        - name: EXTRA_COMMANDS
          value: |
            slnFilename=$(ls *.sln)
            dotnet sonarscanner begin \
              /d:sonar.host.url=${SONAR_HOST_URL} \
              /d:sonar.qualitygate.wait=true \
              /d:sonar.login=${SONAR_TOKEN} \
              /k:${SONAR_PROJECT_KEY} \
              /n:${SONAR_PROJECT_NAME} \
              /d:sonar.pullrequest.key=${KEY_ID} \
              /d:sonar.pullrequest.branch=${SOURCE_BRANCH} \
              /d:sonar.pullrequest.base=${TARGET_BRANCH}
            dotnet build ${sln_filename}
            dotnet sonarscanner end /d:sonar.login=${SONAR_TOKEN}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dotnet-publish
      taskRef:
        kind: Task
        name: dotnet
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            set -x
            dotnet publish --configuration Release --output app
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - dotnet-publish
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/docker/kaniko/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-kaniko-docker-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CODEBASE_NAME
      default: 'docker-kaniko'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'ghcr.io/hadolint/hadolint:v2.10.0-alpine'
      description: "kaniko image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - dockerfile-lint
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/docker/kaniko/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-kaniko-docker-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CODEBASE_NAME
      default: 'docker-kaniko'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'ghcr.io/hadolint/hadolint:v2.10.0-alpine'
      description: "kaniko image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - dockerfile-lint
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/docker/kaniko/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-kaniko-docker-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CODEBASE_NAME
      default: 'docker-kaniko'
      description: "Project name"
      type: string
    - name: image
      default: 'ghcr.io/hadolint/hadolint:v2.10.0-alpine'
      description: "kaniko image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)

    # The fetch-target-branch Task will fetch the target branch during the code-review pipeline
    # because the fetch-repository Task fetches only user changes.
    - name: fetch-target-branch
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - fetch-repository
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git fetch origin $(params.targetBranch):refs/remotes/origin/$(params.targetBranch)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-target-branch
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/docker/kaniko/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-kaniko-docker-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'docker-kaniko'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - dockerfile-lint
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/docker/kaniko/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-kaniko-docker-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'docker-kaniko'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - dockerfile-lint
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/docker/kaniko/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-kaniko-docker-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:

    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/docker/kaniko/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-kaniko-docker-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'docker-kaniko'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - dockerfile-lint
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/docker/kaniko/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-kaniko-docker-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'docker-kaniko'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - dockerfile-lint
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/docker/kaniko/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-kaniko-docker-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:

    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
      workspaces:
        - name: output
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/go/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-go-beego-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-beego"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "beego-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/go/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-go-gin-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-gin"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "gin-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/go/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-go-operator-sdk-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-operator-sdk"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "operator-sdk-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/go/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-go-beego-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-beego"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "beego-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/go/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-go-gin-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-gin"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "gin-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/go/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-go-operator-sdk-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-operator-sdk"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "operator-sdk-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/go/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-go-beego-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-beego"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: "beego-go"
      description: "Project name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-refspec)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/go/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-go-gin-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-gin"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: "gin-go"
      description: "Project name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-refspec)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/go/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-go-operator-sdk-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-operator-sdk"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: "operator-sdk-go"
      description: "Project name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-refspec)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/go/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-go-beego-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-beego"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "beego-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/go/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-go-gin-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-gin"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "gin-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/go/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-go-operator-sdk-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-operator-sdk"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "operator-sdk-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/go/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-go-beego-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-beego"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "beego-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/go/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-go-gin-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-gin"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "gin-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/go/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-go-operator-sdk-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-operator-sdk"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "operator-sdk-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/go/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-go-beego-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-beego"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: "beego-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/go/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-go-gin-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-gin"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: "gin-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/go/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-go-operator-sdk-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-operator-sdk"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: "operator-sdk-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/go/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-go-beego-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-beego"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "beego-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/go/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-go-gin-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-gin"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "gin-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/go/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-go-operator-sdk-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-operator-sdk"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "operator-sdk-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/go/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-go-beego-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-beego"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "beego-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/go/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-go-gin-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-gin"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "gin-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/go/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-go-operator-sdk-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-operator-sdk"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "operator-sdk-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/go/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-go-beego-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-beego"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: "beego-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - build
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/go/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-go-gin-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-gin"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: "gin-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - build
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/go/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-go-operator-sdk-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-operator-sdk"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: "operator-sdk-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: image
      default: 'golang:1.22-bookworm'
      description: "go image version"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - build
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/groovy/gerrit-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-codenarc-codenarc-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/groovy-pipeline-codenarc-codenarc"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'groovy-pipeline'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: codenarc
      runAfter:
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            build -x test -x compileGroovy
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds

    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/groovy/gerrit-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-codenarc-codenarc-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/groovy-pipeline-codenarc-codenarc"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'groovy-pipeline'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: codenarc
      runAfter:
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            build -x test -x compileGroovy
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds

    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/groovy/gerrit-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-codenarc-codenarc-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/groovy-pipeline-codenarc-codenarc"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'groovy-pipeline'
      description: "Project name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)

    - name: build
      taskRef:
        kind: Task
        name: codenarc
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            build -x test -x compileGroovy
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-refspec) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            -Dsonar.qualitygate.wait=true \
            -x compileGroovy \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/groovy/github-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-codenarc-codenarc-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/groovy-pipeline-codenarc-codenarc"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'groovy-pipeline'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: codenarc
      runAfter:
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            build -x test -x compileGroovy
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds

    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/groovy/github-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-codenarc-codenarc-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/groovy-pipeline-codenarc-codenarc"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'groovy-pipeline'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: codenarc
      runAfter:
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            build -x test -x compileGroovy
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds

    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/groovy/github-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-codenarc-codenarc-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/groovy-pipeline-codenarc-codenarc"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'groovy-pipeline'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: build
      taskRef:
        kind: Task
        name: codenarc
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            build -x test -x compileGroovy
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            -x compileGroovy \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/groovy/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-codenarc-codenarc-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/groovy-pipeline-codenarc-codenarc"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'groovy-pipeline'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: codenarc
      runAfter:
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            build -x test -x compileGroovy
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds

    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/groovy/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-codenarc-codenarc-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/groovy-pipeline-codenarc-codenarc"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'groovy-pipeline'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: codenarc
      runAfter:
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            build -x test -x compileGroovy
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds

    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/groovy/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-codenarc-codenarc-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/groovy-pipeline-codenarc-codenarc"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'groovy-pipeline'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: build
      taskRef:
        kind: Task
        name: codenarc
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            build -x test -x compileGroovy
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/edp-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            -x compileGroovy \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/helm-pipelines/gerrit-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-helm-pipeline-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "."
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - gerrit-notify
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: release_name
          value: $(params.CODEBASE_NAME)
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-template
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/helm-pipelines/gerrit-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-helm-pipeline-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "."
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - gerrit-notify
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-helm-chart
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: release_name
          value: $(params.CODEBASE_NAME)
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-template
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/helm-pipelines/gerrit-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-helm-pipeline-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "."
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds

    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      runAfter:
        - gerrit-notify
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - helm-docs
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: release_name
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/helm-pipelines/github-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-helm-pipeline-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "."
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - fetch-repository
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: release_name
          value: $(params.CODEBASE_NAME)
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-template
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/helm-pipelines/github-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-helm-pipeline-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "."
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-helm-chart
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: release_name
          value: $(params.CODEBASE_NAME)
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-template
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/helm-pipelines/github-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-helm-pipeline-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: gitfullrepositoryname
      description: "Repository full name"
      type: string
    - name: gitsha
      description: "Commit sha"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "."
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - helm-docs
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: release_name
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/helm-pipelines/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-helm-pipeline-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "."
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - fetch-repository
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: release_name
          value: $(params.CODEBASE_NAME)
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-template
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/helm-pipelines/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-helm-pipeline-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "."
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-helm-chart
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: release_name
          value: $(params.CODEBASE_NAME)
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-template
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/helm-pipelines/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-helm-pipeline-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "."
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:

    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - helm-docs
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: release_name
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/helm/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-helm-helm-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: check-chart-name
      params:
        - name: codebase_name
          value: $(params.CODEBASE_NAME)
        - name: chart_dir
          value: $(params.CHART_DIR)
      runAfter:
        - fetch-repository
      taskRef:
        name: check-helm-chart-name
      workspaces:
        - name: source
          subPath: source
          workspace: shared-workspace

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-helm-default
      runAfter:
        - init-values
      params:
        - name: chart-dir
          value: $(params.CHART_DIR)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: release_name
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-push
      taskRef:
        kind: Task
        name: helm-push
      runAfter:
        - helm-template
      params:
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: chart-dir
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds

    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.VCS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/helm/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-helm-helm-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: check-chart-name
      params:
        - name: codebase_name
          value: $(params.CODEBASE_NAME)
        - name: chart_dir
          value: $(params.CHART_DIR)
      runAfter:
        - fetch-repository
      taskRef:
        name: check-helm-chart-name
      workspaces:
        - name: source
          subPath: source
          workspace: shared-workspace
    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-helm-chart
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: release_name
          value: $(params.CODEBASE_NAME)
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-push
      taskRef:
        kind: Task
        name: helm-push
      runAfter:
        - helm-template
      params:
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: chart-dir
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds

    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/helm/gerrit-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-helm-charts-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "charts"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-library-lint
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
        - name: TARGET_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-library-dependency-update
      runAfter:
        - helm-lint
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-template
      taskRef:
        kind: Task
        name: helm-library-template
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: release_name
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-push
      taskRef:
        kind: Task
        name: helm-push-lib
      runAfter:
        - helm-template
      params:
        - name: image-tag
          value: $(tasks.get-version.results.VERSION)
        - name: chart-dir
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/helm/gerrit-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-helm-charts-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "charts"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-library-lint
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
        - name: TARGET_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-library-dependency-update
      runAfter:
        - helm-lint
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-template
      taskRef:
        kind: Task
        name: helm-library-template
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: release_name
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-push
      taskRef:
        kind: Task
        name: helm-push-lib
      runAfter:
        - helm-template
      params:
        - name: chart-dir
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/helm/gerrit-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-helm-charts-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "charts"
      type: string
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
      type: string
    - name: targetBranch
      description: "Target branch of Merge Request"
      type: string
    - name: CHART_VERSION_INCREMENT
      description: "Check Chart version increment"
      default: 'true'
      type: string
  tasks:

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds

    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-library-docs
      runAfter:
        - gerrit-notify
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: fetch-target-branch
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - fetch-repository
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git fetch --unshallow
            git fetch origin $(params.targetBranch):refs/remotes/origin/$(params.targetBranch)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-library-lint
      runAfter:
        - fetch-target-branch
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
        - name: TARGET_BRANCH
          value: $(params.targetBranch)
        - name: CHART_VERSION_INCREMENT
          value: $(params.CHART_VERSION_INCREMENT)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-library-dependency-update
      runAfter:
        - helm-lint
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-template
      taskRef:
        kind: Task
        name: helm-library-template
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: release_name
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/helm/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-helm-helm-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: check-chart-name
      params:
        - name: codebase_name
          value: $(params.CODEBASE_NAME)
        - name: chart_dir
          value: $(params.CHART_DIR)
      runAfter:
        - fetch-repository
      taskRef:
        name: check-helm-chart-name
      workspaces:
        - name: source
          subPath: source
          workspace: shared-workspace

    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds

    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      runAfter:
        - gerrit-notify
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - helm-docs
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: release_name
          value: $(params.CODEBASE_NAME)
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/helm/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-helm-helm-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: check-chart-name
      params:
        - name: codebase_name
          value: $(params.CODEBASE_NAME)
        - name: chart_dir
          value: $(params.CHART_DIR)
      runAfter:
        - fetch-repository
      taskRef:
        name: check-helm-chart-name
      workspaces:
        - name: source
          subPath: source
          workspace: shared-workspace

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-helm-default
      runAfter:
        - init-values
      params:
        - name: chart-dir
          value: $(params.CHART_DIR)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: release_name
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-push
      taskRef:
        kind: Task
        name: helm-push
      runAfter:
        - helm-template
      params:
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: chart-dir
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds

    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.VCS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/helm/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-helm-helm-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: check-chart-name
      params:
        - name: codebase_name
          value: $(params.CODEBASE_NAME)
        - name: chart_dir
          value: $(params.CHART_DIR)
      runAfter:
        - fetch-repository
      taskRef:
        name: check-helm-chart-name
      workspaces:
        - name: source
          subPath: source
          workspace: shared-workspace

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-helm-chart
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: release_name
          value: $(params.CODEBASE_NAME)
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-push
      taskRef:
        kind: Task
        name: helm-push
      runAfter:
        - helm-template
      params:
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: chart-dir
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds

    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/helm/github-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-helm-charts-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "charts"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-library-lint
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
        - name: TARGET_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-library-dependency-update
      runAfter:
        - helm-lint
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-template
      taskRef:
        kind: Task
        name: helm-library-template
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: release_name
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-push
      taskRef:
        kind: Task
        name: helm-push-lib
      runAfter:
        - helm-template
      params:
        - name: image-tag
          value: $(tasks.get-version.results.VERSION)
        - name: chart-dir
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/helm/github-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-helm-charts-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "charts"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-library-lint
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
        - name: TARGET_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-library-dependency-update
      runAfter:
        - helm-lint
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-template
      taskRef:
        kind: Task
        name: helm-library-template
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: release_name
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-push
      taskRef:
        kind: Task
        name: helm-push-lib
      runAfter:
        - helm-template
      params:
        - name: chart-dir
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/helm/github-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-helm-charts-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: gitfullrepositoryname
      description: "Repository full name"
      type: string
    - name: gitsha
      description: "Commit sha"
      type: string
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "charts"
      type: string
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
      type: string
    - name: targetBranch
      description: "Target branch of Merge Request"
      type: string
    - name: CHART_VERSION_INCREMENT
      description: "Check Chart version increment"
      default: 'true'
      type: string
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-library-docs
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: fetch-target-branch
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - fetch-repository
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git fetch --unshallow
            git fetch origin $(params.targetBranch):refs/remotes/origin/$(params.targetBranch)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-library-lint
      runAfter:
        - fetch-target-branch
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
        - name: TARGET_BRANCH
          value: $(params.targetBranch)
        - name: CHART_VERSION_INCREMENT
          value: $(params.CHART_VERSION_INCREMENT)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-library-dependency-update
      runAfter:
        - helm-lint
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-template
      taskRef:
        kind: Task
        name: helm-library-template
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: release_name
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/helm/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-helm-helm-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: gitfullrepositoryname
      description: "Repository full name"
      type: string
    - name: gitsha
      description: "Commit sha"
      type: string
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: check-chart-name
      params:
        - name: codebase_name
          value: $(params.CODEBASE_NAME)
        - name: chart_dir
          value: $(params.CHART_DIR)
      runAfter:
        - fetch-repository
      taskRef:
        name: check-helm-chart-name
      workspaces:
        - name: source
          subPath: source
          workspace: shared-workspace

    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - helm-docs
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: release_name
          value: $(params.CODEBASE_NAME)
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/helm/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-helm-helm-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: check-chart-name
      params:
        - name: codebase_name
          value: $(params.CODEBASE_NAME)
        - name: chart_dir
          value: $(params.CHART_DIR)
      runAfter:
        - fetch-repository
      taskRef:
        name: check-helm-chart-name
      workspaces:
        - name: source
          subPath: source
          workspace: shared-workspace

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-helm-default
      runAfter:
        - init-values
      params:
        - name: chart-dir
          value: $(params.CHART_DIR)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: release_name
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-push
      taskRef:
        kind: Task
        name: helm-push
      runAfter:
        - helm-template
      params:
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: chart-dir
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds

    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.VCS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/helm/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-helm-helm-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: check-chart-name
      params:
        - name: codebase_name
          value: $(params.CODEBASE_NAME)
        - name: chart_dir
          value: $(params.CHART_DIR)
      runAfter:
        - fetch-repository
      taskRef:
        name: check-helm-chart-name
      workspaces:
        - name: source
          subPath: source
          workspace: shared-workspace

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-helm-chart
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: release_name
          value: $(params.CODEBASE_NAME)
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-push
      taskRef:
        kind: Task
        name: helm-push
      runAfter:
        - helm-template
      params:
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: chart-dir
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds

    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/helm/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-helm-charts-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "charts"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-library-lint
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
        - name: TARGET_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-library-dependency-update
      runAfter:
        - helm-lint
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-template
      taskRef:
        kind: Task
        name: helm-library-template
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: release_name
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-push
      taskRef:
        kind: Task
        name: helm-push-lib
      runAfter:
        - helm-template
      params:
        - name: chart-dir
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/helm/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-helm-charts-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "charts"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-library-lint
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
        - name: TARGET_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-library-dependency-update
      runAfter:
        - helm-lint
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-template
      taskRef:
        kind: Task
        name: helm-library-template
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: release_name
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-push
      taskRef:
        kind: Task
        name: helm-push-lib
      runAfter:
        - helm-template
      params:
        - name: chart-dir
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/helm/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-helm-charts-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "charts"
      type: string
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
      type: string
    - name: targetBranch
      description: "Target branch of Merge Request"
      type: string
    - name: CHART_VERSION_INCREMENT
      description: "Check Chart version increment"
      default: 'true'
      type: string
  tasks:

    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-library-docs
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: fetch-target-branch
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - fetch-repository
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git fetch --unshallow
            git fetch origin $(params.targetBranch):refs/remotes/origin/$(params.targetBranch)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-library-lint
      runAfter:
        - fetch-target-branch
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
        - name: TARGET_BRANCH
          value: $(params.targetBranch)
        - name: CHART_VERSION_INCREMENT
          value: $(params.CHART_VERSION_INCREMENT)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-library-dependency-update
      runAfter:
        - helm-lint
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-template
      taskRef:
        kind: Task
        name: helm-library-template
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: release_name
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/helm/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-helm-helm-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:

    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: check-chart-name
      params:
        - name: codebase_name
          value: $(params.CODEBASE_NAME)
        - name: chart_dir
          value: $(params.CHART_DIR)
      runAfter:
        - fetch-repository
      taskRef:
        name: check-helm-chart-name
      workspaces:
        - name: source
          subPath: source
          workspace: shared-workspace

    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - helm-docs
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: release_name
          value: $(params.CODEBASE_NAME)
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/infrastructure/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-terraform-aws-inf-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/terraform-terraform-aws"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: terraform_default_version
      type: string
      default: "1.4.5"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.

  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - get-version
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - terraform-check
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/infrastructure/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-terraform-aws-inf-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/terraform-terraform-aws"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: terraform_default_version
      type: string
      default: "1.4.5"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.

  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - get-version
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - terraform-check
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/infrastructure/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-terraform-aws-inf-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/terraform-terraform-aws"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: terraform_default_version
      type: string
      default: "1.4.5"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.

  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - init-values
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/infrastructure/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-terraform-aws-inf-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/terraform-terraform-aws"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: terraform_default_version
      type: string
      default: "1.4.5"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.

  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - get-version
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - terraform-check
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/infrastructure/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-terraform-aws-inf-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/terraform-terraform-aws"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: terraform_default_version
      type: string
      default: "1.4.5"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.

  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - get-version
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - terraform-check
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/infrastructure/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-terraform-aws-inf-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/terraform-terraform-aws"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
    - name: terraform_default_version
      type: string
      default: "1.4.5"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.

  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - init-values
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/infrastructure/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-terraform-aws-inf-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/terraform-terraform-aws"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: terraform_default_version
      type: string
      default: "1.4.5"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.

  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - get-version
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - terraform-check
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/infrastructure/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-terraform-aws-inf-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/terraform-terraform-aws"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: terraform_default_version
      type: string
      default: "1.4.5"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.

  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - get-version
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - terraform-check
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/infrastructure/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-terraform-aws-inf-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/terraform-terraform-aws"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: terraform_default_version
      type: string
      default: "1.4.5"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - init-values
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java11-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java17-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java8-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java11-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java17-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java8-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gerrit-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java11-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gerrit-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java17-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gerrit-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java8-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gerrit-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java11-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gerrit-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java17-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gerrit-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java8-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gerrit-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java11-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-refspec) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/java/gradle/gerrit-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java17-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-refspec) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/java/gradle/gerrit-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java8-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-refspec) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/java/gradle/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java11-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-refspec) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - build
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/java/gradle/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java17-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-refspec) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - build
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/java/gradle/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-gradle-java8-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-refspec) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - build
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/java/gradle/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java11-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java17-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java8-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java11-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java17-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java8-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/github-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java11-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/github-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java17-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/github-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java8-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/github-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java11-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/github-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java17-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/github-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java8-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/github-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java11-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/java/gradle/github-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java17-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/java/gradle/github-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java8-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/java/gradle/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java11-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - build
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/java/gradle/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java17-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - build
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/java/gradle/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-gradle-java8-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - build
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java11-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java17-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java8-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java11-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java17-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java8-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java11-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java17-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java8-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java11-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java17-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java8-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java11-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java17-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java8-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java11-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk11'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - build
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java17-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk17'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - build
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java8-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'gradle:7.5.1-jdk8'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'gradle:7.5.1-jdk11'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - build
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/java/maven/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java11-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java17-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java8-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java11-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java17-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java8-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gerrit-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java11-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gerrit-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java17-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gerrit-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java8-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gerrit-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java11-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gerrit-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java17-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gerrit-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java8-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gerrit-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java11-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-refspec)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/java/maven/gerrit-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java17-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-refspec)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/java/maven/gerrit-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java8-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-refspec)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/java/maven/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java11-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-refspec)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - get-maven-module
        - build
        - dockerfile-lint
      params:
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/java/maven/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java17-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-refspec)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - get-maven-module
        - build
        - dockerfile-lint
      params:
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/java/maven/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-maven-java8-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-refspec)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - get-maven-module
        - build
        - dockerfile-lint
      params:
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/java/maven/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java11-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java17-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java8-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java11-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java17-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java8-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/github-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java11-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/github-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java17-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/github-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java8-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/github-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java11-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/github-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java17-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/github-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java8-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/github-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java11-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/java/maven/github-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java17-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/java/maven/github-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java8-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/java/maven/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java11-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - get-maven-module
        - build
        - dockerfile-lint
      params:
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/java/maven/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java17-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - get-maven-module
        - build
        - dockerfile-lint
      params:
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/java/maven/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-maven-java8-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - get-maven-module
        - build
        - dockerfile-lint
      params:
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java11-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java17-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java8-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java11-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://gitlab.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java17-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://gitlab.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java8-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://gitlab.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java11-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java17-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java8-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java11-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java17-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java8-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
        - security
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java11-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java17-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java8-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java11-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: git-source-url
      default: "https://gitlab.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java11-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - get-maven-module
        - build
        - dockerfile-lint
      params:
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java17-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: git-source-url
      default: "https://gitlab.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - get-maven-module
        - build
        - dockerfile-lint
      params:
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java8-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: git-source-url
      default: "https://gitlab.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java8-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'maven:3.9.0-eclipse-temurin-8'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'maven:3.9.0-eclipse-temurin-11'
      description: "sonar image version"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - get-maven-module
        - build
        - dockerfile-lint
      params:
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/js/npm/antora/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-antora-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-antora"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'antora-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'antora/antora:3.1.4'
      description: "npm image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: PATH_CONTEXT
          value: "source"
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            export npm_config_userconfig=/var/configmap/.npmrc-ci
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            export NPM_CACHE_DIR=/workspace/source/cache
            npm ci
            npm run build:prod
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/antora/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-antora-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-antora"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'antora-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'antora/antora:3.1.4'
      description: "npm image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: PATH_CONTEXT
          value: "source"
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            export npm_config_userconfig=/var/configmap/.npmrc-ci
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            export NPM_CACHE_DIR=/workspace/source/cache
            npm ci
            npm run build:prod
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/antora/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-antora-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-antora"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'antora-npm-edp-version'
      description: "Project name"
      type: string
    - name: image
      default: 'antora/antora:3.1.4'
      description: "npm image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
      workspaces:
        - name: output
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds

    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: PATH_CONTEXT
          value: "source"
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            export npm_config_userconfig=/var/configmap/.npmrc-ci
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            export NPM_CACHE_DIR=/workspace/source/cache
            npm ci
            npm run build:prod
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - build
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/js/npm/antora/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-antora-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-antora"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'antora-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'antora/antora:3.1.4'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: PATH_CONTEXT
          value: "source"
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            export npm_config_userconfig=/var/configmap/.npmrc-ci
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            export NPM_CACHE_DIR=/workspace/source/cache
            npm ci
            npm run build:prod
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/antora/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-antora-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-antora"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'antora-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'antora/antora:3.1.4'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: PATH_CONTEXT
          value: "source"
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            export npm_config_userconfig=/var/configmap/.npmrc-ci
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            export NPM_CACHE_DIR=/workspace/source/cache
            npm ci
            npm run build:prod
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/antora/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-antora-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-antora"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'antora-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'antora/antora:3.1.4'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:

    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: PATH_CONTEXT
          value: "source"
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            export npm_config_userconfig=/var/configmap/.npmrc-ci
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            export NPM_CACHE_DIR=/workspace/source/cache
            npm ci
            npm run build:prod
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - build
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/js/npm/antora/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-antora-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-antora"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'antora-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'antora/antora:3.1.4'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: PATH_CONTEXT
          value: "source"
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            export npm_config_userconfig=/var/configmap/.npmrc-ci
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            export NPM_CACHE_DIR=/workspace/source/cache
            npm ci
            npm run build:prod
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/antora/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-antora-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-antora"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'antora-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'antora/antora:3.1.4'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: PATH_CONTEXT
          value: "source"
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            export npm_config_userconfig=/var/configmap/.npmrc-ci
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            export NPM_CACHE_DIR=/workspace/source/cache
            npm ci
            npm run build:prod
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/antora/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-antora-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-antora"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'antora-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'antora/antora:3.1.4'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:

    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: PATH_CONTEXT
          value: "source"
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            export npm_config_userconfig=/var/configmap/.npmrc-ci
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            export NPM_CACHE_DIR=/workspace/source/cache
            npm ci
            npm run build:prod
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - build
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-react-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-angular-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-vue-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-express-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-next-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-react-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-angular-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-vue-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-express-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-next-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-react-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-angular-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-vue-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-express-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-next-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-react-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-angular-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-vue-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-express-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-next-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-react-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-refspec)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-angular-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-refspec)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-vue-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-refspec)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-express-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-refspec)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-next-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-refspec)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-react-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-refspec)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-angular-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-refspec)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-vue-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-refspec)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-express-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-refspec)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/js/npm/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-npm-next-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-refspec)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/js/npm/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-react-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-angular-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-vue-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-express-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-next-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-react-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-angular-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-vue-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-express-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-next-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/github-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-react-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/github-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-angular-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/github-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-vue-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/github-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-express-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/github-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-next-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/github-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-react-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/github-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-angular-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/github-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-vue-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/github-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-express-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/github-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-next-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/github-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-react-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/js/npm/github-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-angular-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/js/npm/github-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-vue-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/js/npm/github-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-express-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/js/npm/github-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-next-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/js/npm/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-react-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/js/npm/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-angular-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/js/npm/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-vue-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/js/npm/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-express-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/js/npm/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-npm-next-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-react-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-angular-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-vue-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-express-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-next-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-react-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-angular-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-vue-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-express-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-next-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-react-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-angular-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-vue-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-express-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-next-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-react-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-angular-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-vue-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-express-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-next-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-react-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-angular-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-vue-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-express-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-next-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-react-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-angular-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-vue-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-express-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-next-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:18.20.3-alpine3.20'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/opa/gerrit-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-opa-opa-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/rego-opa-opa"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'rego-opa'
      description: "Project name"
      type: string
    - name: image
      default: 'openpolicyagent/opa:0.45.0-debug'
      description: "opa image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: test
      taskRef:
        name: opa
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            python "${JUNIT_SCRIPT}" "${OPA_RESULTS}" > testReport.xml
            cat testReport.xml
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - test
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/opa/gerrit-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-opa-opa-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/rego-opa-opa"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'rego-opa'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'openpolicyagent/opa:0.45.0-debug'
      description: "opa image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: test
      taskRef:
        name: opa
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            python "${JUNIT_SCRIPT}" "${OPA_RESULTS}" > testReport.xml
            cat testReport.xml
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - test
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/opa/gerrit-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-opa-opa-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/rego-opa-opa"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'groovy-pipeline'
      description: "Project name"
      type: string
    - name: image
      default: 'openpolicyagent/opa:0.45.0-debug'
      description: "opa image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)

    - name: test
      taskRef:
        kind: Task
        name: opa
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            python "${JUNIT_SCRIPT}" "${OPA_RESULTS}" > testReport.xml
            cat testReport.xml
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/opa/github-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-opa-opa-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/rego-opa-opa"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'rego-opa'
      description: "Project name"
      type: string
    - name: image
      default: 'openpolicyagent/opa:0.45.0-debug'
      description: "opa image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: test
      taskRef:
        name: opa
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            python "${JUNIT_SCRIPT}" "${OPA_RESULTS}" > testReport.xml
            cat testReport.xml
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - test
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/opa/github-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-opa-opa-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/rego-opa-opa"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'rego-opa'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'openpolicyagent/opa:0.45.0-debug'
      description: "opa image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: test
      taskRef:
        name: opa
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            python "${JUNIT_SCRIPT}" "${OPA_RESULTS}" > testReport.xml
            cat testReport.xml
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - test
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/opa/github-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-opa-opa-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/rego-opa-opa"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: image
      default: 'openpolicyagent/opa:0.45.0-debug'
      description: "opa image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:

    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: test
      taskRef:
        kind: Task
        name: opa
      runAfter:
        - fetch-repository
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            python "${JUNIT_SCRIPT}" "${OPA_RESULTS}" > testReport.xml
            cat testReport.xml
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/opa/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-opa-opa-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/rego-opa-opa"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'rego-opa'
      description: "Project name"
      type: string
    - name: image
      default: 'openpolicyagent/opa:0.45.0-debug'
      description: "opa image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: test
      taskRef:
        name: opa
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            python "${JUNIT_SCRIPT}" "${OPA_RESULTS}" > testReport.xml
            cat testReport.xml
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - test
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/opa/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-opa-opa-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/rego-opa-opa"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'rego-opa'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'openpolicyagent/opa:0.45.0-debug'
      description: "opa image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: test
      taskRef:
        name: opa
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            python "${JUNIT_SCRIPT}" "${OPA_RESULTS}" > testReport.xml
            cat testReport.xml
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - test
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/opa/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-opa-opa-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/rego-opa-opa"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: image
      default: 'openpolicyagent/opa:0.45.0-debug'
      description: "opa image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:

    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: test
      taskRef:
        kind: Task
        name: opa
      runAfter:
        - fetch-repository
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            python "${JUNIT_SCRIPT}" "${OPA_RESULTS}" > testReport.xml
            cat testReport.xml
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/python/fastapi/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-python-fastapi-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python-default
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel
            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: EXTRA_COMMANDS
          value: |
            pip3 install -r test-requirements.txt
            python setup.py sdist

            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')

            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi

            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"

            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/fastapi/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-python-flask-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python-default
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel
            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: EXTRA_COMMANDS
          value: |
            pip3 install -r test-requirements.txt
            python setup.py sdist

            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')

            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi

            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"

            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/fastapi/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-python-fastapi-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel

            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: EXTRA_COMMANDS
          value: |
            pip3 install -r test-requirements.txt
            python setup.py sdist

            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')

            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi

            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"

            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/fastapi/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-python-flask-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel

            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: EXTRA_COMMANDS
          value: |
            pip3 install -r test-requirements.txt
            python setup.py sdist

            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')

            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi

            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"

            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/fastapi/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-python-fastapi-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string

    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel

            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-refspec)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - sonar
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - sonar
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/python/fastapi/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-python-flask-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string

    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel

            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-refspec)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - sonar
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - sonar
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/python/fastapi/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-python-fastapi-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'python:3.8-alpine3.16'
      description: "python image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python-default
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel

            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: EXTRA_COMMANDS
          value: |
            pip3 install -r test-requirements.txt
            python setup.py sdist

            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')

            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi

            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"

            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/fastapi/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-python-flask-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'python:3.8-alpine3.16'
      description: "python image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python-default
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel

            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: EXTRA_COMMANDS
          value: |
            pip3 install -r test-requirements.txt
            python setup.py sdist

            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')

            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi

            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"

            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/fastapi/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-python-fastapi-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel

            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: EXTRA_COMMANDS
          value: |
            pip3 install -r test-requirements.txt
            python setup.py sdist

            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')

            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi

            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"

            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/fastapi/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-python-flask-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel

            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: EXTRA_COMMANDS
          value: |
            pip3 install -r test-requirements.txt
            python setup.py sdist

            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')

            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi

            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"

            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/fastapi/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-python-fastapi-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
      default: ""
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'python:3.8-alpine3.16'
      description: "python image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel

            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - sonar
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - sonar
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/python/fastapi/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-python-flask-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
      default: ""
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'python:3.8-alpine3.16'
      description: "python image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel

            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - sonar
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - sonar
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/python/fastapi/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-python-fastapi-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python-default
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel

            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: EXTRA_COMMANDS
          value: |
            pip3 install -r test-requirements.txt
            python setup.py sdist

            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')

            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi

            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"

            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/fastapi/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-python-flask-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python-default
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel

            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: EXTRA_COMMANDS
          value: |
            pip3 install -r test-requirements.txt
            python setup.py sdist

            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')

            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi

            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"

            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/fastapi/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-python-fastapi-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel

            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: EXTRA_COMMANDS
          value: |
            pip3 install -r test-requirements.txt
            python setup.py sdist

            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')

            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi

            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"

            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/fastapi/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-python-flask-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - get-version
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel

            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: EXTRA_COMMANDS
          value: |
            pip3 install -r test-requirements.txt
            python setup.py sdist

            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')

            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi

            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"

            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/fastapi/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-python-fastapi-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel

            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - sonar
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - sonar
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/python/fastapi/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-python-flask-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel

            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - sonar
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - sonar
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/python/gerrit-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-python-python-3.8-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'python:3.8-alpine3.16'
      description: "python image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python-default
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
    
            python setup.py clean build install --user
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: 'python:3.8-slim'
        - name: EXTRA_COMMANDS
          value: |
            pip install twine==4.0.1
            python setup.py sdist
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi
    
            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"
    
            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/gerrit-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-python-python-3.8-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'python:3.8-alpine3.16'
      description: "python image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
    
            python setup.py clean build install --user
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: 'python:3.8-slim'
        - name: EXTRA_COMMANDS
          value: |
            pip install twine==4.0.1
            python setup.py sdist
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi
    
            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"
    
            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/gerrit-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-python-python-3.8-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'python:3.8-alpine3.16'
      description: "python image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python-default
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
    
            python setup.py clean build install --user
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: 'python:3.8-slim'
        - name: EXTRA_COMMANDS
          value: |
            pip install twine==4.0.1
            python setup.py sdist
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi
    
            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"
    
            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/gerrit-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-python-python-3.8-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'python:3.8-alpine3.16'
      description: "python image version"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
    
            python setup.py clean build install --user
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: 'python:3.8-slim'
        - name: EXTRA_COMMANDS
          value: |
            pip install twine==4.0.1
            python setup.py sdist
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi
    
            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"
    
            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/gerrit-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-python-python-3.8-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: image
      default: 'python:3.8-alpine3.16'
      description: "python image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
    
            python setup.py clean build install --user
            pip3 install .
            [ -f run_service.py ] && python run_service.py &
            python setup.py pytest
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-refspec)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/python/gerrit-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-python-python-3.8-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: image
      default: 'python:3.8-alpine3.16'
      description: "python image version"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
    
            python setup.py clean build install --user
            pip3 install .
            [ -f run_service.py ] && python run_service.py &
            python setup.py pytest
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-refspec)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/python/github-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-python-python-3.8-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'python:3.8-alpine3.16'
      description: "python image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python-default
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
    
            python setup.py clean build install --user
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: 'python:3.8-slim'
        - name: EXTRA_COMMANDS
          value: |
            pip install twine==4.0.1
            python setup.py sdist
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi
    
            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"
    
            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/github-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-python-python-3.8-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'python:3.8-alpine3.16'
      description: "python image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
    
            python setup.py clean build install --user
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: 'python:3.8-slim'
        - name: EXTRA_COMMANDS
          value: |
            pip install twine==4.0.1
            python setup.py sdist
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi
    
            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"
    
            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/github-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-python-python-3.8-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'python:3.8-alpine3.16'
      description: "python image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python-default
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
    
            python setup.py clean build install --user
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: 'python:3.8-slim'
        - name: EXTRA_COMMANDS
          value: |
            pip install twine==4.0.1
            python setup.py sdist
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi
    
            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"
    
            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/github-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-python-python-3.8-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'python:3.8-alpine3.16'
      description: "python image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
    
            python setup.py clean build install --user
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: 'python:3.8-slim'
        - name: EXTRA_COMMANDS
          value: |
            pip install twine==4.0.1
            python setup.py sdist
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi
    
            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"
    
            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/github-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-python-python-3.8-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'python:3.8-alpine3.16'
      description: "python image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
    
            python setup.py clean build install --user
            pip3 install .
            [ -f run_service.py ] && python run_service.py &
            python setup.py pytest
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/python/github-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-python-python-3.8-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'python:3.8-alpine3.16'
      description: "python image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
    
            python setup.py clean build install --user
            pip3 install .
            [ -f run_service.py ] && python run_service.py &
            python setup.py pytest
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/python/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-python-python-3.8-app-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'python:3.8-alpine3.16'
      description: "python image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python-default
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
    
            python setup.py clean build install --user
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: 'python:3.8-slim'
        - name: EXTRA_COMMANDS
          value: |
            pip install twine==4.0.1
            python setup.py sdist
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi
    
            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"
    
            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-python-python-3.8-app-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'python:3.8-alpine3.16'
      description: "python image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
    
            python setup.py clean build install --user
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: 'python:3.8-slim'
        - name: EXTRA_COMMANDS
          value: |
            pip install twine==4.0.1
            python setup.py sdist
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi
    
            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"
    
            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: kaniko-cache-path
          value: "kaniko-cache"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CBIS_NAME
          value: $(tasks.init-values.results.RESULT_IMAGE_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-python-python-3.8-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'python:3.8-alpine3.16'
      description: "python image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python-default
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
    
            python setup.py clean build install --user
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: 'python:3.8-slim'
        - name: EXTRA_COMMANDS
          value: |
            pip install twine==4.0.1
            python setup.py sdist
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi
    
            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"
    
            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-python-python-3.8-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'python:3.8-alpine3.16'
      description: "python image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - update-build-number
      params:
        - name: reportDataProductName
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: reportDataEngagementName
          value: $(params.CODEBASEBRANCH_NAME)
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
    
            python setup.py clean build install --user
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: 'python:3.8-slim'
        - name: EXTRA_COMMANDS
          value: |
            pip install twine==4.0.1
            python setup.py sdist
    
            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi
    
            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"
    
            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/python/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-python-python-3.8-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'python:3.8-alpine3.16'
      description: "python image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
    
            python setup.py clean build install --user
            pip3 install .
            [ -f run_service.py ] && python run_service.py &
            python setup.py pytest
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/python/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-python-python-3.8-app-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'python:3.8-alpine3.16'
      description: "python image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
    
            python setup.py clean build install --user
            pip3 install .
            [ -f run_service.py ] && python run_service.py &
            python setup.py pytest
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/pipelines/terraform/gerrit-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-terraform-terraform-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/hcl-terraform-terraform"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: terraform_default_version
      type: string
      default: "1.4.5"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.

  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - get-version
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - terraform-check
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/terraform/gerrit-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-terraform-terraform-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/hcl-terraform-terraform"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: terraform_default_version
      type: string
      default: "1.4.5"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.

  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        # Use 'gerrit review' command https://gerrit-review.googlesource.com/Documentation/cmd-review.html
        - name: SSH_GERRIT_COMMAND
          value: review --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
        # we can trigger build pipeline without GerritPatchSet, so let's skip exit code if Patch doesn't exists
        - name: ERR_EXIT_CODE
          value: '0'
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - get-version
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - terraform-check
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/terraform/gerrit-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gerrit-terraform-terraform-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/hcl-terraform-terraform"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: terraform_default_version
      type: string
      default: "1.4.5"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.

  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: gerrit-notify
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: review --verified 0 --message 'Build Started $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.targetBranch)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - init-values
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gerrit-vote-success
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified +1 --message 'Build Successfull $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
  
    - name: gerrit-vote-failure
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gerrit-ssh-cmd
      params:
        - name: GERRIT_PORT
          value: ''
        - name: SSH_GERRIT_COMMAND
          value: "review --verified -1 --message 'Build Failed $(params.pipelineUrl)' $(params.changeNumber),$(params.patchsetNumber)"
      workspaces:
        - name: ssh-directory
          workspace: ssh-creds
---
# Source: edp-tekton/templates/pipelines/terraform/github-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-terraform-terraform-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/hcl-terraform-terraform"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: terraform_default_version
      type: string
      default: "1.4.5"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.

  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - get-version
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - terraform-check
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/terraform/github-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-terraform-terraform-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/hcl-terraform-terraform"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: terraform_default_version
      type: string
      default: "1.4.5"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.

  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - get-version
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - terraform-check
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/terraform/github-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: github-terraform-terraform-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/hcl-terraform-terraform"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: gitsha
      description: "commit sha"
      type: string
    - name: terraform_default_version
      type: string
      default: "1.4.5"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.

  tasks:
    - name: github-set-pending-status
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has started"
        - name: STATE
          value: "pending"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - github-set-pending-status
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - init-values
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: github-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build was successful"
        - name: STATE
          value: "success"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
  
    - name: github-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: github-set-status
      params:
        - name: REPO_FULL_NAME
          value: $(params.gitfullrepositoryname)
        - name: DESCRIPTION
          value: "Build has failed"
        - name: STATE
          value: "failure"
        - name: AUTH_TYPE
          value: Token
        - name: GITHUB_TOKEN_SECRET_NAME
          value: ci-github
        - name: GITHUB_TOKEN_SECRET_KEY
          value: token
        - name: SHA
          value: $(params.gitsha)
        - name: TARGET_URL
          value: $(params.pipelineUrl)
---
# Source: edp-tekton/templates/pipelines/terraform/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-terraform-terraform-lib-build-default
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/hcl-terraform-terraform"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: terraform_default_version
      type: string
      default: "1.4.5"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.

  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - get-version
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - terraform-check
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/terraform/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-terraform-terraform-lib-build-edp
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/hcl-terraform-terraform"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: terraform_default_version
      type: string
      default: "1.4.5"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.

  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - get-version
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - terraform-check
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [ "" ]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.pipelineUrl)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
---
# Source: edp-tekton/templates/pipelines/terraform/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-terraform-terraform-lib-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://tekton-edp-tekton-0.12.0.tgz./#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/hcl-terraform-terraform"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, ref…)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: terraform_default_version
      type: string
      default: "1.4.5"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - init-values
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "ci-pipeline"
        - name: "DESCRIPTION"
          value: "Managed by EDP. Run with Tekton"
---
# Source: edp-tekton/templates/resources/quicklinks/dashboard.yaml
apiVersion: v2.edp.epam.com/v1
kind: QuickLink
metadata:
  name: tekton
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: system
  url: "https://tekton-edp-tekton-0.12.0.tgz."
  visible: true
  icon: "PHN2ZyByb2xlPSJpbWciIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48dGl0bGU+VGVrdG9uPC90aXRsZT48cGF0aCBkPSJNMS44ODIzLjAwMDJhLjkyNC45MjQgMCAwIDAtLjg5MDYuNjc3N0E2LjQ2NDcgNi40NjQ3IDAgMCAwIC44MDQyIDMuMTMzYTYuNjE5NiA2LjYxOTYgMCAwIDAgLjc1NzggMi4zNjcyIDcuMjgzIDcuMjgzIDAgMCAwIC45MDYyIDEuMzA2NiA5Ljc2NDcgOS43NjQ3IDAgMCAwLS4xMjUuNzg1MiAxMC4xMjI1IDEwLjEyMjUgMCAwIDAtLjA3MjIgMS4zNTk0Yy4wMDMuMTg2Mi4wMDguMzc1LjAyOTMuNTY0NC4wNDI4LjU0MDUuNTM1MSAxLjE4MTYuODcxIDEuNTkzOGE3LjEzNTQgNy4xMzU0IDAgMCAwIDIuMDI1NSAxLjcxNjguOTA5OC45MDk4IDAgMCAwIC4wMzMyLjA4MmMuMDgyNy4xNzYzLjE4NjQuMzQyLjMxMDUuNDkyMmE1LjkyODEgNS45MjgxIDAgMCAwLS41MDU4IDEuNjczOCA4LjE2NDggOC4xNjQ4IDAgMCAwLS4xNzM5IDEuMzAwOCAyLjIxOCAyLjIxOCAwIDAgMC0uNDYyOS4yODMyIDIuNjU2OCAyLjY1NjggMCAwIDAtLjg0NTcgMS4yMzA1IDMuMjUyIDMuMjUyIDAgMCAwLS4xMDkzLjQxMDFsLS4yMjg2LS4wNjI1LS4wMjUzLjE2MDJjLS4xMTYuNzI5OC0uMDYzOSAxLjM2MTUuMjMyNCAyLjAwNThhMS40NDMyIDEuNDQzMiAwIDAgMC0uNjkzNC4yOTMgMS4yMzEzIDEuMjMxMyAwIDAgMC0uMzUzNS40NTljLS4xNDY2LjMyOTgtLjI5My43MTM2LS4yOTMgMS4wOCAwIC4yNzE5LjA4NS41NDM3LjI5ODkuNzIwOGEuNzExMi43MTEyIDAgMCAwIC40NDkyLjE2MmgyLjM2OTFjLjE0MDUuMzcyNi40MDk3LjcyMDUuODA2Ny44MjQzLjExMi4wMjc0LjIyNjQuMDQzOS4zNDE4LjA0NjkuMTIyLjAwNi4yNDAyLjAwNzguMzU5My4wMDc4LjMwODUuMDA2MS42MTc0LjAwMy45MjU4IDAgLjQ4MjUtLjAwNjEuOTY1Ny0uMDE1MSAxLjQ1MTItLjAyNzRhLjc2ODguNzY4OCAwIDAgMCAuNjc3Ny0uNDQzMy43NzI3Ljc3MjcgMCAwIDAgLjY4MTcuNDQzM2MuNDgyNC4wMTIyLjk2NDcuMDIxMyAxLjQ0NzIuMDI3NC4zMDg1IDAgLjYxNzQuMDAzLjkyNTggMGE3LjE0MyA3LjE0MyAwIDAgMCAuMzU5NC0uMDA3OCAxLjg1NiAxLjg1NiAwIDAgMCAuMzM5OC0uMDQ3Yy4zOTctLjEwMzguNjY3My0uNDQ4NS44MDQ3LS44MjQxaDIuMzkyNmEuNzA1OS43MDU5IDAgMCAwIC40NDczLS4xNjIxYy4yMTM3LS4xNzcxLjMwMDctLjQ0OS4zMDA3LS43MjA3LS4wMDMtLjM2NjUtLjE0NzItLjc1MDMtLjI5NjgtMS4wODAxLS4yMTA3LS40NjczLS42MTAzLS42ODc4LTEuMDY4NC0uNzUyLjI5NjItLjY0NDMuMzQ4NS0xLjI3Ni4yMzI0LTIuMDA1OGwtLjAyNTQtLjE2MDItLjIwNS4wNTY3Yy0uMDAyLS4wMDgtLjAwNTMtLjAxOTQtLjAwNi0uMDI5M2EuMzg5Ny4zODk3IDAgMCAwIC4wMjU1LS4wNTA4IDYuOTM2IDYuOTM2IDAgMCAxIC40NTEyLS44ODg3IDguNjE1MyA4LjYxNTMgMCAwIDEgLjc0MjEtMS4wNzQyIDUuNTU0OCA1LjU1NDggMCAwIDEgLjQ1OS0uNTA3OGMuMjkwMS0uMjgxLjY1NjEtLjUxNTUgMS4wNjg0LS41NDMuMjg5LS4wMTk5LjU3Ni4wNjQ4LjgwNjYuMjQwMi4xNzQxLjEzMTQuMjU5NC4yODEyLjM0MTguNDc2Ni4xMzc0LjMzMjkuMjIyNC42MTc0LjQ5NDIuODc3LjQ4MjQuNDU1IDEuMTk5My40NjQgMS43NzM0LjE5NTMuNDQ5LS4yMTA3LjgyODItLjU5NjMuOTQ3My0xLjA4OGExLjMyNiAxLjMyNiAwIDAgMCAuMDMxMi0uNDUxYy0uMDk0Ni0uOTE5My0uNjYwMy0xLjc1MjgtMS4zNTM1LTIuMzM2LS42MzIxLS41MzE0LTEuNDQ5NS0uOTItMi4yODMyLS45NDE0LS43ODQ4LS4wMjE0LTEuNTU5Mi4yMjEtMi4yNDAyLjU5OTYtMS4xNjA0LjY0NDMtMi4wODIyIDEuNjkxMi0yLjc3NTQgMi44NTE1YTcuODc2MyA3Ljg3NjMgMCAwIDAtLjA5MzgtLjUyNTQgNi4yMzEgNi4yMzEgMCAwIDAtLjIzNjMtMS4wMDM5IDQuNzg3NSA0Ljc4NzUgMCAwIDAtLjE3LS40NTUgMS44OTggMS44OTggMCAwIDAgLjI1LS4zMjgyIDQuMjAyMiA0LjIwMjIgMCAwIDAgLjIxNjktLjM5ODRsLjAzNy0uMDg0YTcuMTcwNCA3LjE3MDQgMCAwIDAgMi4wMjM1LTEuNzE0OGMuMzQ1MS0uNDIxNC44MjIzLTEuMDQ1OC44NzExLTEuNjAxNi4wMjE0LS4xODYzLjAyODItLjM3NzkuMDMxMy0uNTcwM2E5Ljk3MDQgOS45NzA0IDAgMCAwLS4wNzYyLTEuMzgyOCAxMS45NDk0IDExLjk0OTQgMCAwIDAtLjEyMy0uNzQ4IDcuMjg4IDcuMjg4IDAgMCAwIC45MDQyLTEuMzA4NyA2LjYwOTggNi42MDk4IDAgMCAwIC43NTc5LTIuMzY1MiA2LjUzNDQgNi41MzQ0IDAgMCAwLS4xODM2LTIuNDU1LjkxNjMuOTE2MyAwIDAgMC0uODg4Ny0uNjgxN2MtMS41NjM2IDAtMi45MTQuNjM4NC00LjE2NiAxLjQ2MjlhNy4zNTM4IDcuMzUzOCAwIDAgMC03LjY4MzYgMEM0Ljc5NTIuNjM4NiAzLjQ0NTggMCAxLjg4MjMgMHptLjAxNzYuOTJoLjA3NDJjLjg2NzMuNDc2MyAxLjY0MzggMS40NDQyIDIuMjE0OSAyLjQwNjJhMTAuNDcgMTAuNDcgMCAwIDAtLjMzOTkuNDYyOSA4LjAyNTcgOC4wMjU3IDAgMCAwLS45NzQ2IDIuMDQ2OGMtLjY5OTMtLjk0MDUtMS41ODc0LTIuNjY5Mi0uOTk4LTQuODk4NC4wMDkxLS4wMDMuMDE0Mi0uMDExNS4wMjM0LS4wMTc2em0xNS45MDgyIDBoLjA3MjNsLjAyMTQuMDIxNGMuNTg5NCAyLjIyOTMtLjI5ODcgMy45NTYtLjk5OCA0Ljg5NjVhNy45ODA1IDcuOTgwNSAwIDAgMC0xLjAzNzEtMi4xNDA2IDUuNTM2IDUuNTM2IDAgMCAwLS4yNzM1LS4zNzExYy41NzExLS45NjIgMS4zNDc2LTEuOTI5OSAyLjIxNDktMi40MDYzek0zLjE4NyAxLjA5OTdjLjc3MjYuMjA3NyAxLjQ5OTMuNTgyOCAyLjE4OTUgMS4wMTk1YTcuMTc0OSA3LjE3NDkgMCAwIDAtLjc5MS43MzgzYy0uMTMxNC0uMjE2OC0uMjc0My0uNDI3MS0uNDIzOS0uNjM0OGE3LjQ5MTUgNy40OTE1IDAgMCAwLS45NzQ2LTEuMTIzem0xMy40MDgyIDBhNy40OTE3IDcuNDkxNyAwIDAgMC0uOTc0NiAxLjEyM2MtLjE0OTYuMjA3Ny0uMjg5NS40MjE5LS40MjM4LjYzODdhNy4yMTQyIDcuMjE0MiAwIDAgMC0uNzkxLS43NDIyYy42ODctLjQzNjcgMS40MTY4LS44MTE5IDIuMTg5NC0xLjAxOTV6bS02Ljg4NjcuMTd2Mi41OTM3Yy0xLjM4NjQuMDMwNS0yLjc0ODQuNDE1My0zLjU4MiAxLjE1NDMtLjk2NS44NTItMS42MDkzIDIuMzI1OS0xLjUzOTEgMy4xMDE1LjA2MS42OTMyIDEuMTczMiAxLjE2NzggMi42NTQzIDEuNDEyMWExLjM0NzYgMS4zNDc2IDAgMCAwLS4xNTI0LjQyNzggMS45MzYzIDEuOTM2MyAwIDAgMCAuMDAyLjYzNjcgMTYuNDEgMTYuNDEgMCAwIDEtMS41MTM3LS4yNDQyIDE0Ljk4NDcgMTQuOTg0NyAwIDAgMS0yLjMyNDItLjY5NTMuOTQxNy45NDE3IDAgMCAxLS4wNjA1LS4yMjA3UzIuODgwMyA2LjU4NSA0LjQ2ODIgNC4yMDkyYzEuMjcwNC0xLjg5OTUgMy4yNDYxLTIuODgxNCA1LjI0MDMtMi45Mzk1em0uMzY1MiAwYzEuOTYwNS4wNTQ5IDMuOTA0IDEuMDA2IDUuMTgzNiAyLjg1MzQgMS42NTUxIDIuMzkxMSAxLjMzNiA1LjMxMDYgMS4zMzYgNS4zMTA2YS44MzE5LjgzMTkgMCAwIDEtLjA1MjguMjEyOWMtLjc1OC4yOTgtMS41MzkyLjUzMzctMi4zMzYuNzAzMS0uNDQ4OS4wOTQ3LS45NTI4LjE4LTEuNTExNi4yNDQxYTEuOTQ4MyAxLjk0ODMgMCAwIDAgLjAwMzktLjYzODYgMS4zNTE0IDEuMzUxNCAwIDAgMC0uMTU0My0uNDI3OGMxLjQ4MS0uMjQ0MyAyLjU5MzItLjcxMzkgMi42NTQzLTEuNDEwMS4wNzAyLS43NzU3LS41NzQxLTIuMjUxNS0xLjUzOTEtMy4xMDM1LS44MzY3LS43MzYtMi4xOTc2LTEuMTE5OS0zLjU4NC0xLjE1MDR6bS0uODUzNS43MTI4YS4yMTM3LjIxMzcgMCAwIDAtLjIxNjguMjE2OGMwIC4xOTMyLjIzNDUuMjg5LjM3MTEuMTUyNC4xMzY2LS4xMzY2LjAzODktLjM2OTItLjE1NDMtLjM2OTJ6bTEuMzQxOCAwYS4yMTc2LjIxNzYgMCAwIDAtLjIxNjguMjE2OGMwIC4xOTMyLjIzMjYuMjg5LjM2OTEuMTUyNC4xMzY2LS4xMzY2LjA0MDktLjM2OTItLjE1MjMtLjM2OTJ6bS0xLjM0MTguOTU1YS4yMTc2LjIxNzYgMCAwIDAtLjIxNjguMjE2OWMwIC4xOTMyLjIzNDUuMjkwOS4zNzExLjE1NDNzLjAzODktLjM3MTEtLjE1NDMtLjM3MTF6bTEuMzQxOCAwYS4yMTc2LjIxNzYgMCAwIDAtLjIxNjguMjE2OWMwIC4xOTMyLjIzMjYuMjkwOS4zNjkxLjE1NDMuMTM2Ni0uMTM2Ni4wNDA5LS4zNzExLS4xNTIzLS4zNzExem0tMy41MTE3IDMuNzU2Yy4zMzAzLjAwMjQuNjQxNC4xNTEuODUzNS40MDQyLjIyMjEuMjYxOC4zNDUxLjU5NDMuMzQzNy45Mzc1YS4yMTk2LjIxOTYgMCAwIDEtLjIyMDcuMjE4OC4yMTk2LjIxOTYgMCAwIDEtLjIyMDctLjIxODguOTg2NC45ODY0IDAgMCAwLS4yMzA0LS42NDg0LjcwOTYuNzA5NiAwIDAgMC0uNTI5My0uMjUzOS42NjM4LjY2MzggMCAwIDAtLjM3OS4xMTkxLjg0MjYuODQyNiAwIDAgMC0uMjg3LjM0NTcuMjE2Ni4yMTY2IDAgMCAxLS4yODkxLjEwMzZjLS4xMDg4LS4wNTE1LS4xNTctLjE4MDMtLjEwNTUtLjI4OTFhMS4zMzUzIDEuMzM1MyAwIDAgMSAuNDM3NS0uNTIzNCAxLjEwNDQgMS4xMDQ0IDAgMCAxIC42MjctLjE5NTR6bTUuNjg1NSAwYy4yMjM3IDAgLjQ0MS4wNjguNjI1LjE5NTMuMTg4NC4xMzMyLjMzOTcuMzE0NC40Mzc1LjUyMzRhLjIxODMuMjE4MyAwIDAgMS0uMTA1NC4yODkuMjE5OC4yMTk4IDAgMCAxLS4yOTEtLjEwMzUuODQyNy44NDI3IDAgMCAwLS4yODcyLS4zNDU3LjY2MzguNjYzOCAwIDAgMC0uMzc4OS0uMTE5MS43MDQ2LjcwNDYgMCAwIDAtLjUyOTMuMjU0Ljk4NjQuOTg2NCAwIDAgMC0uMjMwNC42NDgzLjIxOTYuMjE5NiAwIDAgMS0uMjIwNy4yMTQ5LjIxOTYuMjE5NiAwIDAgMS0uMjIwNy0uMjE0OSAxLjQyNyAxLjQyNyAwIDAgMSAuMzQ1Ny0uOTM3NSAxLjEyODIgMS4xMjgyIDAgMCAxIC44NTU0LS40MDQzek05Ljg4NjIgOC44OTI3aC4wMDk4Yy45NzQxLS4wMDkyIDIuMTYxMy40MzU4IDIuMjc3MyAxLjE1MDQuMTEzLjY4NC0uMjY0NCAxLjE0ODMtLjg0NzYgMS40MTQtLjg2NDMuMzIwNy0xLjE2ODQtLjA5NzYtMS4zMDI4LS4zNjMzLS4wNjQtLjEyODItLjA5MTQtLjE5NDItLjEyNS0uMTk3MmgtLjAwNzhjLS4wMjc0LjAxMjItLjA2MjYuMDcyMy0uMTMyOC4xOTE0LS4xMzc0LjI0MTItLjQyMS42MDI2LTEuMDE5NS40ODA0LS43MzYtLjIzODItMS4yNjQyLS43MzQ0LTEuMTMyOC0xLjUyNTMuMTE5LS43MTQ2IDEuMzA3LTEuMTU5NiAyLjI4MTItMS4xNTA0em0uMDA0LjMzMmMtLjU5MSAwLTEuMzA0OC4xNzI2LTEuMzc1LjUzOS0uMTE2MS42MDc4Ljc4NTUuOTAwNSAxLjM4MDguODk5LjU5NTItLjAwMTYgMS40ODctLjI5NDMgMS4zNzEtLjg5OS0uMDcwMi0uMzY2NC0uNzg2LS41MzktMS4zNzY5LS41Mzl6bS02LjM4MjkuOTEwMmExNC45NzMgMTQuOTczIDAgMCAwIDEuOTk2MS41NzIyIDE2LjM4NiAxNi4zODYgMCAwIDAgMS43MDcuMjY3Ni44NDI0Ljg0MjQgMCAwIDAgLjA4NC4xNTIzYy4yNjg4LjQ2MTIuNzI5Mi43NTE3IDEuMjQyMi45MjU4LS4yNzE4LjExMy0uNDgyNC4yOTE0LS41MzEyLjU3MjNhLjY1MDIuNjUwMiAwIDAgMCAuMDMzMi4zMzJjMCAuMDAzLjAwMzkuMDA4Ny4wMDM5LjAxMTdhOS40Njg1IDkuNDY4NSAwIDAgMS0xLjE4MTctLjMxNjRjLTEuMjEyMy0uNDE4My0yLjIyNDItMS4wODctMy4wMjczLTIuMDcwM2E1LjE5NzcgNS4xOTc3IDAgMCAxLS4zMjYyLS40NDcyem0xMi43NjM3LjAwMzljLS4wNzk0LjEwNjgtLjE2MTQuMjE3Ni0uMjUuMzE4My0uNDU1LjU0NjYtLjkzOTcgMS4wNTE2LTEuNTM1MiAxLjQzOTUtLjgyNDUuNTM3NC0xLjc1MzkuODcxOC0yLjc0MDIgMS4wNzAzYS42NDY3LjY0NjcgMCAwIDAgLjAzMzItLjM1NzRjLS4wNTE5LS4yNzE4LS4yNTU4LS40NDU3LS41MjE1LS41NTg2LjUxMy0uMTc0MS45NzE1LS40Njc4IDEuMjQwMi0uOTI1OGEyLjMwNjQgMi4zMDY0IDAgMCAwIC4wNzYyLS4xNTA0IDE2LjUxNzIgMTYuNTE3MiAwIDAgMCAxLjcwNy0uMjY3NiAxNS4xODcgMTUuMTg3IDAgMCAwIDEuOTkwMy0uNTY4M3ptLTYuMzQ3NyAyLjIyNjVjLjc1MTMuMDAyIDEuNDkwNi4xNDUyIDEuMzM4LjQ0MTQtLjA3MDMuMTM3NC0uMjU0Ni4yNDEyLS40ODA2LjMxNDUtLjI5My4wMzY2LS41OTEzLjA2MTctLjg5MDYuMDhhMTcuMDg3NSAxNy4wODc1IDAgMCAxLS44ODY3LS4wOGMtLjI0MTMtLjA3OTQtLjQzMjItLjE5NDEtLjQ5MDItLjM0MzgtLjEwMzktLjI3MzMuNjU4OS0uNDE0IDEuNDEwMS0uNDEyem05LjY1MjQuNTA5OGMuNDY3Mi4wMTIyLjk1MjguMTc2NiAxLjM5MjUuNDQ1My0uNDU1LjEzMTMtLjgyNjkuNTAxMi0xLjAyNTMuOTUzMWExLjgyNjggMS44MjY4IDAgMCAwLS4xMzA5LjQ0NTMgMS44OTkxIDEuODk5MSAwIDAgMC0uNzg1Mi0uMjIyNi4yNTE1LjI1MTUgMCAwIDAtLjAzNy0uMDc2MmMtLjI2NTctLjM2MDMtLjMwMjYtMS4wMzI3LjAwNTgtMS4zODA5YS43MjI5LjcyMjkgMCAwIDEgLjA3MDMtLjA2NjQgMS42NCAxLjY0IDAgMCAxIC4xMDM1LS4wOCAyLjYwMTUgMi42MDE1IDAgMCAxIC40MDYzLS4wMTc2em0tMS4xMjExLjE3YTEuNjU2MSAxLjY1NjEgMCAwIDAtLjEzMjguNzA3Yy4wMDQyLjI3MjUuMDcxLjUzOTcuMTk3Mi43ODEyYTIuMjQ2MiAyLjI0NjIgMCAwIDAtLjY4OTQuMjc1NC4xNjkyLjE2OTIgMCAwIDAtLjA1NDctLjAzNTJjLS4xNzEtLjA3MzItLjMxNzQtLjI0MDUtLjQxMjEtLjQwMjMtLjEwMzgtLjE4MDItLjIyOS0uNTIyNS0uMDk3Ny0uNzE0OSAwLS4wMDMuMDAyLS4wMDI4LjAwMi0uMDA1OC4xNDM1LS4wOTc3LjI4ODEtLjE5MDIuNDMxNi0uMjY5NmE0LjQwOTkgNC40MDk5IDAgMCAxIC43NTU5LS4zMzU5em0tMTEuOTk0Mi4yMDNjLjE4NjMuMDY3Mi4zNzIxLjEzMDYuNTY0NS4xODU2YTYuMDgwNCA2LjA4MDQgMCAwIDAgMy4yNDYuNzE2OCA1Ljk3NDUgNS45NzQ1IDAgMCAwIDEuNDQxNS0uMjcxNSA1Ljc2MDcgNS43NjA3IDAgMCAwIDEuMDU0Ny0uNDQ1MyA5LjM1OTcgOS4zNTk3IDAgMCAwIC41NjQ0LS4xODU2IDMuNzQzIDMuNzQzIDAgMCAxLTEuOTgyNCAxLjM3MTFjLjcxNzYtLjA5MTYgMS40NjI1LS4yNzYgMi4wNDg4LS42MjEuMzI2OC43OTQuNTEwOSAxLjg2ODguMzM5OSAzLjI5NDktLjA0MjcuMzQyLS4wOTYuNjY2MS0uMTYwMi45NzQ2LS43MzI5LS40MDkzLTEuNzQ1Mi0uMDgyNC0yLjUxMTcuMzU3NC0uMDk3Ny0xLjQxNC0uNDAzLTIuNDU1LS41MzEyLTIuODM5OS0uMTE2MS0uMzU0Mi0uNTM1OC0uMjgzNS0uNTQ1LjAzNzIuMDU4LjE1NTcuMDk1My4zNTk2LjEyOS41MjE0LjA1NS4yODQuMDk5OC41NzQzLjE0MjUuODYxNC4wNzAyLjQ3OTQuMTQ0Mi45ODYyLjE3NzcgMS40Njg3LjAwNjIuMTA2OS4wMTI2LjIxNzQuMDE1Ny4zMjQyYTUuNTE1OCA1LjUxNTggMCAwIDEtMS4zODI4LjAwNzhjLjAwMy0uMTA5OS4wMDc1LS4yMTgxLjAxMzYtLjMyOC4wMTUzLS4xOTU1LjA0LS4zOTU2LjA2NDUtLjU4OC4wMzY2LS4zMDIzLjA4MDMtLjYwMS4xMjMtLjkwMDQuMDQ1OS0uMzAyMy4wOTA0LS42MDcuMTQ4NS0uOTA2Mi4wMjEzLS4xMTMuMDUwNC0uMjY5MS4wODQtLjQwMDQuMDA2LS4zMjM3LS4xODExLS4zMjk1LS4yOTEtLjMyMDMtLjEwMzkuMDA5MS0uMTgwMy4wOTM1LS4yMzgzLjI2NzYtLjEzNDQuNDEyMi0uNDE0IDEuNDIxLS41MTE4IDIuNzYxNy0uODQ4OS0uNTY1LTEuNTM0NS0uNzQxNy0yLjUxMTctLjI5ODgtLjA2NzItLjMxNDYtLjEyMTMtLjY0ODktLjE2NC0xLS4xODMzLTEuNTQyMi4wNDYyLTIuNjcyLjQyMTgtMy40ODQ0LjU4MDMuNDAzMSAxLjMzMDIuNjMyNiAyLjA3MjMuNzU3OGEzLjczOTggMy43Mzk4IDAgMCAxLTEuODIyMy0xLjMxODR6bTE0Ljg5ODUuNDgyNWEuMzY3NC4zNjc0IDAgMCAxIC4yNTk3LjA5NzZjLjAwMyAwIC4wMDY3LjAwMjguMDA5OC4wMDU5LjQ4ODYuNDc2NC44NDAyIDEuMDc5OC45MDQzIDEuNjg3NS4wNzAzLjY5OTMtMS4wNjQyIDEuMjQ3My0xLjU3NDIuNzYxNy0uMjkwMS0uMjc0OC0uMjY4My0uODA2Ny0uNzMyNC0xLjI2MTdhLjE4MjIuMTgyMiAwIDAgMCAuMDE5NS0uMDgwMWMuMDIxNC0uNTkyNS40OTY0LTEuMjM4NCAxLjExMzMtMS4yMTF6bS00LjU5MTguMzE0NGExLjYwMiAxLjYwMiAwIDAgMCAuMTk3Mi41NTQ3IDEuNDgxIDEuNDgxIDAgMCAwIC40NTkuNTAzOSA1LjE0NjQgNS4xNDY0IDAgMCAwLS4xNDQ1LjEzMDljLS4xNTI3LjE0OTYtLjI5OS4zMTE2LS40Mzk1LjQ3NjVhLjI1OTMuMjU5MyAwIDAgMC0uMTA5My0uMDIxNWMtLjE3NzIuMDA5Mi0uMzU0LS4wNzI4LS40ODgzLS4xNzk2LS4xNDM2LS4xMTMtLjM1MTItLjM1NzctLjMzNi0uNTY4NGE3LjEyMiA3LjEyMiAwIDAgMSAuODYxNC0uODk2NXptLTEuMjAzMSAxLjM0OTZjLjA5ODQuMTg1MS4yMzUuMzQ3Ni40MDAzLjQ3NjYuMTYwNC4xMjc3LjM0OC4yMTUuNTQ4OS4yNTU4YTkuNTM1MyA5LjUzNTMgMCAwIDAtLjg0OTYgMS4zODA5IDIuMzU1OCAyLjM1NTggMCAwIDAtLjYwOTQtLjczNDQgMi4xMDYxIDIuMTA2MSAwIDAgMC0uMjI0Ni0uMTU0MyA5LjkyMDQgOS45MjA0IDAgMCAxIC43MzQ0LTEuMjI0NnpNMTQuMzkgMTcuMDEyYy41OTI1LjI3NDguOTY2NC45MDExIDEuMDQ4OCAxLjYwMzUtLjQ3OTQuMTQwNS0xLjAwNDQuMzkxNS0xLjQ0NzIuNjExMy4xNjUtLjYxMDUuMjg2NC0xLjIzMTYuMzYzMy0xLjg1OTNhNi4xMDcgNi4xMDcgMCAwIDAgLjAzNTEtLjM1NTV6bS05LjI2MTcuMDEzN2MuMDA5Mi4xMTYuMDIxLjIzMDcuMDMzMi4zNDM3LjA3NjkuNjI3OC4xOTgyIDEuMjUwOC4zNjMzIDEuODYxNC0uNDM2Ny0uMjE2OS0uOTQ4NS0uNDYyLTEuNDIxOS0uNjA1NS4wNzk0LS42OTYyLjQ0MjEtMS4zMTg3IDEuMDI1NC0xLjU5OTZ6bTEuODk2NSAxLjY2NmMuNTIwMi4wMjA2IDEuMDMyMy4yODcgMS40MTQuNjIxLjAyMTQgMS40NzIuMzMwOCAyLjg1NTMuNTI5MyAzLjEyNy4yMDE2LjI2ODguMDkzOC43NTQuMDkzOC43NTRzLTIuNjAyLjA2NzEtMi44NTU1IDBjLS4yNTM1LS4wNjcyLS41NTUtLjgxNDUtLjEzNjctMS4yNDgxLjE5NTQtLjIwMTUuNDc1My0uMjUxLjcyMjctLjI0OC41MDcuMTA5OS44MzY2LjQyMzUgMS4xODE2Ljg2MzItLjA3MzMtLjc1NDMtLjQ5NjUtLjk1MTUtLjc5ODgtMS4xMzQ3LS4wOTc3LS4wNTgtLjEzNTYtLjA4NTktLjE4NzUtLjE4MzZhMTAuODM4NyAxMC44Mzg3IDAgMCAxLS44ODI4LTIuMjg1MmMuMjkyLS4yMDI3LjYwNzctLjI3OC45MTk5LS4yNjU2em01LjQ2ODcgMGMuMzExOS0uMDEyNC42MjguMDYzLjkyLjI2NTZhMTEuMDM1IDExLjAzNSAwIDAgMS0uODc5IDIuMjg1MmMtLjA1NS4wOTc3LS4wOTI4LjEyNTYtLjE4NzQuMTgzNi0uMzAyNC4xODMyLS43MjU2LjM4MDQtLjc5ODkgMS4xMzQ3LjM0NTEtLjQzOTcuNjc0Ny0uNzUzMyAxLjE4MTctLjg2MzIuMjQ3My0uMDAzLjUzMDIuMDQ2NS43MjI2LjI0OC40MTg0LjQzMzYuMTE2OCAxLjE4MDktLjEzNjcgMS4yNDgtLjI1MzUuMDY3Mi0yLjg1NTUgMC0yLjg1NTUgMHMtLjEwNTgtLjQ4NTEuMDk1Ny0uNzUzOWMuMTk4Ni0uMjcxNy41MS0xLjY1NS41MzEzLTMuMTI3LjM3OC0uMzM0Ljg4NjUtLjYwMDQgMS40MDYyLS42MjF6bS04LjY2MDEuMzg4N2MuNDY0Mi4xMjIxIDEuMjMxNi40NzcgMS45MDA0LjgyOC4xMDY5LjMxNDYuMjI2LjYyMTYuMzU3NC45MjQuMDQ1LjEwMjUuMDkyLjIwNTYuMTQwNi4zMDY2YTEuNDEzMSAxLjQxMzEgMCAwIDAtLjYyMS4zNjkxIDEuMzgzNSAxLjM4MzUgMCAwIDAtLjM3OS45MDYzSDIuODI5NmMtLjI0MTMtLjIwMTYuMDI3OS0yLjAzIDIuMzk0NS0uOTU1MS0uNTIyMi0uNDE1My0xLjQxMi0uOTcxMi0xLjM5MDYtMi4zNzl6bTExLjg0OTYgMGMuMDIxNCAxLjQwNzctLjg2NzYgMS45NjM2LTEuMzg2NyAyLjM3ODkgMi4zNjM2LTEuMDc1IDIuNjM0OS43NTM1IDIuMzkwNi45NTVoLTIuNDQ1M2ExLjMyNCAxLjMyNCAwIDAgMC0xLjAxNzYtMS4yNDYgOS4zNjIxIDkuMzYyMSAwIDAgMCAuNDc2Ni0xLjIxNDljLjY5MDEtLjM2OTUgMS41MDMtLjc0NzggMS45ODI0LS44NzN6bS01LjE4NTYuNDEyYTkuNzU3NCA5Ljc1NzQgMCAwIDEtLjE3OTYgMS43Mzg0Yy0uMDM5OC4yMDE1LS4xNDA0LjY4OS0uMjQ0Mi44NjkxYTEuNDQzOSAxLjQ0MzkgMCAwIDAtLjA3ODEuMTI4OWMtLjE0ODcuMDAyMy0uMjY5Mi4wMDEzLS40Mi4wMDJhMS42NzUxIDEuNjc1MSAwIDAgMC0uMDk1Ni0uMTU4MiAxLjg0OTIgMS44NDkyIDAgMCAxLS4wOTc3LS4yNzU0IDcuMjMwNSA3LjIzMDUgMCAwIDEtLjE3NzctLjc5MyAxMC4yMiAxMC4yMiAwIDAgMS0uMTM4Ny0xLjUgNC44OTAzIDQuODkwMyAwIDAgMCAxLjQzMTYtLjAxMTdaIi8+PC9zdmc+"
---
# Source: edp-tekton/templates/tasks/autotest-cd-pipeline/init-autotests.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: init-autotest
spec:
  workspaces:
    - name: source
      description: The workspace consisting of csharp project.
  params:
    - name: stage-name
      type: string
    - name: cd-pipeline-name
      type: string
    - name: AUTOTEST_PIPELINES
      default: 'autotes-pipeline'
    - name: codebase_tags
      default: 'codebase_tags'
    - name: parent-pipeline-name
      default: ''
  volumes:
    - name: autotests-workspace-template
      configMap:
        name: autotests-workspace-template
  results:
    - name: AUTOTEST_PIPELINES
      type: string
    - name: codebase_tags
      type: string
  steps:
    - name: init-autotest
      image: epamedp/tekton-autotest:0.1.3
      workingDir: $(workspaces.source.path)
      volumeMounts:
        - name: autotests-workspace-template
          mountPath: "/var/configmap"
      env:
        - name: CODEBASE_TAGS
          value: "$(params.codebase_tags)"
        - name: AUTOTEST_PIPELINES
          value: "$(params.AUTOTEST_PIPELINES)"
        - name: STAGE_NAME
          value: $(params.stage-name)
        - name: CD_PIPELINE_NAME
          value: $(params.cd-pipeline-name)
        - name: PARENT_PIPELINE_NAME
          value: $(params.parent-pipeline-name)

      script: |
        #!/usr/bin/env python

        import subprocess
        import json
        import os
        import re

        autotestsList = []
        autotestBuildTool = []
        gitAutotesUrl = []
        autotestsBranch = []
        pipelines = ""
        applications = []
        tags = []
        codebases = ""
        autotestFramework =[]
        gitSecret = {}

        frameworks = {
          "gradle-java8": "gradle:7.5.1-jdk8",
          "gradle-java11": "gradle:7.5.1-jdk11",
          "gradle-java17": "gradle:7.5.1-jdk17",
          "maven-java8": "maven:3.9.0-eclipse-temurin-8",
          "maven-java11": "maven:3.9.0-eclipse-temurin-11",
          "maven-java17": "maven:3.9.0-eclipse-temurin-17"
        }
        cdPipelineName = os.getenv('CD_PIPELINE_NAME')
        stage = os.getenv('STAGE_NAME')
        parentPipelineName = os.getenv('PARENT_PIPELINE_NAME')
        codebaseFileTags = os.getenv('CODEBASE_TAGS')

        autotests = json.loads(subprocess.check_output(["kubectl", "get", "stages.v2.edp.epam.com", cdPipelineName + "-" + stage, "-o=jsonpath='{.spec}'"]).decode("utf-8").strip("'"))

        for element in autotests["qualityGates"]:
            if element["qualityGateType"] == "autotests":
              autotestGitServer = subprocess.check_output(["kubectl", "get", "codebase", element["autotestName"], "-o=jsonpath='{.spec.gitServer}'"]).decode("utf-8").strip("'")
              gitserver = json.loads(subprocess.check_output(["kubectl", "get", "gitserver", autotestGitServer , "-o=jsonpath='{.spec}'"]).decode("utf-8").strip("'"))
              autotestsList.append(element["autotestName"])
              autotestsBranch.append(element["branchName"])
              autotest = json.loads(subprocess.check_output(["kubectl", "get", "codebase", element["autotestName"], "-o=jsonpath='{.spec}'"]).decode("utf-8").strip("'"))
              gitAutotesUrl.append("ssh://" + gitserver['gitUser'] + "@" + gitserver['gitHost'] + ":" + str(gitserver['sshPort']) + autotest['gitUrlPath'])
              autotestBuildTool.append(autotest["buildTool"])
              autotestFramework.append(autotest["framework"])

              gitSecret[element["autotestName"]] = gitserver['nameSshKeySecret']

        for count, element in enumerate(autotestsList):
            print("[TEKTON][DEBUG]: Run autotest - autotests-" + autotestBuildTool[count])
            print("[TEKTON][DEBUG]: Autotest URL - " + gitAutotesUrl[count])
            print("[TEKTON][DEBUG]: Autotest branch - " + autotestsBranch[count])
            command = "tkn pipeline start autotests-" + autotestBuildTool[count] + " \
            --use-param-defaults \
            -p git-source-url=" + gitAutotesUrl[count] + " \
            -p git-source-revision=" + autotestsBranch[count] + " \
            -p stage-name=" + stage +" \
            -p base-image=" + frameworks[autotestBuildTool[count] + "-" + autotestFramework[count]] + " \
            --labels app.edp.epam.com/pipeline=" + cdPipelineName + " \
            --labels app.edp.epam.com/stage=" + stage + " \
            --labels app.edp.epam.com/codebase=" + autotestsList[count] + " \
            --labels app.edp.epam.com/branch=" + autotestsBranch[count] + " \
            --labels app.edp.epam.com/parentPipelineRun=" + parentPipelineName + " \
            --workspace name=ssh-creds,secret=" + gitSecret[autotestsList[count]] + " \
            --workspace name=shared-workspace,volumeClaimTemplateFile=/var/configmap/volumeclaimtemplate.yaml"

            result = subprocess.run(command, shell=True, capture_output=True, text=True)
            output = re.search("autotests(-[A-Za-z0-9]*)* ", result.stdout)
            pipelines += output.group() + " "

        autotests_pipelines_file = os.getenv("AUTOTEST_PIPELINES")
        with open(autotests_pipelines_file, "w") as outfile:
            outfile.write(pipelines)

        try:
            listApplications = json.loads(subprocess.check_output(["kubectl", "get", "cdpipeline", cdPipelineName , "-o=jsonpath='{.spec.applicationsToPromote}'"]).decode("utf-8").strip("'"))
            kindApplications = subprocess.check_output(["kubectl", "get", "applications"])

            for element in listApplications:
                output = re.search(cdPipelineName + "-" + stage + "-" + element, str(kindApplications))
                applications.append(output.group())

            print("[TEKTON][DEBUG]: Images to promote:")
            for element in applications:
                print(element)

            for count, element in enumerate(applications):
                temp = subprocess.check_output(["kubectl", "get", "application", element.strip(" ") , "-o=jsonpath='{.spec.source.helm.parameters[0].value}'"]).decode("utf-8").strip("'")
                codebases += listApplications[count] + "=" + temp + " "

            with open(codebaseFileTags, "w") as outfile:
                outfile.write(codebases)

            with open("/tekton/results/" + codebaseFileTags, "w") as outfile:
                outfile.write(codebases)
        except:
            with open("/tekton/results/" + codebaseFileTags, "w") as outfile:
                outfile.write("not-set")
            print("[TEKTON][DEBUG]: No images to promote.")
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/autotest-cd-pipeline/run-autotests-java.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: run-autotests-maven
  labels:
    app.kubernetes.io/based-on: "0.2"
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Autootest Tools
    tekton.dev/tags: autotest-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  workspaces:
    - name: source
      description: A workspace that contains the repository.
  params:
    - name: stage-name
      type: string
    - name: base-image
      type: string
  steps:
    - name: run-autotest
      image: "$(params.base-image)"
      workingDir: $(workspaces.source.path)
      env:
        - name: STAGE_NAME
          value: $(params.stage-name)
      script: |
        #!/bin/bash

        set -exo pipefail
        $(sed -n 's/.*"'$STAGE_NAME'": "\(.*\)",/\1/p' run.json | awk -F '"' '{print $1}')
---
# Source: edp-tekton/templates/tasks/autotest-cd-pipeline/run-autotests-java.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: run-autotests-gradle
  labels:
    app.kubernetes.io/based-on: "0.2"
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Autootest Tools
    tekton.dev/tags: autotest-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  workspaces:
    - name: source
      description: A workspace that contains the repository.
  params:
    - name: stage-name
      type: string
    - name: base-image
      type: string
  steps:
    - name: run-autotest
      image: "$(params.base-image)"
      workingDir: $(workspaces.source.path)
      env:
        - name: STAGE_NAME
          value: $(params.stage-name)
      script: |
        #!/bin/bash

        set -exo pipefail
        $(sed -n 's/.*"'$STAGE_NAME'": "\(.*\)",/\1/p' run.json | awk -F '"' '{print $1}')
---
# Source: edp-tekton/templates/tasks/autotest-cd-pipeline/wait-autotest.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: wait-for-autotests
spec:
  workspaces:
    - name: source
      description: The workspace consisting of csharp project.
  params:
    - name: AUTOTEST_PIPELINES
      default: 'autotes-pipeline'
  steps:
    - name: wait-for
      image: epamedp/tekton-autotest:0.1.3
      workingDir: $(workspaces.source.path)
      env:
        - name: AUTOTEST_PIPELINES
          value: "$(params.AUTOTEST_PIPELINES)"
      script: |
        #!/usr/bin/env python

        import subprocess
        import json
        import os
        import time

        pipelines = os.getenv('AUTOTEST_PIPELINES')
        output = ""
        pipelines_name = []

        with open(pipelines, 'r') as f:
            output = f.read()

        pipelines_name = output.split()

        while pipelines_name:
            value = pipelines_name[0]
            result = subprocess.check_output(["kubectl", "get", "pipelinerun", value, "-o=jsonpath='{.status.conditions[].reason}'"]).decode("utf-8").strip("'")
            if result.strip() == 'Succeeded':
                pipelines_name.pop(0)
            if result.strip() == 'Failed':
                print("[DEBUG]: Autotest failed.")
                exit(1)
            else:
                continue

        print("[TEKTON][DEBUG]: All autotests finished.")
---
# Source: edp-tekton/templates/tasks/autotests/TestsMavenAutotest.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: run-tests-for-autotests
spec:
  description: >-
    This Task can be used to run tests for autotests.

  workspaces:
    - name: source
      description: The workspace consisting of maven project.
  params:
    - name: TEST_TYPE
      description: "Test type command in file run.json"
      default: "codereview"
    - name: ci-nexus
      type: string
      description: name of the secret for the Nexus integration
      default: ci-nexus
    - name: BASE_IMAGE
      description: "The base image for the task"
  results:
    - name: COMMAND
      type: string
  volumes:
    - name: settings-maven
      configMap:
        name: custom-maven-settings
  steps:
    - name: check-run-json-file
      image: "python:3.9.14-alpine3.16"
      workingDir: $(workspaces.source.path)
      script: |
        set -ex

        if [ -f "run.json" ]; then
            echo "[TEKTON][INFO] run.json file exists in the project."
        else
            echo "[TEKTON][ERROR] There is no run.json file in the project. Can't define command to run autotests."
            exit 1
        fi

    - name: get-command
      image: "python:3.10.1-alpine3.15"
      workingDir: $(workspaces.source.path)
      env:
        - name: RESULT_COMMAND_FILE_PATH
          value: $(results.COMMAND.path)
        - name: TEST_TYPE
          value: $(params.TEST_TYPE)
      script: |
        #!/usr/bin/env python

        import os
        import json
        import sys

        type_test = os.getenv("TEST_TYPE")
        result_command_file_path = os.getenv("RESULT_COMMAND_FILE_PATH")

        print(f"[TEKTON] '{type_test}' type was chosen")

        with open('run.json') as json_file:
          data = json.load(json_file)

          try:
              command=data[type_test]
          except KeyError:
              sys.exit(f"[TEKTON] Haven't found '{type_test}' command in file run.json. It's mandatory to be specified, please check")

          print(f"[TEKTON] The command was received: {command}")
          with open(result_command_file_path, "w") as outfile:
              outfile.write(command)

    - name: run-tests
      image: $(params.BASE_IMAGE)
      volumeMounts:
        - name: settings-maven
          mountPath: /var/configmap
      workingDir: $(workspaces.source.path)
      env:
        - name: RESULT_COMMAND_FILE_PATH
          value: $(results.COMMAND.path)
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
      script: |
        $(cat ${RESULT_COMMAND_FILE_PATH}) \
        -B \
        -Dartifactory.baseUrl=${NEXUS_HOST_URL} \
        -Dartifactory.releasePath=edp-maven-releases \
        -Dartifactory.snapshotsPath=edp-maven-snapshots \
        -Dartifactory.groupPath=edp-maven-group \
        --settings \
        /var/configmap/settings.xml
---
# Source: edp-tekton/templates/tasks/cd/deploy-applicationset-cli.yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: deploy-applicationset-cli
spec:
  description: |
    This task is used to deploy Codebases across specific Stage using ApplicationSet object.

  params:
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: {"codebase1": {"imageTag": "version1", "customValues": true}, "codebase2": {"imageTag": "version2", "customValues": true}}. For example: {"demo": {"imageTag": "main-20240103-141431", "customValues": true}, "myapp": {"imageTag": "0.1.0-SNAPSHOT.1", "customValues": true}}
      type: string
    - name: PIPELINE
      type: string
      description: |
        EDP kind:CDPipeline name used for deployment. For example: mypipe, myfeature
    - name: STAGE
      description: |
        EDP kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
      type: string

  steps:
    - name: wait-for-deploy
      image: epamedp/tekton-cd-pipeline:0.1.2
      env:
        - name: ARGOCD_URL
          valueFrom:
            secretKeyRef:
              name: ci-argocd
              key: url
        - name: ARGOCD_AUTH_TOKEN
          valueFrom:
            secretKeyRef:
              name: ci-argocd
              key: token
      script: |
        set -ex

        export ARGOCD_OPTS="--core=false --grpc-web"
        # the address of the Argo CD server without https:// prefix
        export ARGOCD_SERVER=${ARGOCD_URL#*//}

        pipeline=$(params.PIPELINE)
        stage=$(params.STAGE)
        # quotes are important here
        new_tags='$(params.APPLICATIONS_PAYLOAD)'

        selector="app.edp.epam.com/stage=$(params.STAGE),app.edp.epam.com/pipeline=$(params.PIPELINE)"

        patch=$(kubectl get applicationset $pipeline -o json | jq --argjson updates "$new_tags" --arg stage $stage '
          .spec.generators[0].list.elements |= map(
            if (.stage == $stage) and (.codebase | IN($updates | keys[])) then
              .imageTag = $updates[.codebase].imageTag
              # Update customValues field if customValues is true in payload
              | .customValues = if ($updates[.codebase].customValues == true) then true elif ($updates[.codebase].customValues == false) then false else .customValues end
            else
              .
            end
          )
        ')

        kubectl patch applicationset $pipeline --type=merge -p "$patch"

        argocd app list -l $selector

        argocd app sync -l $selector --prune --timeout 300
        # TODO: we build our custom argocd-cli that has fixed issue with argocd app wait
        argocd app wait -l $selector --health --sync
---
# Source: edp-tekton/templates/tasks/cdxgen.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: cdxgen
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/displayName: Dep-Analysis
    tekton.dev/platforms: linux/amd64
spec:
  params:
    - default: ''
      description: That is the name of the project that will be updated/created on the dependency track side
      name: PROJECT_NAME
      type: string
    - name: ci-dependency-track
      type: string
      description: Name of the secret holding the ci-dependency-track api token
      default: ci-dependency-track
  steps:
    - env:
        - name: API_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-dependency-track)
              key: token
        - name: DEPTRACK_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-dependency-track)
              key: url
        - name: PROJECT_NAME
          value: $(params.PROJECT_NAME)
      image: >-
        ghcr.io/cyclonedx/cdxgen:v9.6.0@sha256:ea01324872d2c21b024264a2224d761ab63851b9cc4722903b5e74be56ca6fa6
      name: cdxgen
      computeResources: {}
      script: >
        #!/usr/bin/env sh

        set -e

        set +x

        /opt/cdxgen/bin/cdxgen.js --api-key=$API_TOKEN --server-url=$DEPTRACK_URL --project-name=$PROJECT_NAME
      workingDir: $(workspaces.source.path)
  workspaces:
    - name: source
---
# Source: edp-tekton/templates/tasks/check-helm-chart-name.yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: check-helm-chart-name
spec:
  params:
    - name: codebase_name
      type: string
    - name: chart_dir
      description: The directory in source that contains the helm chart
      default: "."
  steps:
    - name: check-helm-chart-name
      env:
        - name: CODEBASE_NAME
          value: $(params.codebase_name)
        - name: CHART_DIR
          value: $(params.chart_dir)
      image: alpine:3.18.6
      script: |
        #!/bin/sh
        # Extract the chart name from the Chart.yaml
        CHART_NAME=$(awk '/^name:/ {print $2}' ${CHART_DIR}/Chart.yaml)

        # Compare with CODEBASE_NAME
        if [ "$CHART_NAME" == "$CODEBASE_NAME" ]; then
            echo "The name in Chart.yaml matches the CODEBASE_NAME."
        else
            echo "The name in Chart.yaml does not match the CODEBASE_NAME."
            exit 1
        fi

      workingDir: $(workspaces.source.path)
  workspaces:
    - description: A workspace that contains fetched git repo.
      name: source
---
# Source: edp-tekton/templates/tasks/codenarc.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: codenarc
  labels:
    app.kubernetes.io/version: "0.2"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/displayName: CodeNarc
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This Task can be used to run a Gradle build and a Groovy CodeNarc review.
    Download the output of the 'codenarc-report' step as logs from Tekton
    and save it as 'html'.
    Open the 'html' file in a browser to see the CodeNarc report.

  workspaces:
    - name: source
      description: The workspace consisting of the gradle project.
  params:
    - name: BASE_IMAGE
      description: Gradle base image.
      type: string
      default: gradle:7.5.1-jdk11
    - name: PROJECT_DIR
      description: The directory containing build.gradle
      type: string
      default: "."
    - name: ci-nexus
      type: string
      description: name of the secret for the Nexus integration
      default: ci-nexus
    - name: EXTRA_ARGS
      description: Extra arguments to add to the gradle build
      default: |
        -Dorg.gradle.internal.publish.checksums.insecure=true \
        publish
  volumes:
    - name: settings-codenarc
      configMap:
        name: custom-codenarc-settings
  steps:
    - name: gradle-tasks
      image: $(params.BASE_IMAGE)
      volumeMounts:
        - name: settings-codenarc
          mountPath: /var/configmap
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      script: |
        #!/bin/bash
        set -e

        gradle \
          -I \
          /var/configmap/init.gradle \
          -PnexusLogin=${CI_USERNAME} \
          -PnexusPassword=${CI_PASSWORD} \
          $(params.EXTRA_ARGS)
      env:
        - name: HOME
          value: $(workspaces.source.path)
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
    - name: codenarc-report
      image: alpine:3.18.6
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      script: |
        cat /workspace/source/build/reports/codenarc/main.html
---
# Source: edp-tekton/templates/tasks/commit-validate.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  annotations:
    tekton.dev/displayName: Commit-Validate
    tekton.dev/platforms: linux/amd64
  name: commit-validate
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  description: |
    This task validates a commit message.
  params:
    - name: COMMIT_MESSAGE
      description: "Commit message"
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
    - name: BASE_IMAGE
      description: "The base image for the task."
      default: "python:3.10.1-alpine3.15"
    - name: MAX_LINE_LENGTH
      description: "Maximum length of each line in the commit message."
      default: "80"
  steps:
    - image: $(params.BASE_IMAGE)
      name: commit-validate
      env:
        - name: COMMIT_MESSAGE_PATTERN
          value: $(params.COMMIT_MESSAGE_PATTERN)
        - name: COMMIT_MESSAGE
          value: $(params.COMMIT_MESSAGE)
        - name: MAX_LINE_LENGTH
          value: $(params.MAX_LINE_LENGTH)
      script: |
        #!/usr/bin/env python

        import os
        import sys
        import re

        commit_message_pattern = os.getenv("COMMIT_MESSAGE_PATTERN")
        if not commit_message_pattern:
            print("[TEKTON] Pattern to validate commit message is empty")
            sys.exit(1)

        commit_message = os.getenv("COMMIT_MESSAGE")

        print("[TEKTON] Pattern to validate commit message: " + commit_message_pattern)

        print("[TEKTON] Commit message to validate has been fetched:\n" + commit_message)

        result = re.search(commit_message_pattern, commit_message)

        if result == None:
            print("[TEKTON] Commit message is invalid. The required pattern is " + commit_message_pattern)
            sys.exit(1)

        max_line_length = int(os.getenv("MAX_LINE_LENGTH"))
        lines = commit_message.split('\n')
        for line in lines:
            if len(line) > max_line_length:
                print(f"[TEKTON] A line in the commit message is too long. Each line should be no longer than {max_line_length} characters.")
                sys.exit(1)
---
# Source: edp-tekton/templates/tasks/create-ecr-repository.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: create-ecr-repository
  labels:
    app.kubernetes.io/based-on: "0.6"
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Image Build
    tekton.dev/tags: image-build
    tekton.dev/displayName: "Init ECR repository"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This Task creates an ECR repo
  params:
    - name: REPO_NAME
      description: "The name of the ecr repository where we are going to push the image"
    - name: edp-config
      type: string
      description: "This configmap holds aws_region parameter"
      default: edp-config
  steps:
    - name: init-repository
      image: amazon/aws-cli:2.7.35
      
      env:
        - name: REPO_NAME
          value: "$(params.REPO_NAME)"
        - name: AWS_DEFAULT_REGION
          valueFrom:
            configMapKeyRef:
              name: "$(params.edp-config)"
              key: 'aws_region'
      command: ["/bin/sh"]
      args:
        - "-c"
        - |
          ECR_REPO_NAME=$(echo "${REPO_NAME}" | cut -d'/' -f2-)
          aws ecr describe-repositories --repository-names "$ECR_REPO_NAME" || aws ecr create-repository --repository-name "$ECR_REPO_NAME"
---
# Source: edp-tekton/templates/tasks/dotnet.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: dotnet
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/displayName: DotNet
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This Task can be used to run a DotNet build.

  workspaces:
    - name: source
      description: The workspace consisting of the dotnet project.

  volumes:
    - name: settings-nuget
      configMap:
        name: custom-nuget-settings

  params:
    - name: BASE_IMAGE
      description: DotNet base image.
      type: string
      default: "mcr.microsoft.com/dotnet/sdk:3.1.423-alpine3.16"
    - name: PROJECT_DIR
      description: The directory containing source code.
      type: string
      default: "."
    - name: ci-nexus
      type: string
      description: name of the secret for the Nexus integration
      default: ci-nexus
    - name: ci-sonarqube
      type: string
      description: name of the secret for the Sonarqube integration
      default: "ci-sonarqube"
    - name: EXTRA_COMMANDS
      type: string
  steps:
    - name: dotnet
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)

      volumeMounts:
        - name: settings-nuget
          mountPath: $(workspaces.source.path)/$(params.PROJECT_DIR)/nuget.config
          subPath: nuget.config

      env:
        - name: HOME
          value: $(workspaces.source.path)
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: token
        - name: SONAR_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: url
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
      script: |
        #!/usr/bin/env sh
        set -e
        $(params.EXTRA_COMMANDS)
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/ecr-to-docker.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: ecr-to-docker
  labels:
    app.kubernetes.io/based-on: "0.6"
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Image Copy
    tekton.dev/tags: image-copy
    tekton.dev/displayName: "Push ECR images to DockerHUB"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This task copies images from ECR to DockerHUB.
    It must be used after kaniko-build task.
    It is necessary to add a Service Account in a Pipeline for this task to run
    since it uses AWS ECR authentication.
  params:
    - name: ECR_LOGIN
      type: string
      default: '/workspace/ecr_login_pass'
    - name: ECR_USER
      type: string
      default: 'AWS'
    - name: CODEBASE_NAME
      type: string
    - name: IMAGE_TAG
      type: string
    - name: DOCKERHUB_HOST
      type: string
      default: 'index.docker.io'
    - name: dockerhub-credentials
      type: string
      description: secret holding dockerhub login token
      default: dockerhub-credentials
    - name: edp-config
      type: string
      description: this configmap holds aws_region parameter
      default: edp-config
  steps:
    - image: amazon/aws-cli:2.7.35
      name: get-ecr-pass
      computeResources: {}
      env:
        - name: ECR_LOGIN
          value: "$(params.ECR_LOGIN)"
        - name: AWS_REGION
          valueFrom:
            configMapKeyRef:
              name: "$(params.edp-config)"
              key: 'aws_region'
      script: |
        aws ecr get-login-password --region "${AWS_REGION}" > "${ECR_LOGIN}"
        ls -l "${ECR_LOGIN}"
    - name: copy-image
      env:
        - name: ECR_LOGIN
          value: "$(params.ECR_LOGIN)"
        - name: ECR_USER
          value: "$(params.ECR_USER)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: IMAGE_TAG
          value: "$(params.IMAGE_TAG)"
        - name: DOCKERHUB_HOST
          value: "$(params.DOCKERHUB_HOST)"
        - name: DOCKERHUB_USERNAME
          valueFrom:
            secretKeyRef:
              name: "$(params.dockerhub-credentials)"
              key: 'username'
        - name: DOCKERHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: "$(params.dockerhub-credentials)"
              key: 'accesstoken'
        - name: DOCKERHUB_ACCOUNT
          valueFrom:
            secretKeyRef:
              name: "$(params.dockerhub-credentials)"
              key: 'account'
        - name: CONTAINER_REGISTRY_URL
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: container_registry_host
        - name: CONTAINER_REGISTRY_SPACE
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: container_registry_space
      image: gcr.io/go-containerregistry/crane/debug:v0.11.0
      script: |
        #!/busybox/sh
        DOCKERHUB_IMAGE_TAGGED="${DOCKERHUB_HOST}/${DOCKERHUB_ACCOUNT}/${CODEBASE_NAME}:${IMAGE_TAG}"
        echo "${DOCKERHUB_TOKEN}" | crane auth login "${DOCKERHUB_HOST}" -u "${DOCKERHUB_USERNAME}" --password-stdin
        if crane manifest "${DOCKERHUB_IMAGE_TAGGED}"; then
            echo " [INFO] Image "${DOCKERHUB_IMAGE_TAGGED}" already exists in Docker Hub"
            exit 1
        else
            cat "${ECR_LOGIN}" | crane auth login "${CONTAINER_REGISTRY_URL}" -u "${ECR_USER}" --password-stdin
            crane cp "${CONTAINER_REGISTRY_URL}/${CONTAINER_REGISTRY_SPACE}/${CODEBASE_NAME}:${IMAGE_TAG}" "${DOCKERHUB_IMAGE_TAGGED}"
        fi
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/edp-dotnet.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: edp-dotnet
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/displayName: DotNet
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This Task can be used to run a DotNet build.

  workspaces:
    - name: source
      description: The workspace consisting of the dotnet project.
  params:
    - name: BASE_IMAGE
      description: DotNet base image.
      type: string
      default: "mcr.microsoft.com/dotnet/sdk:3.1.423-alpine3.16"
    - name: PROJECT_DIR
      description: The directory containing build.gradle
      type: string
      default: "source"
    - name: DOTNET_CACHE
      type: string
      description: name of the secret for the Sonarqube integration
      default: "/workspace/source/cache"
  steps:
    - name: build
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      env:
        - name: HOME
          value: $(workspaces.source.path)
        - name: DOTNET_CACHE
          value: $(params.DOTNET_CACHE)
      script: |
        #!/usr/bin/env sh
        set -e
        dotnet restore --packages ${DOTNET_CACHE}
        dotnet build
    - name: test
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      env:
        - name: HOME
          value: $(workspaces.source.path)
        - name: DOTNET_CACHE
          value: $(params.DOTNET_CACHE)
      script: |
        #!/usr/bin/env sh
        set -e
        dotnet restore --packages ${DOTNET_CACHE}
        ls *Tests*/*.csproj | while read -r file;
            do dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=opencover "${file}";
        done
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/edp-gradle.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: edp-gradle
  labels:
    app.kubernetes.io/version: "0.2"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/displayName: Gradle
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This Task can be used to run a Gradle build.

  workspaces:
    - name: source
      description: The workspace consisting of the gradle project.
  params:
    - name: BASE_IMAGE
      description: Gradle base image.
      type: string
      default: gradle:7.5.1-jdk11
    - name: PROJECT_DIR
      description: The directory containing build.gradle
      type: string
      default: "source"
    - name: ci-nexus
      type: string
      description: name of the secret for the Nexus integration
      default: ci-nexus
    - name: GRADLE_USER_CACHE
      description: Gradle user cache directory
      default: /workspace/source/cache
  volumes:
    - name: settings-gradle
      configMap:
        name: custom-gradle-settings
  steps:
    - name: compile
      image: $(params.BASE_IMAGE)
      volumeMounts:
        - name: settings-gradle
          mountPath: /var/configmap
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      script: |
        #!/bin/bash
        set -e

        gradle \
          -I \
          /var/configmap/init.gradle \
            clean \
            compileJava \
            -x test
      env:
        - name: XDG_CONFIG_HOME
          value: $(workspaces.source.path)/$(params.PROJECT_DIR)
        - name: GRADLE_USER_HOME
          value: $(params.GRADLE_USER_CACHE)
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
    - name: test
      image: $(params.BASE_IMAGE)
      volumeMounts:
        - name: settings-gradle
          mountPath: /var/configmap
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      script: |
        #!/bin/bash
        set -e

        gradle \
          -I \
          /var/configmap/init.gradle \
            test \
            jacocoTestReport
      env:
        - name: XDG_CONFIG_HOME
          value: $(workspaces.source.path)/$(params.PROJECT_DIR)
        - name: GRADLE_USER_HOME
          value: $(params.GRADLE_USER_CACHE)
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
    - name: build
      image: $(params.BASE_IMAGE)
      volumeMounts:
        - name: settings-gradle
          mountPath: /var/configmap
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      script: |
        #!/bin/bash
        set -e

        gradle \
          -I \
          /var/configmap/init.gradle \
            build -x test
      env:
        - name: XDG_CONFIG_HOME
          value: $(workspaces.source.path)/$(params.PROJECT_DIR)
        - name: GRADLE_USER_HOME
          value: $(params.GRADLE_USER_CACHE)
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/edp-npm.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: edp-npm
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task can be used to run npm goals on a project
    where package.json is present and has some pre-defined
    npm scripts.
  params:
    - name: PATH_CONTEXT
      type: string
      default: "source"
      description: The path where package.json of the project is defined.
    - name: BASE_IMAGE
      type: string
      default: "docker.io/library/node:18.20.3-alpine3.20"
      description: The node image you want to use.
    - name: ci-nexus
      type: string
      description: name of the secret for the Nexus integration
      default: ci-nexus
    - name: ci-sonarqube
      type: string
      description: name of the secret for the Sonarqube integration
      default: "ci-sonarqube"
    - name: CACHE_DIR
      default: "/workspace/source/cache"
      description: The path to the cache directory.

  workspaces:
    - name: source

  volumes:
    - name: settings-npm
      configMap:
        name: custom-npm-settings

  steps:
    - name: init
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)

      volumeMounts:
        - name: settings-npm
          mountPath: /var/configmap

      env:
        - name: HOME
          value: "$(workspaces.source.path)/"
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
        - name: NPM_CACHE_DIR
          value: $(params.CACHE_DIR)
      script: |
        #!/usr/bin/env sh
        set -e
        
        export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
        export npm_config_userconfig=/var/configmap/.npmrc-ci
        export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
        npm ci

    - name: build
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)
      script: |
        npm run build:prod
      

    - name: test
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)
      script: |
        npm run test:coverage
      
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/gerrit-ssh-cmd.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: gerrit-ssh-cmd
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Gerrit Tools
    tekton.dev/tags: ssh, gerrit api
    tekton.dev/displayName: "gerrit api over ssh"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    The following task can be used to run gerrit votes using ssh.

    The following task takes gerrit host and required credentials as input along
    with the command and run it on gerrit server.
  workspaces:
    - name: ssh-directory
      optional: true
      description: |
        A .ssh directory with private key, known_hosts, config, etc. Copied to
        the user's home before ssh commands are executed.
  params:
    - name: GERRIT_HOST
      type: string
      description: Remote host to connect
      default: "gerrit"
    - name: USERNAME
      type: string
      description: SSH username
      default: "edp-ci"
    - name: GERRIT_PORT
      type: string
      description: SSH port, default is 22
      default: "22"
    - name: SSH_GERRIT_COMMAND
      type: string
      description: The gerrit command you want to run over ssh
    - name: ERR_EXIT_CODE
      type: string
      description: Define Error exit code for task. By default - 1. In case of skip set 0
      default: "1"
    - name: userHome
      description: |
        Absolute path to the user's home directory. Set this explicitly if you are running the image as a non-root user or have overridden
        the gitInitImage param with an image containing custom user configuration.
      type: string
      default: "/tekton/home"
  steps:
    - name: ssh
      image: 'epamedp/tekton-openssh-client:0.1.5'
      env:
        - name: GERRIT_HOST
          value: "$(params.GERRIT_HOST)"
        - name: GERRIT_PORT
          value: "$(params.GERRIT_PORT)"
        - name: USERNAME
          value: "$(params.USERNAME)"
        - name: SSH_GERRIT_COMMAND
          value: "$(params.SSH_GERRIT_COMMAND)"
        - name: PARAM_USER_HOME
          value: $(params.userHome)
        - name: ERR_EXIT_CODE
          value: $(params.ERR_EXIT_CODE)
        - name: WORKSPACE_SSH_DIRECTORY_BOUND
          value: $(workspaces.ssh-directory.bound)
        - name: WORKSPACE_SSH_DIRECTORY_PATH
          value: $(workspaces.ssh-directory.path)
      script: |
        #!/usr/bin/env sh
        set -eu

        if [ "${WORKSPACE_SSH_DIRECTORY_BOUND}" = "true" ] ; then
          cp -R "${WORKSPACE_SSH_DIRECTORY_PATH}" "${PARAM_USER_HOME}"/.ssh
          chmod 700 "${PARAM_USER_HOME}"/.ssh
          chmod -R 400 "${PARAM_USER_HOME}"/.ssh/*
        fi

        ssh -o StrictHostKeyChecking=no -p ${GERRIT_PORT} ${USERNAME}@${GERRIT_HOST} gerrit ${SSH_GERRIT_COMMAND} || exit ${ERR_EXIT_CODE}
---
# Source: edp-tekton/templates/tasks/get-cache.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: get-cache
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/displayName: "get-cache"
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This Task is used to get the cache from the distribution server. It stores cache in the root of the workspace.
  params:
    - name: CACHE_NAME
      description: "Cache name (filename) to be downloaded from the cache server."
      type: string
    - name: BASE_IMAGE
      description: "Base image"
      default: "ghcr.io/curl/curl-container/curl-multi:8.3.0"
      type: string

  workspaces:
    - name: cache

  steps:
    - name: get-cache
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.cache.path)

      script: |
        #!/usr/bin/env sh
        set -ex
        set -o pipefail

        curl -fsI ${CACHE_SERVER_URL}/${CACHE_NAME}.tar.gz || {
              echo "no cache found"
              exit 0
        }

        echo "Getting cache"
        curl ${CACHE_SERVER_URL}/${CACHE_NAME}.tar.gz|tar -xz -f-
      env:
        - name: CACHE_SERVER_URL
          valueFrom:
            configMapKeyRef:
              name: tekton-cache
              key: url
              optional: true
        - name: CACHE_NAME
          value: "$(params.CACHE_NAME)"
      # TODO: We need to run this task as root because the workspace is owned by root.
      securityContext:
        runAsUser: 0

      computeResources:
        limits:
          cpu: 500m
          memory: 256Mi
        requests:
          cpu: 100m
          memory: 128Mi
---
# Source: edp-tekton/templates/tasks/getversion/defaulttype/GetVersion.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: get-version-default
spec:
  description: |
    This task generates a version number for the application based on the current timestamp and the branch name.
    The version number is used to tag the image and the codebase image stream.
  params:
    - name: BRANCH_NAME
      type: string
      description: Branch name.
  results:
    - name: VERSION
      description: "Application version"
    - name: VCS_TAG
      description: "VCS tag"
    - name: IS_TAG
      description: "CodebaseImageStream tag"
    - name: TIMESTAMP
      description: Current timestamp
  steps:
    - name: get-timestamp
      image: alpine:3.18.6
      script: |
        ts=$(date "+%Y%m%d-%H%M%S")
        echo "Current Timestamp: ${ts}"
        echo ${ts} | tr -d "\n" | tee $(results.TIMESTAMP.path)

    - name: get-version
      image: alpine:3.18.6
      env:
        - name: BRANCH_NAME
          value: "$(params.BRANCH_NAME)"
      script: |
        set -e

        # get current BUILD ID
        BUILD_ID=$(cat $(results.TIMESTAMP.path))

        BUILD_VERSION="${BUILD_ID}"
        VCS_TAG="${BRANCH_NAME}-${BUILD_VERSION}"
        NORMALIZED_BRANCH=$(printf '%s' "${BRANCH_NAME}" | sed 's/\//-/g')
        IS_TAG="${NORMALIZED_BRANCH}-${BUILD_VERSION}"

        echo "Application version - ${BUILD_VERSION}"
        echo "VCS tag - ${VCS_TAG}"
        echo "IS tag - ${IS_TAG}"

        printf "%s" "${BUILD_VERSION}" > "$(results.VERSION.path)"
        printf "%s" "${VCS_TAG}" > "$(results.VCS_TAG.path)"
        printf "%s" "${IS_TAG}" > "$(results.IS_TAG.path)"
        printf "%s" "${BUILD_ID}" > "$(results.VERSION.path)"
---
# Source: edp-tekton/templates/tasks/getversion/defaulttype/GetVersionHelm.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: get-version-helm-default
spec:
  description:
    The task is used to get the version of the application from the helm chart.
  workspaces:
    - name: source
      description: The workspace consisting of csharp project.
  params:
    - name: BRANCH_NAME
      type: string
      description: Branch name.
    - name: chart-dir
      type: string
  results:
    - name: VERSION
      description: "Application version"
    - name: VCS_TAG
      description: "VCS tag"
    - name: IS_TAG
      description: "CodebaseImageStream tag"
  steps:
    - name: get-version
      image: linuxserver/yq
      env:
        - name: BRANCH_NAME
          value: "$(params.BRANCH_NAME)"
        - name: CHART_DIR
          value: "$(params.chart-dir)"
      workingDir: $(workspaces.source.path)
      script: |
        set -e

        BUILD_VERSION=$(grep -m 1 -oE 'version:[[:space:]]*[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)*' ${CHART_DIR}/Chart.yaml | awk '{print $2}')
        BUILD_VERSION=$(cat ${CHART_DIR}/Chart.yaml | yq -r ".version")

        VCS_TAG="${BRANCH_NAME}-${BUILD_VERSION}"
        IS_TAG="${BUILD_VERSION}"

        echo "VCS tag - ${VCS_TAG}"
        echo "IS tag - ${IS_TAG}"
        echo "VERSION tag - ${BUILD_VERSION}"

        printf "%s" "${VCS_TAG}" > "$(results.VCS_TAG.path)"
        printf "%s" "${BUILD_VERSION}" > "$(results.VERSION.path)"
        printf "%s" "${IS_TAG}" > "$(results.IS_TAG.path)"
---
# Source: edp-tekton/templates/tasks/getversion/defaulttype/UpdateBuildNumberDotnet.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: get-version-dotnet-default
spec:
  description:
  workspaces:
    - name: source
      description: The workspace consisting of dotnet project.
  params:
    - name: BRANCH_NAME
      type: string
      description: Branch name.
  results:
    - name: VERSION
      description: "Application version"
    - name: VCS_TAG
      description: "VCS tag"
    - name: IS_TAG
      description: "CodebaseImageStream tag"
    - name: DEPLOYABLE_MODULE_DIR
    - name: TIMESTAMP
      description: Current timestamp
  steps:
    - name: get-timestamp
      image: alpine:3.18.6
      script: |
        ts=$(date "+%Y%m%d-%H%M%S")
        echo "Current Timestamp: ${ts}"
        echo ${ts} | tr -d "\n" | tee $(results.TIMESTAMP.path)

    - name: get-version
      image: alpine:3.18.6
      env:
        - name: BRANCH_NAME
          value: "$(params.BRANCH_NAME)"
      workingDir: $(workspaces.source.path)
      script: |
        set -e

        DEPLOYABLE_MODULE=$(find ./ -name '*.csproj' | xargs awk  -F '[><]' '/<DeployableModule>/ {print $3}')

        VERSION=$(find ${DEPLOYABLE_MODULE} -name '*.csproj' | xargs awk  -F '[><]' '/<Version>/ {print $3}' | tr '[:upper:]' '[:lower:]')

        # get current BUILD ID
        BUILD_ID=$(cat $(results.TIMESTAMP.path))

        BUILD_VERSION="${VERSION}-${BUILD_ID}"
        VCS_TAG="${BUILD_VERSION}"
        NORMALIZED_BRANCH=$(printf '%s' "${BRANCH_NAME}" | sed 's/\//-/g')
        IS_TAG="${BUILD_VERSION}"

        echo "Application version - ${BUILD_VERSION}"
        echo "VCS tag - ${VCS_TAG}"
        echo "IS tag - ${IS_TAG}"

        printf "%s" "${BUILD_VERSION}" > "$(results.VERSION.path)"
        printf "%s" "${VCS_TAG}" > "$(results.VCS_TAG.path)"
        printf "%s" "${IS_TAG}" > "$(results.IS_TAG.path)"

        DEPLOYABLE_MODULE_DIR="."

        printf "%s" "${DEPLOYABLE_MODULE_DIR}" > "$(results.DEPLOYABLE_MODULE_DIR.path)"
---
# Source: edp-tekton/templates/tasks/getversion/defaulttype/UpdateBuildNumberGradle.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-build-number-gradle-default
spec:
  description:
  workspaces:
    - name: source
      description: The workspace consisting of gradle project.
  params:
    - name: VERSION
      type: string
      description: "Version"
    - name: BASE_IMAGE
      description: "The base image for the task"
      default: "alpine:3.18.6"
  steps:
    - name: update-build-number
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: VERSION
          value: "$(params.VERSION)"
      script: |
        set -ex

        sed -i "s/version = .*/version = \'${VERSION}\'/" build.gradle
---
# Source: edp-tekton/templates/tasks/getversion/defaulttype/UpdateBuildNumberNpm.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-build-number-npm-default
spec:
  description:
  workspaces:
    - name: source
      description: The workspace consisting of npm project.
  params:
    - name: VERSION
      type: string
      description: "Version"
    - name: BASE_IMAGE
      description: "The base image for the task"
      default: "node:18.9.0"
  steps:
    - name: update-build-number
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: VERSION
          value: "$(params.VERSION)"
      script: |
        #!/usr/bin/env sh
        set -ex

        NPM_VERSION=$(node -p "require('./package.json').version" | tr '[:upper:]' '[:lower:]')

        BUILD_VERSION="${NPM_VERSION}-${VERSION}"

        npm --no-git-tag-version version ${BUILD_VERSION}
---
# Source: edp-tekton/templates/tasks/getversion/defaulttype/UpdateBuildNumberPython.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-build-number-python-default
spec:
  description:
  workspaces:
    - name: source
      description: The workspace consisting of python project.
  params:
    - name: VERSION
      type: string
      description: "Version"
    - name: BASE_IMAGE
      description: "The base image for the task"
      default: "alpine:3.18.6"
  steps:
    - name: update-build-number
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: VERSION
          value: "$(params.VERSION)"
      script: |
        #!/bin/sh
        set -ex

        sed -i 's/\(__version__\s*=\s*\).*/\1'\"${VERSION}\"'/' version/__init__.py
        cat version/__init__.py
---
# Source: edp-tekton/templates/tasks/getversion/edptype/GetVersionEDP.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: get-version-edp
spec:
  description:
  params:
    - name: CODEBASEBRANCH_NAME
      type: string
      description: "Codebasebranch name"
  results:
    - name: VERSION
      description: "Application version"
    - name: VCS_TAG
      description: "VCS tag"
    - name: IS_TAG
      description: "CodebaseImageStream tag"
    - name: BUILD_ID
      description: "Build id"
    - name: BRANCH_VERSION
      description: "Branch version"
    - name: IS_RELEASE_BRANCH
    - name: DEPLOYABLE_MODULE_DIR
  steps:
    - name: get-version
      image: bitnami/kubectl:1.25.2
      env:
        - name: CODEBASEBRANCH_NAME
          value: "$(params.CODEBASEBRANCH_NAME)"
      script: |
        #!/usr/bin/env bash
        set -e

        # replace '/' with '-'
        CODEBASEBRANCH_NAME=${CODEBASEBRANCH_NAME//\//-}
        # get current BUILD ID
        BUILD_ID=$(kubectl get codebasebranches.v2.edp.epam.com ${CODEBASEBRANCH_NAME} -o txt --output=jsonpath={.status.build})
        # and increment it
        BUILD_ID=$((BUILD_ID+1))
        # set new version
        kubectl patch codebasebranches.v2.edp.epam.com ${CODEBASEBRANCH_NAME} --subresource=status --type=merge -p "{\"status\": {\"build\": \"$BUILD_ID\"}}"

        IS_RELEASE_BRANCH=$(kubectl get codebasebranches.v2.edp.epam.com ${CODEBASEBRANCH_NAME} -o txt --output=jsonpath={.spec.release})

        # Get current version
        VERSION=$(kubectl get codebasebranches.v2.edp.epam.com ${CODEBASEBRANCH_NAME} -o txt --output=jsonpath={.spec.version})

        # Replace slashes
        VERSION=$(printf '%s' ${VERSION} | sed 's/\//-/g')

        BRANCH_VERSION=${VERSION}
        VERSION="${VERSION}.${BUILD_ID}"
        VCS_TAG="build/${VERSION}"
        IS_TAG=${VERSION}
        DEPLOYABLE_MODULE_DIR="."

        echo "Application version - ${VERSION}"
        echo "VCS tag - ${VCS_TAG}"
        echo "IS tag - ${IS_TAG}"
        echo "Build id - ${BUILD_ID}"
        echo "Branch version - ${BRANCH_VERSION}"

        if [ "${IS_RELEASE_BRANCH}" = "true" ] ; then
            VERSION="${BRANCH_VERSION}.${BUILD_ID}"
        else
            VERSION="${BRANCH_VERSION}"
        fi

        printf "%s" "${VERSION}" > "$(results.VERSION.path)"
        printf "%s" "${VCS_TAG}" > "$(results.VCS_TAG.path)"
        printf "%s" "${IS_TAG}" > "$(results.IS_TAG.path)"
        printf "%s" "${BUILD_ID}" > "$(results.BUILD_ID.path)"
        printf "%s" "${BRANCH_VERSION}" > "$(results.BRANCH_VERSION.path)"
        printf "%s" "${IS_RELEASE_BRANCH}" > "$(results.IS_RELEASE_BRANCH.path)"
        printf "%s" "${DEPLOYABLE_MODULE_DIR}" > "$(results.DEPLOYABLE_MODULE_DIR.path)"
---
# Source: edp-tekton/templates/tasks/getversion/edptype/UpdateBuildNumberCsharp.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-build-number-csharp
spec:
  description:
  workspaces:
    - name: source
      description: The workspace consisting of maven project.
  params:
    - name: VERSION
      type: string
      description: "Version"
    - name: BASE_IMAGE
      description: "The base image for the task"
      default: "alpine:3.18.6"
  steps:
    - name: update-build-number
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: VERSION
          value: "$(params.VERSION)"
      script: |
        set -ex

        DEPLOYABLE_MODULE=$(find ./ -name '*.csproj')
        sed -i "s#\(<Version>\).*\(</Version>\)#\1${VERSION}\2#" ${DEPLOYABLE_MODULE}
---
# Source: edp-tekton/templates/tasks/getversion/edptype/UpdateBuildNumberDotnet.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-build-number-dotnet
spec:
  description:
  workspaces:
    - name: source
      description: The workspace consisting of maven project.
  params:
    - name: VERSION
      type: string
      description: "Version"
    - name: BASE_IMAGE
      description: "The base image for the task"
      default: "alpine:3.18.6"
  steps:
    - name: update-build-number
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: VERSION
          value: "$(params.VERSION)"
      script: |
        set -ex

        DEPLOYABLE_MODULE=$(find ./ -name '*.csproj' | xargs awk  -F '[><]' '/<DeployableModule>/ {print $3}')
        sed -i "s#\(<Version>\).*\(</Version>\)#\1${VERSION}\2#" ${DEPLOYABLE_MODULE}/${DEPLOYABLE_MODULE}.csproj
---
# Source: edp-tekton/templates/tasks/getversion/edptype/UpdateBuildNumberGradle.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-build-number-gradle
spec:
  description:
  workspaces:
    - name: source
      description: The workspace consisting of maven project.
  params:
    - name: BRANCH_VERSION
      type: string
      description: "Branch version"
    - name: BUILD_ID
      type: string
      description: "Version"
    - name: IS_RELEASE_BRANCH
      type: string
    - name: BASE_IMAGE
      description: "The base image for the task"
      default: "alpine:3.18.6"
  steps:
    - name: update-build-number
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: BRANCH_VERSION
          value: "$(params.BRANCH_VERSION)"
        - name: BUILD_ID
          value: "$(params.BUILD_ID)"
      script: |
        set -ex

        if [ "${IS_RELEASE_BRANCH}" = "true" ] ; then
            sed -i "s/version = .*/version = \'${BRANCH_VERSION}-${BUILD_ID}\'/" build.gradle
        else
            sed -i "s/^version = .*/version = \'${BRANCH_VERSION}\'/" build.gradle
        fi
---
# Source: edp-tekton/templates/tasks/getversion/edptype/UpdateBuildNumberHelmChart.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-build-number-helm-chart
spec:
  description: >-
    This Task can be used to update a helm chart version.
  workspaces:
    - name: source
      description: The workspace consisting of helm chart project.
  params:
    - name: VERSION
      type: string
      description: "Version"
    - name: CHART_DIR
      description: The directory in source that contains the helm chart
      default: "."
    - name: BASE_IMAGE
      description: "The base image for the task"
      default: "alpine:3.18.6"
  steps:
    - name: update-build-number
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: VERSION
          value: "$(params.VERSION)"
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      script: |
        #!/bin/sh
        set -ex

        sed -i "s/^version: .*$/version: ${VERSION}/" ${CHART_DIR}/Chart.yaml
---
# Source: edp-tekton/templates/tasks/getversion/edptype/UpdateBuildNumberNpm.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-build-number-npm
spec:
  description:
  workspaces:
    - name: source
      description: The workspace consisting of maven project.
  params:
    - name: BRANCH_VERSION
      type: string
      description: "Branch version"
    - name: BUILD_ID
      type: string
      description: "Version"
    - name: BASE_IMAGE
      description: "The base image for the task"
      default: "node:18.9.0"
  steps:
    - name: update-build-number
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: BRANCH_VERSION
          value: "$(params.BRANCH_VERSION)"
        - name: BUILD_ID
          value: "$(params.BUILD_ID)"
      script: |
        #!/usr/bin/env sh
        set -ex

        npm --no-git-tag-version version ${BRANCH_VERSION}-${BUILD_ID}
---
# Source: edp-tekton/templates/tasks/getversion/edptype/UpdateBuildNumberPython.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-build-number-python
spec:
  description:
  workspaces:
    - name: source
      description: The workspace consisting of maven project.
  params:
    - name: VERSION
      type: string
      description: "Version"
    - name: BASE_IMAGE
      description: "The base image for the task"
      default: "alpine:3.18.6"
  steps:
    - name: update-build-number
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: VERSION
          value: "$(params.VERSION)"
      script: |
        #!/bin/sh
        set -ex

        VERSION_LOWER_CASE=$(echo "${VERSION}" | tr '[:upper:]' '[:lower:]')
        if [[ ! ${VERSION_LOWER_CASE} == *"snapshot"* ]]; then
            sed -i 's/\(__version__\s*=\s*\).*/\1'\"${VERSION}\"'/' version/__init__.py
        fi
        cat version/__init__.py
---
# Source: edp-tekton/templates/tasks/git-cli.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: git-cli
  labels:
    app.kubernetes.io/version: "0.4"
  annotations:
    tekton.dev/pipelines.minVersion: "0.21.0"
    tekton.dev/categories: Git
    tekton.dev/tags: git
    tekton.dev/displayName: "git cli"
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task can be used to perform git operations.

    Git command that needs to be run can be passed as a script to
    the task. This task needs authentication to git in order to push
    after the git operation.

  workspaces:
    - name: source
      description: A workspace that contains the fetched git repository.

    - name: input
      optional: true
      description: |
        An optional workspace that contains the files that need to be added to git. You can
        access the workspace from your script using `$(workspaces.input.path)`, for instance:

          cp $(workspaces.input.path)/file_that_i_want .
          git add file_that_i_want
          # etc

    - name: ssh-directory
      optional: true
      description: |
        A .ssh directory with private key, known_hosts, config, etc. Copied to
        the user's home before git commands are executed. Used to authenticate
        with the git remote when performing the clone. Binding a Secret to this
        Workspace is strongly recommended over other volume types.

    - name: basic-auth
      optional: true
      description: |
        A Workspace containing a .gitconfig and .git-credentials file. These
        will be copied to the user's home before any git commands are run. Any
        other files in this Workspace are ignored. It is strongly recommended
        to use ssh-directory over basic-auth whenever possible and to bind a
        Secret to this Workspace over other volume types.
  params:
    - name: BASE_IMAGE
      description: |
        The base image for the task.
      type: string
      default: docker.io/alpine/git:v2.26.2@sha256:23618034b0be9205d9cc0846eb711b12ba4c9b468efdd8a59aac1d7b1a23363f #tag: v2.26.2

    - name: GIT_USER_NAME
      type: string
      description: |
        Git user name for performing git operation.
      default: ""

    - name: GIT_USER_EMAIL
      type: string
      description: |
        Git user email for performing git operation.
      default: ""

    - name: GIT_SCRIPT
      description: The git script to run.
      type: string
      default: |
        git help

    - name: USER_HOME
      description: |
        Absolute path to the user's home directory. Set this explicitly if you are running the image as a non-root user or have overridden
        the gitInitImage param with an image containing custom user configuration.
      type: string
      default: "/tekton/home"

    - name: VERBOSE
      description: Log the commands that are executed during `git-clone`'s operation.
      type: string
      default: "true"

  results:
    - name: commit
      description: The precise commit SHA after the git operation.

  steps:
    - name: git
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: GIT_SSH_COMMAND
          value: ssh -i $(params.USER_HOME)/.ssh/id_rsa -o StrictHostKeyChecking=no
        - name: HOME
          value: $(params.USER_HOME)
        - name: PARAM_VERBOSE
          value: $(params.VERBOSE)
        - name: PARAM_USER_HOME
          value: $(params.USER_HOME)
        - name: WORKSPACE_OUTPUT_PATH
          value: $(workspaces.output.path)
        - name: WORKSPACE_SSH_DIRECTORY_BOUND
          value: $(workspaces.ssh-directory.bound)
        - name: WORKSPACE_SSH_DIRECTORY_PATH
          value: $(workspaces.ssh-directory.path)
        - name: WORKSPACE_BASIC_AUTH_DIRECTORY_BOUND
          value: $(workspaces.basic-auth.bound)
        - name: WORKSPACE_BASIC_AUTH_DIRECTORY_PATH
          value: $(workspaces.basic-auth.path)
      script: |
        #!/usr/bin/env sh
        set -eu

        if [ "${PARAM_VERBOSE}" = "true" ] ; then
          set -x
        fi

        if [ "${WORKSPACE_BASIC_AUTH_DIRECTORY_BOUND}" = "true" ] ; then
          cp "${WORKSPACE_BASIC_AUTH_DIRECTORY_PATH}/.git-credentials" "${PARAM_USER_HOME}/.git-credentials"
          cp "${WORKSPACE_BASIC_AUTH_DIRECTORY_PATH}/.gitconfig" "${PARAM_USER_HOME}/.gitconfig"
          chmod 400 "${PARAM_USER_HOME}/.git-credentials"
          chmod 400 "${PARAM_USER_HOME}/.gitconfig"
        fi

        if [ "${WORKSPACE_SSH_DIRECTORY_BOUND}" = "true" ] ; then
          cp -R "${WORKSPACE_SSH_DIRECTORY_PATH}" "${PARAM_USER_HOME}"/.ssh
          chmod 700 "${PARAM_USER_HOME}"/.ssh
          echo "" >> "${PARAM_USER_HOME}"/.ssh/id_rsa
          chmod -R 400 "${PARAM_USER_HOME}"/.ssh/*
        fi

        # Setting up the config for the git.
        git config --global user.email "$(params.GIT_USER_EMAIL)"
        git config --global user.name "$(params.GIT_USER_NAME)"

        # remove git-hooks. We potentially might have hooks installed by components, for example - pre-commit
        # this leads to the situation when we have a hook and are not able to perform git command
        rm -rf .git/hooks

        eval '$(params.GIT_SCRIPT)'

        RESULT_SHA="$(git rev-parse HEAD | tr -d '\n')"
        EXIT_CODE="$?"
        if [ "$EXIT_CODE" != 0 ]
        then
          exit $EXIT_CODE
        fi
        # Make sure we don't add a trailing newline to the result!
        printf "%s" "$RESULT_SHA" > "$(results.commit.path)"
---
# Source: edp-tekton/templates/tasks/git-clone.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: git-clone
  labels:
    app.kubernetes.io/based-on: "0.7"
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.29.0"
    tekton.dev/categories: Git
    tekton.dev/tags: git
    tekton.dev/displayName: "git clone"
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le,linux/arm64"
spec:
  description: >-
    These Tasks are Git tasks to work with repositories used by other tasks
    in your Pipeline.

    The git-clone Task will clone a repo from the provided url into the
    output Workspace. By default the repo will be cloned into the root of
    your Workspace. You can clone into a subdirectory by setting this Task's
    subdirectory param. This Task also supports sparse checkouts. To perform
    a sparse checkout, pass a list of comma separated directory patterns to
    this Task's sparseCheckoutDirectories param.
  workspaces:
    - name: output
      description: The git repo will be cloned onto the volume backing this Workspace.
    - name: ssh-directory
      optional: true
      description: |
        A .ssh directory with private key, known_hosts, config, etc. Copied to
        the user's home before git commands are executed. Used to authenticate
        with the git remote when performing the clone. Binding a Secret to this
        Workspace is strongly recommended over other volume types.
    - name: basic-auth
      optional: true
      description: |
        A Workspace containing a .gitconfig and .git-credentials file. These
        will be copied to the user's home before any git commands are run. Any
        other files in this Workspace are ignored. It is strongly recommended
        to use ssh-directory over basic-auth whenever possible and to bind a
        Secret to this Workspace over other volume types.
    - name: ssl-ca-directory
      optional: true
      description: |
        A workspace containing CA certificates, this will be used by Git to
        verify the peer with when fetching or pushing over HTTPS.
  params:
    - name: url
      description: Repository URL to clone from.
      type: string
    - name: revision
      description: Revision to checkout. (branch, tag, sha, ref, etc...)
      type: string
      default: ""
    - name: refspec
      description: Refspec to fetch before checking out revision.
      default: ""
    - name: submodules
      description: Initialize and fetch git submodules.
      type: string
      default: "true"
    - name: depth
      description: Perform a shallow clone, fetching only the most recent N commits.
      type: string
      default: "2"
    - name: sslVerify
      description: Set the `http.sslVerify` global git config. Setting this to `false` is not advised unless you are sure that you trust your git remote.
      type: string
      default: "true"
    - name: crtFileName
      description: file name of mounted crt using ssl-ca-directory workspace. default value is ca-bundle.crt.
      type: string
      default: "ca-bundle.crt"
    - name: subdirectory
      description: Subdirectory inside the `output` Workspace to clone the repo into.
      type: string
      default: ""
    - name: sparseCheckoutDirectories
      description: Define the directory patterns to match or exclude when performing a sparse checkout.
      type: string
      default: ""
    - name: deleteExisting
      description: Clean out the contents of the destination directory if it already exists before cloning.
      type: string
      default: "true"
    - name: httpProxy
      description: HTTP proxy server for non-SSL requests.
      type: string
      default: ""
    - name: httpsProxy
      description: HTTPS proxy server for SSL requests.
      type: string
      default: ""
    - name: noProxy
      description: Opt out of proxying HTTP/HTTPS requests.
      type: string
      default: ""
    - name: verbose
      description: Log the commands that are executed during `git-clone`'s operation.
      type: string
      default: "true"
    - name: gitInitImage
      description: The image providing the git-init binary that this Task runs.
      type: string
      default: "gcr.io/tekton-releases/github.com/tektoncd/pipeline/cmd/git-init:v0.29.0"
    - name: userHome
      description: |
        Absolute path to the user's home directory. Set this explicitly if you are running the image as a non-root user or have overridden
        the gitInitImage param with an image containing custom user configuration.
      type: string
      default: "/tekton/home"
  results:
    - name: commit
      description: The precise commit SHA that was fetched by this Task.
    - name: url
      description: The precise URL that was fetched by this Task.
  steps:
    - name: clone
      image: "$(params.gitInitImage)"
      env:
      - name: HOME
        value: "$(params.userHome)"
      - name: PARAM_URL
        value: $(params.url)
      - name: PARAM_REVISION
        value: $(params.revision)
      - name: PARAM_REFSPEC
        value: $(params.refspec)
      - name: PARAM_SUBMODULES
        value: $(params.submodules)
      - name: PARAM_DEPTH
        value: $(params.depth)
      - name: PARAM_SSL_VERIFY
        value: $(params.sslVerify)
      - name: PARAM_CRT_FILENAME
        value: $(params.crtFileName)
      - name: PARAM_SUBDIRECTORY
        value: $(params.subdirectory)
      - name: PARAM_DELETE_EXISTING
        value: $(params.deleteExisting)
      - name: PARAM_HTTP_PROXY
        value: $(params.httpProxy)
      - name: PARAM_HTTPS_PROXY
        value: $(params.httpsProxy)
      - name: PARAM_NO_PROXY
        value: $(params.noProxy)
      - name: PARAM_VERBOSE
        value: $(params.verbose)
      - name: PARAM_SPARSE_CHECKOUT_DIRECTORIES
        value: $(params.sparseCheckoutDirectories)
      - name: PARAM_USER_HOME
        value: $(params.userHome)
      - name: WORKSPACE_OUTPUT_PATH
        value: $(workspaces.output.path)
      - name: WORKSPACE_SSH_DIRECTORY_BOUND
        value: $(workspaces.ssh-directory.bound)
      - name: WORKSPACE_SSH_DIRECTORY_PATH
        value: $(workspaces.ssh-directory.path)
      - name: WORKSPACE_BASIC_AUTH_DIRECTORY_BOUND
        value: $(workspaces.basic-auth.bound)
      - name: WORKSPACE_BASIC_AUTH_DIRECTORY_PATH
        value: $(workspaces.basic-auth.path)
      - name: WORKSPACE_SSL_CA_DIRECTORY_BOUND
        value: $(workspaces.ssl-ca-directory.bound)
      - name: WORKSPACE_SSL_CA_DIRECTORY_PATH
        value: $(workspaces.ssl-ca-directory.path)
      script: |
        #!/usr/bin/env sh
        set -eu

        if [ "${PARAM_VERBOSE}" = "true" ] ; then
          set -x
        fi


        if [ "${WORKSPACE_BASIC_AUTH_DIRECTORY_BOUND}" = "true" ] ; then
          cp "${WORKSPACE_BASIC_AUTH_DIRECTORY_PATH}/.git-credentials" "${PARAM_USER_HOME}/.git-credentials"
          cp "${WORKSPACE_BASIC_AUTH_DIRECTORY_PATH}/.gitconfig" "${PARAM_USER_HOME}/.gitconfig"
          chmod 400 "${PARAM_USER_HOME}/.git-credentials"
          chmod 400 "${PARAM_USER_HOME}/.gitconfig"
        fi

        if [ "${WORKSPACE_SSH_DIRECTORY_BOUND}" = "true" ] ; then
          cp -R "${WORKSPACE_SSH_DIRECTORY_PATH}" "${PARAM_USER_HOME}"/.ssh
          chmod 700 "${PARAM_USER_HOME}"/.ssh
          echo "" >> "${PARAM_USER_HOME}"/.ssh/id_rsa
          chmod -R 400 "${PARAM_USER_HOME}"/.ssh/*
        fi

        if [ "${WORKSPACE_SSL_CA_DIRECTORY_BOUND}" = "true" ] ; then
           export GIT_SSL_CAPATH="${WORKSPACE_SSL_CA_DIRECTORY_PATH}"
           if [ "${PARAM_CRT_FILENAME}" != "" ] ; then
              export GIT_SSL_CAINFO="${WORKSPACE_SSL_CA_DIRECTORY_PATH}/${PARAM_CRT_FILENAME}"
           fi
        fi
        CHECKOUT_DIR="${WORKSPACE_OUTPUT_PATH}/${PARAM_SUBDIRECTORY}"

        cleandir() {
          # Delete any existing contents of the repo directory if it exists.
          #
          # We don't just "rm -rf ${CHECKOUT_DIR}" because ${CHECKOUT_DIR} might be "/"
          # or the root of a mounted volume.
          if [ -d "${CHECKOUT_DIR}" ] ; then
            # Delete non-hidden files and directories
            rm -rf "${CHECKOUT_DIR:?}"/*
            # Delete files and directories starting with . but excluding ..
            rm -rf "${CHECKOUT_DIR}"/.[!.]*
            # Delete files and directories starting with .. plus any other character
            rm -rf "${CHECKOUT_DIR}"/..?*
          fi
        }

        if [ "${PARAM_DELETE_EXISTING}" = "true" ] ; then
          cleandir
        fi

        test -z "${PARAM_HTTP_PROXY}" || export HTTP_PROXY="${PARAM_HTTP_PROXY}"
        test -z "${PARAM_HTTPS_PROXY}" || export HTTPS_PROXY="${PARAM_HTTPS_PROXY}"
        test -z "${PARAM_NO_PROXY}" || export NO_PROXY="${PARAM_NO_PROXY}"

        /ko-app/git-init \
          -url="${PARAM_URL}" \
          -revision="${PARAM_REVISION}" \
          -refspec="${PARAM_REFSPEC}" \
          -path="${CHECKOUT_DIR}" \
          -sslVerify="${PARAM_SSL_VERIFY}" \
          -submodules="${PARAM_SUBMODULES}" \
          -depth="${PARAM_DEPTH}" \
          -sparseCheckoutDirectories="${PARAM_SPARSE_CHECKOUT_DIRECTORIES}"
        cd "${CHECKOUT_DIR}"
        RESULT_SHA="$(git rev-parse HEAD)"
        EXIT_CODE="$?"
        if [ "${EXIT_CODE}" != 0 ] ; then
          exit "${EXIT_CODE}"
        fi
        printf "%s" "${RESULT_SHA}" > "$(results.commit.path)"
        printf "%s" "${PARAM_URL}" > "$(results.url.path)"
---
# Source: edp-tekton/templates/tasks/github-set-status.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: github-set-status
  labels:
    app.kubernetes.io/version: "0.4"
  annotations:
    tekton.dev/categories: Git
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/tags: github
    tekton.dev/displayName: "set github status"
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task will set the status of the CI job to the specified value along
    with a link to the specified target URL where developers can follow the
    progress of the CI job.

    The `github-set-status` task allows external services to mark GitHub commits
    with an `error`, `failure`, `pending`, or `success` state, which is then
    reflected in pull requests involving those commits. Statuses include as well a
    `description` and a `target_url`, to give the user informations about the CI
    statuses or a direct link to the full log.

  params:
    - name: GITHUB_HOST_URL
      description: |
        The GitHub host, adjust this if you run a GitHub enteprise.
      default: "api.github.com"
      type: string

    - name: API_PATH_PREFIX
      description: |
        The API path prefix, GitHub Enterprise has a prefix e.g. /api/v3
      default: ""
      type: string

    - name: REPO_FULL_NAME
      description: |
        The GitHub repository full name, e.g.: tektoncd/catalog
      type: string

    - name: GITHUB_TOKEN_SECRET_NAME
      description: |
        The name of the kubernetes secret that contains the GitHub token, default: github
      type: string
      default: github

    - name: GITHUB_TOKEN_SECRET_KEY
      description: |
        The key within the kubernetes secret that contains the GitHub token, default: token
      type: string
      default: token

    - name: SHA
      description: |
        Commit SHA to set the status for.
      type: string

    - name: TARGET_URL
      description: |
        The target URL to associate with this status. This URL will be linked
        from the GitHub UI to allow users to easily see the source of the
        status.
      type: string

    - name: DESCRIPTION
      description: |
        A short description of the status.
      type: string

    - name: CONTEXT
      description: |
        The GitHub context, A string label to differentiate this status from
        the status of other systems. ie: "continuous-integration/tekton"
      default: "continuous-integration/tekton"
      type: string

    - name: STATE
      description: |
        The state of the status. Can be one of the following `error`,
        `failure`, `pending`, or `success`.
      type: string

    - name: AUTH_TYPE
      description: |
        The type of authentication to use. You could use the less secure "Basic" for example
      type: string
      default: Bearer

    - name: IMAGE
      description: |
        Image providing the python binary which this task uses.
      type: string
      default: python:3.10.1-alpine3.15

    - name: SHEBANG
      description: |
        Python path. Depends on the image.
      type: string
      default: /usr/bin/env python

  volumes:
    - name: githubtoken
      secret:
        secretName: $(params.GITHUB_TOKEN_SECRET_NAME)

  steps:
    - name: set-status
      volumeMounts:
        - name: githubtoken
          mountPath: /etc/github-set-status
      env:
        - name: GITHUB_HOST_URL
          value: $(params.GITHUB_HOST_URL)
        - name: API_PATH_PREFIX
          value: $(params.API_PATH_PREFIX)
        - name: REPO_FULL_NAME
          value: $(params.REPO_FULL_NAME)
        - name: GITHUB_TOKEN_SECRET_NAME
          value: $(params.GITHUB_TOKEN_SECRET_NAME)
        - name: GITHUB_TOKEN_SECRET_KEY
          value: $(params.GITHUB_TOKEN_SECRET_KEY)
        - name: SHA
          value: $(params.SHA)
        - name: TARGET_URL
          value: $(params.TARGET_URL)
        - name: DESCRIPTION
          value: $(params.DESCRIPTION)
        - name: CONTEXT
          value: $(params.CONTEXT)
        - name: STATE
          value: $(params.STATE)
        - name: AUTH_TYPE
          value: $(params.AUTH_TYPE)
        - name: SHEBANG
          value: $(params.SHEBANG)

      image: $(params.IMAGE)
      script: |
        #!$(params.SHEBANG)

        """This script will set the CI status on GitHub PR"""

        import json
        import os
        import sys
        import http.client

        github_token_filename = "/etc/github-set-status/" + \
            os.getenv("GITHUB_TOKEN_SECRET_KEY")
        github_token = open(github_token_filename, "r").read()

        status_url = os.getenv("API_PATH_PREFIX") + "/repos/" + \
            os.getenv("REPO_FULL_NAME") + "/statuses/" + os.getenv("SHA")

        data = {
            "state": os.getenv("STATE"),
            "target_url": os.getenv("TARGET_URL"),
            "description": os.getenv("DESCRIPTION"),
            "context": os.getenv("CONTEXT")
        }
        print("Sending this data to GitHub@{url}: ".format(
          url=os.getenv("GITHUB_HOST_URL")))
        print(data)

        authHeader = os.getenv("AUTH_TYPE") + " " + github_token

        # This is for our fake github server
        if "$(params.GITHUB_HOST_URL)".startswith("http://"):
          conn = http.client.HTTPConnection("$(params.GITHUB_HOST_URL)".replace("http://", ""))
        else:
          conn = http.client.HTTPSConnection("$(params.GITHUB_HOST_URL)")

        conn.request(
            "POST",
            status_url,
            body=json.dumps(data),
            headers={
                "User-Agent": "TektonCD, the peaceful cat",
                "Authorization": authHeader,
                "Accept": "application/vnd.github.v3+json ",
            })
        resp = conn.getresponse()
        if not str(resp.status).startswith("2"):
            print("Error: %d" % (resp.status))
            print(resp.read())
            sys.exit(1)
        else:
            print("GitHub status '{state}' has been set on {repo}#{sha} ".format(
                state=os.getenv("STATE"),
                repo=os.getenv("REPO_FULL_NAME"),
                sha=os.getenv("SHA")))
---
# Source: edp-tekton/templates/tasks/gitlab-set-status.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: gitlab-set-status
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Git
    tekton.dev/tags: gitlab, git
    tekton.dev/displayName: "Set Gitlab commit status"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This task will set the status of the CI job to the specified value along
    with a link to the specified target URL where developers can follow the
    progress of the CI job.

    The `gitlab-set-status` task allows external services to mark GitLab commits
    with an `error`, `failure`, `pending`, or `success` state, which is then
    reflected in merge requests involving those commits. Statuses include as well a
    `description` and a `target_url`, to give the user informations about the CI
    statuses or a direct link to the full log.

  params:
    - name: GITLAB_HOST_URL
      description: |
        The GitLab host, adjust this if you run a GitLab enterprise. In EDP we use git_ssh_url
        value from the event payload, format: "git@example.com:mike/diaspora.git"
      default: "gitlab.com"
      type: string

    - name: API_PATH_PREFIX
      description: |
        The API path prefix, GitLab Enterprise has a prefix e.g. /api/v4
      default: "/api/v4"
      type: string

    - name: REPO_FULL_NAME
      description: |
        The GitLab repository full name, e.g.: tektoncd/catalog
      type: string

    - name: GITLAB_TOKEN_SECRET_NAME
      description: |
        The name of the kubernetes secret that contains the GitLab token, default: gitlab-api-secret
      type: string
      default: gitlab-api-secret

    - name: GITLAB_TOKEN_SECRET_KEY
      description: |
        The key within the kubernetes secret that contains the GitLab token, default: token
      type: string
      default: token

    - name: SHA
      description: |
        Commit SHA to set the status for.
      type: string

    - name: TARGET_URL
      description: |
        The target URL to associate with this status. This URL will be linked
        from the GitLab UI to allow users to easily see the source of the
        status.
      type: string

    - name: DESCRIPTION
      description: |
        A short description of the status.
      type: string

    - name: CONTEXT
      description: |
        The GitLab context, A string label to differentiate this status from
        the status of other systems. ie: "continuous-integration/tekton"
      default: "continuous-integration/tekton"
      type: string

    - name: STATE
      description: |
        The state of the status. Can be one of the following `pending`,
        `running`, `success`, `failed`, or `canceled`.
      type: string

  steps:
    - name: set-status
      image: registry.access.redhat.com/ubi8/python-38@sha256:af6f93b81f9313de95966e8cd681edb9dbcb5fdbddc5a4cc365af8e4534096ef
      script: |
        #!/usr/libexec/platform-python

        import os
        import sys
        import json
        import http.client
        import urllib.parse

        GITLAB_TOKEN = os.getenv("GITLAB_TOKEN")
        GITLAB_HOST_URL = "ssh://$(params.GITLAB_HOST_URL)"
        API_PATH_PREFIX = "$(params.API_PATH_PREFIX)"
        REPO_FULL_NAME = "$(params.REPO_FULL_NAME)"
        SHA = "$(params.SHA)"
        STATE = "$(params.STATE)"
        CONTEXT = "$(params.CONTEXT)"
        TARGET_URL = "$(params.TARGET_URL)"
        DESCRIPTION = "$(params.DESCRIPTION)"

        headers = {
            "User-Agent": "TektonCD, the peaceful cat",
            "Authorization": f"Bearer {GITLAB_TOKEN}",
        }

        URLENCODED_REPO_NAME = urllib.parse.quote(REPO_FULL_NAME, safe="")

        params = {
            "state": STATE,
            "context": CONTEXT,
            "target_url": TARGET_URL,
            "description": DESCRIPTION
        }

        encoded_params = urllib.parse.urlencode(params)

        api_url = f"{API_PATH_PREFIX}/projects/{URLENCODED_REPO_NAME}/statuses/{SHA}?{encoded_params}"

        # we need to adapt to EDP approach and extract the host from the git_ssh_url
        # which is in the format: git@example.com:mike/diaspora.git
        GITLAB_HOST_URL = urllib.parse.urlparse(GITLAB_HOST_URL).hostname

        print(f"POST to {GITLAB_HOST_URL}{api_url}")

        if GITLAB_HOST_URL.startswith("http://"):
            conn = http.client.HTTPConnection(GITLAB_HOST_URL[7:])
        elif GITLAB_HOST_URL.startswith("https://"):
            conn = http.client.HTTPSConnection(GITLAB_HOST_URL[8:])
        else:
            conn = http.client.HTTPSConnection(GITLAB_HOST_URL)
        try:
            conn.request("POST", api_url, headers=headers)

            resp = conn.getresponse()
            if not str(resp.status).startswith("2"):
                print(f"{resp.status} | Unable to set status")
                response_data = json.dumps(json.loads(resp.read()), indent=4)
                print(response_data)
                sys.exit(1)
            else:
                print(f"Just set status of {REPO_FULL_NAME}#{SHA} to {STATE}")
        finally:
            conn.close()

      env:
        - name: GITLAB_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.GITLAB_TOKEN_SECRET_NAME)
              key: $(params.GITLAB_TOKEN_SECRET_KEY)
---
# Source: edp-tekton/templates/tasks/go.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: golang
  labels:
    app.kubernetes.io/version: "0.3"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/displayName: "golang build"
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This Task is Golang task to build Go projects.
  params:
    - name: GOOS
      description: "running program's operating system target"
      default: linux
      type: string
    - name: GOARCH
      description: "running program's architecture target"
      default: amd64
      type: string
    - name: GO111MODULE
      description: "value of module support"
      default: auto
      type: string
    - name: GOCACHE
      description: "Go caching directory path"
      default: "$(workspaces.source.path)/cache"
      type: string
    - name: GOMODCACHE
      description: "Go mod caching directory path"
      default: "$(workspaces.source.path)/cache"
      type: string
    - name: CGO_ENABLED
      description: "Toggle cgo tool during Go build. Use value '0' to disable cgo (for static builds)."
      default: '0'
      type: string
    - name: GOSUMDB
      description: "Go checksum database url. Use value 'off' to disable checksum validation."
      default: ""
      type: string
    - name: EXTRA_COMMANDS
      type: string
      description: Extra commands
      default: ""
    - name: BASE_IMAGE
      description: "Base image"
      default: "golang:1.22-bookworm"
      type: string
    - name: GOPROXY
      description: "Go proxy server"
      default: ""
      type: string
  workspaces:
    - name: source

  steps:
    - name: golang
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)

      script: |
        set -ex
        $(params.EXTRA_COMMANDS)
      env:
        - name: GOOS
          value: "$(params.GOOS)"
        - name: GOARCH
          value: "$(params.GOARCH)"
        - name: GO111MODULE
          value: "$(params.GO111MODULE)"
        - name: GOCACHE
          value: "$(params.GOCACHE)"
        - name: GOMODCACHE
          value: "$(params.GOMODCACHE)"
        - name: CGO_ENABLED
          value: "$(params.CGO_ENABLED)"
        - name: GOSUMDB
          value: "$(params.GOSUMDB)"
        - name: GOPROXY
          value: "$(params.GOPROXY)"
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/gradle.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: gradle
  labels:
    app.kubernetes.io/version: "0.2"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/displayName: Gradle
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This Task can be used to run a Gradle build.

  workspaces:
    - name: source
      description: The workspace consisting of the gradle project.
  params:
    - name: BASE_IMAGE
      description: Gradle base image.
      type: string
      default: gradle:7.5.1-jdk11
    - name: PROJECT_DIR
      description: The directory containing build.gradle
      type: string
      default: "."
    - name: ci-nexus
      type: string
      description: name of the secret for the Nexus integration
      default: ci-nexus
    - name: ci-sonarqube
      type: string
      description: name of the secret for the Sonarqube integration
      default: "ci-sonarqube"
    - name: EXTRA_ARGS
      description: Extra arguments to add to the gradle build
      default: |
        -Dorg.gradle.internal.publish.checksums.insecure=true \
        publish
  volumes:
    - name: settings-gradle
      configMap:
        name: custom-gradle-settings
  steps:
    - name: gradle-tasks
      image: $(params.BASE_IMAGE)
      volumeMounts:
        - name: settings-gradle
          mountPath: /var/configmap
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      script: |
        #!/bin/bash
        set -e

        gradle \
          -I \
          /var/configmap/init.gradle \
          -PnexusLogin=${CI_USERNAME} \
          -PnexusPassword=${CI_PASSWORD} \
          $(params.EXTRA_ARGS)
      env:
        - name: XDG_CONFIG_HOME
          value: $(workspaces.source.path)/$(params.PROJECT_DIR)
        - name: GRADLE_USER_HOME
          value: $(workspaces.source.path)/$(params.PROJECT_DIR)
        - name: SONAR_USER_HOME
          value: $(workspaces.source.path)/$(params.PROJECT_DIR)
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: token
        - name: SONAR_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: url
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
        - name: SNAPSHOTS_REPO_PATH
          valueFrom:
            configMapKeyRef:
              name: custom-gradle-settings
              key: SNAPSHOTS_REPO_PATH
              optional: true
        - name: RELEASES_REPO_PATH
          valueFrom:
            configMapKeyRef:
              name: custom-gradle-settings
              key: RELEASES_REPO_PATH
              optional: true
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/hadolint.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  annotations:
    tekton.dev/categories: Code Quality
    tekton.dev/displayName: Hadolint
    tekton.dev/pipelines.minVersion: 0.12.1
    tekton.dev/platforms: linux/amd64
    tekton.dev/tags: 'Kubernetes, Misconfiguration'
  name: hadolint
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  description: >-
    This task makes it possible to use Hadolint within Tekton Pipeline.
    A smarter Dockerfile linter that helps you build best practice Docker
    images. The linter parses the Dockerfile into an AST and performs rules on
    top of the AST
  params:
    - name: BASE_IMAGE
      description: The base image for the task.
      default: ghcr.io/hadolint/hadolint:v2.12.0-alpine@sha256:3c206a451cec6d486367e758645269fd7d696c5ccb6ff59d8b03b0e45268a199
    - default: './Dockerfile'
      description: Dockerfile path.
      name: dockerfile-path
      type: string
    - default: tty
      description: >-
        The output format for the results [tty | json | checkstyle | codeclimate
        | gitlab_codeclimate | codacy] (default tty).
      name: output-format
      type: string
  workspaces:
    - description: A workspace that contains fetched git repo.
      name: source
  steps:
    - image: $(params.BASE_IMAGE)
      name: lint-dockerfile
      workingDir: $(workspaces.source.path)
      env:
        - name: DOCKERFILE
          value: "$(params.dockerfile-path)"
        - name: OFORMAT
          value: "$(params.output-format)"
      script: |
        set -e
        hadolint "$DOCKERFILE" -f "$OFORMAT"
---
# Source: edp-tekton/templates/tasks/helm-dependency-update.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: helm-dependency-update
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/categories: CI
    tekton.dev/pipelines.minVersion: "0.41.0"
    tekton.dev/tags: helm
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This task will update dependencies of a helm chart
  workspaces:
    - description: A workspace that contains fetched git repo.
      name: source
  params:
    - name: CHART_DIR
      description: The directory in source that contains the helm chart
      default: "."
    - name: extra_params
      description: "Extra parameters passed for the helm dependency build command"
      default: ""
    - name: helm_image
      description: "Specify a specific helm image"
      default: "alpine/helm:3.11.1"
    - name: user_home
      description: |
        Absolute path to the user's home directory. Set this explicitly if you are running the image as a non-root user
      type: string
      default: "/tekton/home"
  steps:
    - name: helm
      image: $(params.helm_image)
      workingDir: $(workspaces.source.path)
      env:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: EXTRA_PARAMS
          value: $(params.extra_params)
        - name: HOME
          value: $(params.user_home)
      script: |
        set -ex

        helm dependency update ${CHART_DIR} ${EXTRA_PARAMS}
---
# Source: edp-tekton/templates/tasks/helm-docs.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: helm-docs
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/categories: CI
    tekton.dev/pipelines.minVersion: "0.41.0"
    tekton.dev/tags: helm
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This task will run `helm-docs` command for helm chart
  workspaces:
    - description: A workspace that contains fetched git repo.
      name: source
  params:
    - name: CHART_DIR
      description: The directory in source that contains the helm chart
      default: "."
    - name: helm_docs_image
      description: "Specify a specific helm-docs image"
      default: "jnorwood/helm-docs:v1.13.1"
    - name: user_home
      description: |
        Absolute path to the user's home directory. Set this explicitly if you are running the image as a non-root user
      type: string
      default: "/tekton/home"
  steps:
    - name: helm-docs
      image: $(params.helm_docs_image)
      workingDir: $(workspaces.source.path)
      env:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: HOME
          value: $(params.user_home)
      script: |
        set -ex

        README_FILE_PATH="${CHART_DIR}/README.md"
        if [ -f "${README_FILE_PATH}" ]; then
            echo "[TEKTON][INFO] The file has been found at the given location \"${README_FILE_PATH}\""
        else
            echo "[TEKTON][ERROR] The file has not been found at the given location \"${README_FILE_PATH}\""
            exit 1
        fi

        helm-docs --chart-search-root ${CHART_DIR}
    - name: validate-helm-docs
      image: bitnami/git:2.41.0
      workingDir: $(workspaces.source.path)
      env:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: HOME
          value: $(params.user_home)
      script: |
        set -ex

        git config --global --add safe.directory $(pwd)
        git diff -s --exit-code ${CHART_DIR}/README.md || (echo "Run 'helm-docs' to address the issue." && git diff && exit 1)
---
# Source: edp-tekton/templates/tasks/helm-libraries/helm-dependency-update-lib.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: helm-library-dependency-update
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/categories: CI
    tekton.dev/pipelines.minVersion: "0.41.0"
    tekton.dev/tags: helm
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This task will update dependencies of a helm chart
  workspaces:
    - description: A workspace that contains fetched git repo.
      name: source
  params:
    - name: CHART_DIR
      description: The directory in source that contains the helm chart
      default: "."
    - name: extra_params
      description: "Extra parameters passed for the helm dependency build command"
      default: ""
    - name: helm_image
      description: "Specify a specific helm image"
      default: "alpine/helm:3.11.1"
    - name: user_home
      description: |
        Absolute path to the user's home directory. Set this explicitly if you are running the image as a non-root user
      type: string
      default: "/tekton/home"
  steps:
    - name: helm
      image: $(params.helm_image)
      workingDir: $(workspaces.source.path)
      env:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: EXTRA_PARAMS
          value: $(params.extra_params)
        - name: HOME
          value: $(params.user_home)
      script: |
        #!/bin/bash
        set -ex

        chart_directory=(${CHART_DIR}/*)
        for i in "${chart_directory[@]}"
        do
            helm dependency update $i ${EXTRA_PARAMS}
        done
---
# Source: edp-tekton/templates/tasks/helm-libraries/helm-docs-lib.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: helm-library-docs
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/categories: CI
    tekton.dev/pipelines.minVersion: "0.41.0"
    tekton.dev/tags: helm
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This task will run `helm-docs` command for helm chart
  workspaces:
    - description: A workspace that contains fetched git repo.
      name: source
  params:
    - name: CHART_DIR
      description: The directory in source that contains the helm chart
      default: "."
    - name: helm_docs_image
      description: "Specify a specific helm-docs image"
      default: "jnorwood/helm-docs:v1.13.1"
    - name: user_home
      description: |
        Absolute path to the user's home directory. Set this explicitly if you are running the image as a non-root user
      type: string
      default: "/tekton/home"
  steps:
    - name: helm-docs
      image: $(params.helm_docs_image)
      workingDir: $(workspaces.source.path)
      env:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: HOME
          value: $(params.user_home)
      script: |
        set -ex

        chart_directory=$(ls -1 ${CHART_DIR}/)
        for i in ${chart_directory}
        do
            README_FILE_PATH="${CHART_DIR}/${i}/README.md"
            if [ -f "${README_FILE_PATH}" ]; then
                echo "[TEKTON][INFO] The file has been found at the given location \"${README_FILE_PATH}\""
            else
                echo "[TEKTON][ERROR] The file has not been found at the given location \"${README_FILE_PATH}\""
                exit 1
            fi
        done

        helm-docs --chart-search-root ${CHART_DIR}

    - name: validate-helm-docs
      image: bitnami/git:2.41.0
      workingDir: $(workspaces.source.path)
      env:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: HOME
          value: $(params.user_home)
      script: |
        set -ex

        git config --global --add safe.directory $(pwd)

        chart_directory=$(ls -1 ${CHART_DIR}/)
        for i in ${chart_directory}
        do
            git diff -s --exit-code ${CHART_DIR}/${i}/README.md || (echo "Run 'helm-docs' to address the issue." && git diff && exit 1)
        done
---
# Source: edp-tekton/templates/tasks/helm-libraries/helm-lint-lib.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  annotations:
    tekton.dev/categories: Code Quality
    tekton.dev/displayName: Helm-Lint
    tekton.dev/pipelines.minVersion: 0.12.1
    tekton.dev/platforms: linux/amd64
  name: helm-library-lint
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  params:
    - name: BASE_IMAGE
      description: The base image for the task.
      default: quay.io/helmpack/chart-testing:v3.10.1
      type: string
    - name: EXTRA_COMMANDS
      description: Arguments to add to the helm-lint step
      default: ""
      type: string
    - name: USER_HOME
      description: |
        Absolute path to the user's home directory. Set this explicitly if you are running the image as a non-root user
      type: string
      default: "/tekton/home"
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
      type: string
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
      type: string
    - name: CHART_VERSION_INCREMENT
      description: "Check version increment"
      default: 'false'
      type: string
    - name: TARGET_BRANCH
      description: "Git branch"
      default: "master"
      type: string
  workspaces:
    - description: A workspace that contains fetched git repo.
      name: source
  volumes:
    - name: ct-config-volume
      configMap:
        name: ct-config
  steps:
    - image: $(params.BASE_IMAGE)
      name: helm-lint
      workingDir: $(workspaces.source.path)
      env:
        - name: HOME
          value: $(params.USER_HOME)
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
        - name: CT_CONFIGS_DIR_DEFAULT
          value: "ct-configs"
      script: |
        set -ex
        $(params.EXTRA_COMMANDS)

        CT_FILE_PATH=""
        LINTCONF_FILE_PATH=""
        CHART_SCHEMA_FILE_PATH=""

        if [ -f "${CT_CONFIGS_DIR}/ct.yaml" ]; then
            CT_FILE_PATH="${CT_CONFIGS_DIR}/ct.yaml"
        else
            CT_FILE_PATH="${CT_CONFIGS_DIR_DEFAULT}/ct.yaml"
        fi

        if [ -f "${CT_CONFIGS_DIR}/lintconf.yaml" ]; then
            LINTCONF_FILE_PATH="${CT_CONFIGS_DIR}/lintconf.yaml"
        else
            LINTCONF_FILE_PATH="${CT_CONFIGS_DIR_DEFAULT}/lintconf.yaml"
        fi

        if [ -f "${CT_CONFIGS_DIR}/chart_schema.yaml" ]; then
            CHART_SCHEMA_FILE_PATH="${CT_CONFIGS_DIR}/chart_schema.yaml"
        else
            CHART_SCHEMA_FILE_PATH="${CT_CONFIGS_DIR_DEFAULT}/chart_schema.yaml"
        fi

        echo "[TEKTON][INFO] Specific charts to test are located at \"${CT_FILE_PATH}\""
        echo "[TEKTON][INFO] The config file for YAML linting is located at \"${LINTCONF_FILE_PATH}\""
        echo "[TEKTON][INFO] The schema for chart.yml validation is located at \"${CHART_SCHEMA_FILE_PATH}\""

        git config --global --add safe.directory $(pwd)

        ct lint \
        --debug \
        --target-branch $(params.TARGET_BRANCH) \
        --config ${CT_FILE_PATH} \
        --lint-conf ${LINTCONF_FILE_PATH} \
        --chart-yaml-schema ${CHART_SCHEMA_FILE_PATH} \
        --check-version-increment=$(params.CHART_VERSION_INCREMENT)

      volumeMounts:
        - name: ct-config-volume
          mountPath: /workspace/source/ct-configs/
---
# Source: edp-tekton/templates/tasks/helm-libraries/helm-push-lib.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: helm-push-lib
spec:
  description: |
    This Task allows Uset to push a new version of the Helm Chart
    to the repository with Snapshot versions.
  workspaces:
    - name: source
      description: A workspace that contains the repository.
  volumes:
    - name: dockerconfig
      secret:
        secretName: kaniko-docker-config
        items:
          - key: .dockerconfigjson
            path: config.json
        optional: true
  params:
    - name: chart-dir
      description: The directory in source that contains the helm chart
      default: "."
  steps:
    - name: init-repository
      image: amazon/aws-cli:2.7.35
      workingDir: $(workspaces.source.path)
      env:
        - name: AWS_DEFAULT_REGION
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: aws_region
              optional: true
        - name: CHART_DIR
          value: $(params.chart-dir)
        - name: CONTAINER_REGISTRY_SPACE
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: container_registry_space
        - name: CONTAINER_REGISTRY_TYPE
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: container_registry_type
      script: |
          #!/bin/bash

          set -ex

          if [[ "$CONTAINER_REGISTRY_TYPE" == "ecr" ]]; then
            chart_directory=(${CHART_DIR}/*)
            for i in "${chart_directory[@]}"
            do
                REPO_NAME=$(awk '/^name:/ {print $2}' ${i}/Chart.yaml)
            aws ecr describe-repositories --repository-names "${CONTAINER_REGISTRY_SPACE}/${REPO_NAME}" || aws ecr create-repository --repository-name "${CONTAINER_REGISTRY_SPACE}/${REPO_NAME}";
            done

          else
            echo 'Registry not ECR, stage skipped';
          fi

    - name: push-helm-chart
      image: alpine/k8s:1.25.15
      workingDir: $(workspaces.source.path)
      env:
        - name: CHART_DIR
          value: $(params.chart-dir)
        - name: AWS_DEFAULT_REGION
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: aws_region
              optional: true
        - name: CONTAINER_REGISTRY_URL
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: container_registry_host
        - name: CONTAINER_REGISTRY_SPACE
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: container_registry_space
        - name: CONTAINER_REGISTRY_TYPE
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: container_registry_type
        - name: PLATFORM
          valueFrom:
            configMapKeyRef:
              key: platform
              name: edp-config
      script: |
        #!/bin/bash
        set -ex

        helm_push_command="helm push *-*.tgz oci://${CONTAINER_REGISTRY_URL}/${CONTAINER_REGISTRY_SPACE}"

        if [ $CONTAINER_REGISTRY_TYPE != "ecr" ]; then
          helm_push_command+=" --registry-config /.config/helm/registry/config.json"
        fi

        if [ $PLATFORM == "openshift" ]; then
          helm_push_command+=" --insecure-skip-tls-verify"
        fi

        if [ $CONTAINER_REGISTRY_TYPE == "ecr" ]; then
          aws ecr get-login-password --region ${AWS_DEFAULT_REGION} | helm registry login --username AWS --password-stdin ${CONTAINER_REGISTRY_URL}
        fi

        chart_directory=(${CHART_DIR}/*)
        for i in "${chart_directory[@]}"
        do
            if ! git diff --quiet HEAD^ HEAD -- $i; then
                helm package ${i}
                $helm_push_command
                rm *-*.tgz
            fi
        done

      # Adding this securityContext makes it explicit that it needs to run as root.
      # Required for Openshift.
      securityContext:
        runAsUser: 0
      # This secret mount is necessary for helm push to internal openshift registry
      volumeMounts:
        - mountPath: /.config/helm/registry
          name: dockerconfig
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/helm-libraries/helm-template-lib.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: helm-library-template
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/categories: CI
    tekton.dev/pipelines.minVersion: "0.41.0"
    tekton.dev/tags: helm
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This task will run `helm template` command for helm chart
  workspaces:
    - description: A workspace that contains fetched git repo.
      name: source
  params:
    - name: CHART_DIR
      description: The directory in source that contains the helm chart
      default: "."
    - name: release_name
      description: The helm release name
      default: "helm-release"
    - name: template_extra_params
      description: "Extra parameters passed for the helm template command"
      default: ""
    - name: extra_commands
      description: Arguments to add to the helm-lint step
      default: ""
    - name: helm_image
      description: "Specify a specific helm image"
      default: "alpine/helm:3.11.1"
    - name: user_home
      description: |
        Absolute path to the user's home directory. Set this explicitly if you are running the image as a non-root user
      type: string
      default: "/tekton/home"
  steps:
    - name: helm
      image: $(params.helm_image)
      workingDir: $(workspaces.source.path)
      env:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: RELEASE_NAME
          value: $(params.release_name)
        - name: TEMPLATE_EXTRA_PARAMS
          value: $(params.template_extra_params)
        - name: HOME
          value: $(params.user_home)
      script: |
        #!/bin/bash
        set -ex

        chart_directory=(${CHART_DIR}/*)
        for i in "${chart_directory[@]}"
        do
            helm template ${RELEASE_NAME} ${i} ${TEMPLATE_EXTRA_PARAMS}
            $(params.extra_commands)
        done
---
# Source: edp-tekton/templates/tasks/helm-lint.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  annotations:
    tekton.dev/categories: Code Quality
    tekton.dev/displayName: Helm-Lint
    tekton.dev/pipelines.minVersion: 0.12.1
    tekton.dev/platforms: linux/amd64
  name: helm-lint
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  params:
    - name: BASE_IMAGE
      description: The base image for the task.
      default: quay.io/helmpack/chart-testing:v3.10.1
    - name: EXTRA_COMMANDS
      description: Arguments to add to the helm-lint step
      default: ""
    - name: USER_HOME
      description: |
        Absolute path to the user's home directory. Set this explicitly if you are running the image as a non-root user
      type: string
      default: "/tekton/home"
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  workspaces:
    - description: A workspace that contains fetched git repo.
      name: source
  volumes:
    - name: ct-config-volume
      configMap:
        name: ct-config
  steps:
    - image: $(params.BASE_IMAGE)
      name: helm-lint
      workingDir: $(workspaces.source.path)
      env:
        - name: HOME
          value: $(params.USER_HOME)
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
        - name: CT_CONFIGS_DIR_DEFAULT
          value: "ct-configs"
      script: |
        set -ex
        $(params.EXTRA_COMMANDS)

        CT_FILE_PATH=""
        LINTCONF_FILE_PATH=""
        CHART_SCHEMA_FILE_PATH=""

        if [ -f "${CT_CONFIGS_DIR}/ct.yaml" ]; then
            CT_FILE_PATH="${CT_CONFIGS_DIR}/ct.yaml"
        else
            CT_FILE_PATH="${CT_CONFIGS_DIR_DEFAULT}/ct.yaml"
        fi

        if [ -f "${CT_CONFIGS_DIR}/lintconf.yaml" ]; then
            LINTCONF_FILE_PATH="${CT_CONFIGS_DIR}/lintconf.yaml"
        else
            LINTCONF_FILE_PATH="${CT_CONFIGS_DIR_DEFAULT}/lintconf.yaml"
        fi

        if [ -f "${CT_CONFIGS_DIR}/chart_schema.yaml" ]; then
            CHART_SCHEMA_FILE_PATH="${CT_CONFIGS_DIR}/chart_schema.yaml"
        else
            CHART_SCHEMA_FILE_PATH="${CT_CONFIGS_DIR_DEFAULT}/chart_schema.yaml"
        fi

        echo "[TEKTON][INFO] Specific charts to test are located at \"${CT_FILE_PATH}\""
        echo "[TEKTON][INFO] The config file for YAML linting is located at \"${LINTCONF_FILE_PATH}\""
        echo "[TEKTON][INFO] The schema for chart.yml validation is located at \"${CHART_SCHEMA_FILE_PATH}\""

        ct lint \
        --charts ${CHART_DIR}/ \
        --config ${CT_FILE_PATH} \
        --lint-conf ${LINTCONF_FILE_PATH} \
        --chart-yaml-schema ${CHART_SCHEMA_FILE_PATH}

      volumeMounts:
        - name: ct-config-volume
          mountPath: /workspace/source/ct-configs/
---
# Source: edp-tekton/templates/tasks/helm-push.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: helm-push
spec:
  description: |
    This Task allows Uset to push a new version of the Helm Chart
    to the repository with Snapshot versions.
  workspaces:
    - name: source
      description: A workspace that contains the repository.
  volumes:
    - name: dockerconfig
      secret:
        secretName: kaniko-docker-config
        items:
          - key: .dockerconfigjson
            path: config.json
        optional: true
  params:
    - name: image-tag
      description: Image tag
    - name: chart-dir
      description: The directory in source that contains the helm chart
      default: "."
  steps:
    - name: init-repository
      image: amazon/aws-cli:2.7.35
      workingDir: $(workspaces.source.path)
      env:
        - name: AWS_DEFAULT_REGION
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: aws_region
              optional: true
        - name: CHART_DIR
          value: $(params.chart-dir)
        - name: CONTAINER_REGISTRY_SPACE
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: container_registry_space
        - name: CONTAINER_REGISTRY_TYPE
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: container_registry_type
      script: |
          if [[ "$CONTAINER_REGISTRY_TYPE" == "ecr" ]]; then
            REPO_NAME=$(awk '/^name:/ {print $2}' ${CHART_DIR}/Chart.yaml)
            aws ecr describe-repositories --repository-names "${CONTAINER_REGISTRY_SPACE}/${REPO_NAME}" || aws ecr create-repository --repository-name "${CONTAINER_REGISTRY_SPACE}/${REPO_NAME}";
          else
            echo 'Registry not ECR, stage skipped';
          fi

    - name: push-helm-chart
      image: alpine/k8s:1.25.15
      workingDir: $(workspaces.source.path)
      env:
        - name: IMAGE_TAG
          value: "$(params.image-tag)"
        - name: CHART_DIR
          value: $(params.chart-dir)
        - name: AWS_DEFAULT_REGION
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: aws_region
              optional: true
        - name: CONTAINER_REGISTRY_TYPE
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: container_registry_type
        - name: CONTAINER_REGISTRY_URL
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: container_registry_host
        - name: CONTAINER_REGISTRY_SPACE
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: container_registry_space
        - name: PLATFORM
          valueFrom:
            configMapKeyRef:
              key: platform
              name: edp-config
      script: |
        #!/bin/bash

        set -ex

        helm package ${CHART_DIR} --version ${IMAGE_TAG}

        helm_push_command="helm push *-${IMAGE_TAG}.tgz oci://${CONTAINER_REGISTRY_URL}/${CONTAINER_REGISTRY_SPACE}"


        if [ $CONTAINER_REGISTRY_TYPE != "ecr" ]; then
          helm_push_command+=" --registry-config /.config/helm/registry/config.json"
        fi

        if [ $PLATFORM == "openshift" ]; then
          helm_push_command+=" --insecure-skip-tls-verify"
        fi

        if [ $CONTAINER_REGISTRY_TYPE == "ecr" ]; then
          aws ecr get-login-password --region ${AWS_DEFAULT_REGION} | helm registry login --username AWS --password-stdin ${CONTAINER_REGISTRY_URL}
        fi

        $helm_push_command

      # Adding this securityContext makes it explicit that it needs to run as root.
      # Required for Openshift.
      securityContext:
        runAsUser: 0
      # This secret mount is necessary for helm push to internal openshift registry
      volumeMounts:
        - mountPath: /.config/helm/registry
          name: dockerconfig
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/helm-template.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: helm-template
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/categories: CI
    tekton.dev/pipelines.minVersion: "0.41.0"
    tekton.dev/tags: helm
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This task will run `helm template` command for helm chart
  workspaces:
    - description: A workspace that contains fetched git repo.
      name: source
  params:
    - name: CHART_DIR
      description: The directory in source that contains the helm chart
      default: "."
    - name: release_name
      description: The helm release name
      default: "helm-release"
    - name: template_extra_params
      description: "Extra parameters passed for the helm template command"
      default: ""
    - name: extra_commands
      description: Arguments to add to the helm-lint step
      default: ""
    - name: helm_image
      description: "Specify a specific helm image"
      default: "alpine/helm:3.11.1"
    - name: user_home
      description: |
        Absolute path to the user's home directory. Set this explicitly if you are running the image as a non-root user
      type: string
      default: "/tekton/home"
  steps:
    - name: helm
      image: $(params.helm_image)
      workingDir: $(workspaces.source.path)
      env:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: RELEASE_NAME
          value: $(params.release_name)
        - name: TEMPLATE_EXTRA_PARAMS
          value: $(params.template_extra_params)
        - name: HOME
          value: $(params.user_home)
      script: |
        set -ex

        helm template ${RELEASE_NAME} ${CHART_DIR} ${TEMPLATE_EXTRA_PARAMS}
        $(params.extra_commands)
---
# Source: edp-tekton/templates/tasks/image-scan.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: image-scan
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task can be used to scan images for vulnerabilites
  workspaces:
    - name: source
  params:
    - name: IMAGE
      description: Name (reference) of the image.
    - name: IMAGE_TAR
      description: Name (reference) of the image tar package.
    - name: BASE_IMAGE_TRIVY
      type: string
      default: "aquasec/trivy:0.41.0"
    - name: BASE_IMAGE_GRYPE
      type: string
      default: "anchore/grype:v0.62.1-debug"
    - name: BASE_IMAGE_CURL
      type: string
      default: "alpine/curl:3.14"
    - name: PATH_CONTEXT
      description: The build context used by Trivy.
      default: "."
    - name: JUNIT_REPORT
      type: string
      description: "This configmap contains Trivy JUnit XML Go template"
      default: report-junit
    - name: TRIVY_REPORT
      type: string
      description: "Trivy report name"
      default: trivy-junit.tpl
    - name: GRYPE_REPORT
      type: string
      description: "Grype report name"
      default: grype-junit.tpl
    - name: RP_PROPERTIES
      type: string
      description: "This secret contains ReportPortal credentials"
      default: reportportal-properties
    - name: TRIVY_SCAN_REPORT
      type: string
      description: "This name of the scan report"
      default: "image-scan-trivy-report.xml"
    - name: GRYPE_SCAN_REPORT
      type: string
      description: "This name of the scan report"
      default: "image-scan-grype-report.xml"
  steps:
    - name: trivy
      image: $(params.BASE_IMAGE_TRIVY)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)
      env:
        - name: JUNIT_REPORT
          valueFrom:
            configMapKeyRef:
              name: $(params.JUNIT_REPORT)
              key: $(params.TRIVY_REPORT)
      script: |
        #!/usr/bin/env sh
        set -e

        echo "${JUNIT_REPORT}" > "$(params.TRIVY_REPORT)"
        trivy image --format template --template "@$(params.TRIVY_REPORT)" \
            -o $(params.TRIVY_SCAN_REPORT) --input $(params.IMAGE_TAR).tar
        cat $(params.TRIVY_SCAN_REPORT)

    - name: grype
      image: $(params.BASE_IMAGE_GRYPE)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)
      env:
        - name: JUNIT_REPORT
          valueFrom:
            configMapKeyRef:
              name: $(params.JUNIT_REPORT)
              key: $(params.GRYPE_REPORT)
      script: |
        #!/busybox/sh
        set -e

        echo "${JUNIT_REPORT}" > "$(params.GRYPE_REPORT)"
        /grype $(params.IMAGE_TAR).tar -o template \
            -t $(params.GRYPE_REPORT) > $(params.GRYPE_SCAN_REPORT)
        cat $(params.GRYPE_SCAN_REPORT)

    - name: upload-report
      image: $(params.BASE_IMAGE_CURL)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)
      env:
        - name: RP_ENDPOINT
          valueFrom:
            secretKeyRef:
              name: $(params.RP_PROPERTIES)
              key: rp.endpoint
        - name: RP_PROJECT
          valueFrom:
            secretKeyRef:
              name: $(params.RP_PROPERTIES)
              key: rp.project
        - name: RP_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.RP_PROPERTIES)
              key: rp.token
      script: |
        #!/usr/bin/env sh
        set -e
        apk add zip

        for REPORT_NAME in $(params.TRIVY_SCAN_REPORT) $(params.GRYPE_SCAN_REPORT)
        do
            REPORT_ARCHIVE_NAME="${REPORT_NAME}_$(params.IMAGE_TAR).zip"
            zip -r ${REPORT_ARCHIVE_NAME} ${REPORT_NAME}
            curl -X POST "https://${RP_ENDPOINT}/api/v1/${RP_PROJECT}/launch/import" \
                  -H  "accept: */*" \
                  -H  "Content-Type: multipart/form-data" \
                  -H  "Authorization: bearer ${RP_TOKEN}" \
                  -F "file=@${REPORT_ARCHIVE_NAME};type=application/x-zip-compressed"
        done
---
# Source: edp-tekton/templates/tasks/init-values.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: init-values
spec:
  params:
    - name: CODEBASE_NAME
      type: string
      description: Codebasebranch name.
      default: "CODEBASE_NAME_placeholder"
    - name: BRANCH_NAME
      type: string
      description: Branch name.
      default: "BRANCH_placeholder"
    - name: BASE_IMAGE
      description: The base image for the task.
      type: string
      default: bitnami/kubectl:1.25.2
  results:
    - name: TENANT_NAME
      description: "edp name"
    - name: NORMALIZED_BRANCH
      description: "Branch name without '/' symbols and lowercase"
    - name: RESULT_IMAGE_NAME
      description: "Codebase name with only letters and dashes"
  steps:
    - name: get-values
      image: $(params.BASE_IMAGE)
      env:
        - name: CODEBASE
          value: "$(params.CODEBASE_NAME)"
        - name: BRANCH
          value: "$(params.BRANCH_NAME)"
      script: |
        #!/usr/bin/env bash
        set -e

        tenantName=$(kubectl get cm edp-config -o jsonpath='{.data.edp_name}')
        echo "${tenantName}" | tr -d '\n' | tee $(results.TENANT_NAME.path)

        normalizedBranch=$(echo ${BRANCH//[^\(?!.)a-zA-Z0-9]/-} | tr '[:upper:]' '[:lower:]')
        printf "%s" "${normalizedBranch}" > "$(results.NORMALIZED_BRANCH.path)"

        resultImageName="${CODEBASE}-$(echo ${BRANCH//[^a-zA-Z0-9]/-} | tr '[:upper:]' '[:lower:]')"
        printf "%s" "${resultImageName}" > "$(results.RESULT_IMAGE_NAME.path)"
---
# Source: edp-tekton/templates/tasks/kaniko-dockerbuild-verify.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: dockerbuild-verify
  labels:
    app.kubernetes.io/based-on: "0.6"
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Image Build
    tekton.dev/tags: image-build
    tekton.dev/displayName: "Build and upload container image using Kaniko"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This Task builds a Dockerfile with kaniko.
  params:
    - name: codebase-name
      description: Name of codebase
      default: "placeholder"
    - name: image-tag
      description: Image tag
      default: "lastest"
    - name: image-tar
      description: Name (reference) of the image tar.
      default: "image_tar"
    - name: dockerfile
      description: Dockerfile name.
      default: "Dockerfile"
    - name: context
      description: The build context used by Kaniko.
      default: ./
      description: The build context used by Kaniko.
      default: ./
    - name: builder-image
      description: The image on which builds will run
      default: gcr.io/kaniko-project/executor:v1.12.1-debug
  workspaces:
    - name: source
      description: Holds the context and Dockerfile
    - name: dockerconfig
      description: Includes a docker `config.json`
      optional: true
      mountPath: /kaniko/.docker
  results:
    - name: IMAGE_DIGEST
      description: Digest of the image just built.
    - name: IMAGE_URL
      description: URL of the image just built.
  steps:
    - name: build-no-push
      workingDir: $(workspaces.source.path)
      image: "$(params.builder-image)"
      env:
        - name: CODEBASE_NAME
          value: "$(params.codebase-name)"
        - name: IMAGE_TAG
          value: "$(params.image-tag)"
        - name: IMAGE_TAR
          value: "$(params.image-tar)"
        - name: DOCKERFILE
          value: "$(params.dockerfile)"
        - name: CONTEXT
          value: "$(params.context)"
        - name: CONTAINER_REGISTRY_URL
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: container_registry_host
        - name: CONTAINER_REGISTRY_GROUP
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: container_registry_space
      script: |
        /kaniko/executor \
          --dockerfile=$(workspaces.source.path)/${DOCKERFILE} \
          --context=$(workspaces.source.path)/${CONTEXT} \
          --destination=${CONTAINER_REGISTRY_URL}/${CONTAINER_REGISTRY_GROUP}/${CODEBASE_NAME}:${IMAGE_TAG} \
          --digest-file=$(results.IMAGE_DIGEST.path) \
          --tar-path=${IMAGE_TAR}.tar \
          --no-push
      # kaniko assumes it is running as root, which means this example fails on platforms
      # that default to run containers as random uid (like OpenShift). Adding this securityContext
      # makes it explicit that it needs to run as root.
      securityContext:
        runAsUser: 0
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/kaniko.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: kaniko
  labels:
    app.kubernetes.io/based-on: "0.6"
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Image Build
    tekton.dev/tags: image-build
    tekton.dev/displayName: "Build and upload container image using Kaniko"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This Task builds a simple Dockerfile with kaniko and pushes to a registry.
    This Task stores the image name and digest as results, allowing Tekton Chains to pick up
    that an image was built & sign it.
  params:
    - name: codebase-name
      description: Name of codebase
    - name: image-tag
      description: Image tag
    - name: image-tar
      description: Name (reference) of the image tar.
      default: "image_tar"
    - name: dockerfile
      description: Dockerfile name.
      default: "Dockerfile"
    - name: context
      description: The build context used by Kaniko.
      default: ./
    - name: builder-image
      description: The image on which builds will run
      default: gcr.io/kaniko-project/executor:v1.12.1-debug
    - name: kaniko-cache-path
      description: The repo where Kaniko stores cached image layers
      default: ""
  workspaces:
    - name: source
      description: Holds the context and Dockerfile
  volumes:
    - name: dockerconfig
      secret:
        secretName: kaniko-docker-config
        items:
          - key: .dockerconfigjson
            path: config.json
        optional: true
  results:
    - name: IMAGE_DIGEST
      description: Digest of the image just built.
    - name: IMAGE_URL
      description: URL of the image just built.
  steps:
    - name: init-repository
      image: amazon/aws-cli:2.7.35
      env:
        - name: CODEBASE_NAME
          value: "$(params.codebase-name)"
        - name: AWS_DEFAULT_REGION
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: aws_region
              optional: true
        - name: CONTAINER_REGISTRY_GROUP
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: container_registry_space
        - name: CONTAINER_REGISTRY_TYPE
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: container_registry_type
      script: |
          if [[ "$CONTAINER_REGISTRY_TYPE" == "ecr" ]]; then
            aws ecr describe-repositories --repository-names "${CONTAINER_REGISTRY_GROUP}/${CODEBASE_NAME}" || aws ecr create-repository --repository-name "${CONTAINER_REGISTRY_GROUP}/${CODEBASE_NAME}";
          else
            echo 'Registry not ECR, stage skipped';
          fi

    - name: build-and-push
      workingDir: $(workspaces.source.path)
      image: "$(params.builder-image)"
      env:
        - name: CODEBASE_NAME
          value: "$(params.codebase-name)"
        - name: IMAGE_TAG
          value: "$(params.image-tag)"
        - name: IMAGE_TAR
          value: "$(params.image-tar)"
        - name: DOCKERFILE
          value: "$(params.dockerfile)"
        - name: CONTEXT
          value: "$(params.context)"
        - name: KANIKO_CACHE_PATH
          value: "$(params.kaniko-cache-path)"
        - name: CONTAINER_REGISTRY_URL
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: container_registry_host
        - name: CONTAINER_REGISTRY_SPACE
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: container_registry_space
        - name: PLATFORM
          valueFrom:
            configMapKeyRef:
              name: edp-config
              key: platform
      script: |
        base_command="/kaniko/executor \
          --dockerfile=/workspace/source/${DOCKERFILE} \
          --context=/workspace/source/${CONTEXT} \
          --destination=${CONTAINER_REGISTRY_URL}/${CONTAINER_REGISTRY_SPACE}/${CODEBASE_NAME}:${IMAGE_TAG} \
          --digest-file=/tekton/results/IMAGE_DIGEST \
          --tar-path=${IMAGE_TAR}.tar "

        kaniko_cache=" --cache=true \
                       --cache-repo=${CONTAINER_REGISTRY_URL}/${KANIKO_CACHE_PATH} "

        okd_skip_tls=" --skip-tls-verify "

        custom_certs=false

        command=$base_command

        if [ -n "$KANIKO_CACHE_PATH" ]; then
          command="$command $kaniko_cache";
        fi

        if [ $PLATFORM == "openshift" ]; then
          command="$command $okd_skip_tls";
        fi

        if [ "$custom_certs" == "true" ]; then
          command='$command $CONTAINER_REGISTRY_URL"=/kaniko/.custom-certs/ca.crt "';
        fi

        $command
      securityContext:
        runAsUser: 0
      volumeMounts:
        - name: dockerconfig
          mountPath: /kaniko/.docker
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
    - image: alpine:3.18.6
      name: write-url
      env:
        - name: CODEBASE_NAME
          value: "$(params.codebase-name)"
        - name: IMAGE_TAG
          value: "$(params.image-tag)"
        - name: CONTAINER_REGISTRY_URL
          valueFrom:
            configMapKeyRef:
              key: container_registry_host
              name: edp-config
        - name: CONTAINER_REGISTRY_SPACE
          valueFrom:
            configMapKeyRef:
              key: container_registry_space
              name: edp-config
      script: |
        set -e
        echo -n "${CONTAINER_REGISTRY_URL}/${CONTAINER_REGISTRY_SPACE}/${CODEBASE_NAME}:${IMAGE_TAG}" | tee "$(results.IMAGE_URL.path)"
---
# Source: edp-tekton/templates/tasks/maven-get-module.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: get-maven-module
spec:
  description: Get maven deployable multimodule directory name.
  workspaces:
    - name: source
      description: The workspace consisting of maven project.
  params:
    - name: BASE_IMAGE
      description: "The base image for the task"
      default: "alpine:3.18.6"
  results:
    - name: DEPLOYABLE_MODULE_DIR
      description: Maven deployable multimodule directory.
  steps:
    - name: get-maven-module
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      script: |
        set -ex

        DEPLOYABLE_MODULE=$(grep '<deployable.module>' pom.xml | awk -F '[><]' '{print $3}' || true)

        if [ -z "${DEPLOYABLE_MODULE}" ] ; then
            DEPLOYABLE_MODULE_DIR="."
        else
            DEPLOYABLE_MODULE_DIR="${DEPLOYABLE_MODULE}"
        fi

        echo "Deployable module directory: ${DEPLOYABLE_MODULE_DIR}"

        printf "%s" "${DEPLOYABLE_MODULE_DIR}" > "$(results.DEPLOYABLE_MODULE_DIR.path)"
---
# Source: edp-tekton/templates/tasks/maven.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: maven
  labels:
    app.kubernetes.io/based-on: "0.2"
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This Task can be used to run a Maven build.

  workspaces:
    - name: source
      description: The workspace consisting of maven project.
  params:
    - name: MAVEN_IMAGE
      type: string
      description: Maven base image
      default: maven:3.9.0-eclipse-temurin-11
    - name: GOALS
      description: maven goals to run
      type: array
      default:
        - "package"
    - name: CONTEXT_DIR
      type: string
      description: >-
        The context directory within the repository for sources on
        which we want to execute maven goals.
      default: "source"
    - name: ci-nexus
      type: string
      description: name of the secret holding the Nexus CI integration data
      default: ci-nexus
    - name: ci-sonarqube
      type: string
      description: name of the secret holding the Sonarqube CI integration data
      default: "ci-sonarqube"
  volumes:
    - name: settings-maven
      configMap:
        name: custom-maven-settings
  steps:
    - name: mvn-goals
      image: $(params.MAVEN_IMAGE)
      volumeMounts:
        - name: settings-maven
          mountPath: /var/configmap
      workingDir: $(workspaces.source.path)/$(params.CONTEXT_DIR)
      command: ["/usr/bin/mvn"]
      args:
        - -s
        - /var/configmap/settings.xml
        - "$(params.GOALS)"
      env:
        - name: HOME
          value: $(workspaces.source.path)
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: token
        - name: SONAR_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: url
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/npm.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: npm
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task can be used to run npm goals on a project
    where package.json is present and has some pre-defined
    npm scripts.
  params:
    - name: PATH_CONTEXT
      type: string
      default: "."
      description: The path where package.json of the project is defined.
    - name: EXTRA_COMMANDS
      type: string
    - name: BASE_IMAGE
      type: string
      default: "docker.io/library/node:18.20.3-alpine3.20"
      description: The node image you want to use.
    - name: ci-nexus
      type: string
      description: name of the secret for the Nexus integration
      default: ci-nexus

  workspaces:
    - name: source

  volumes:
    - name: settings-npm
      configMap:
        name: custom-npm-settings

  steps:
    - name: npm
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)

      volumeMounts:
        - name: settings-npm
          mountPath: /var/configmap

      env:
        - name: HOME
          value: "$(workspaces.source.path)"
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
      script: |
        #!/usr/bin/env sh
        set -e

        $(params.EXTRA_COMMANDS)
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/opa.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: opa
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task can be used to run opa tests on a project.
  workspaces:
    - name: source
  params:
    - name: PROJECT_DIR
      description: The directory containing opa files
      type: string
      default: "."
    - name: OPA_RESULTS
      type: string
      default: '/workspace/opa_results'
    - name: JUNIT_SCRIPT
      type: string
      default: '/workspace/opa_test_to_junit.py'
    - name: EXTRA_COMMANDS
      type: string
    - name: BASE_IMAGE
      type: string
      default: "openpolicyagent/opa:0.45.0-debug"
      description: The opa image.
  steps:
    - name: opa-results-json
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      env:
        - name: OPA_RESULTS
          value: "$(params.OPA_RESULTS)"
      script: |
        #!/busybox/sh
        set -e
        opa test --bundle ./ --format json > "${OPA_RESULTS}"
        cat "${OPA_RESULTS}"
    - image: curlimages/curl:7.85.0
      name: download-converter
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      env:
        - name: JUNIT_SCRIPT
          value: "$(params.JUNIT_SCRIPT)"
      script: |
        set -e
        curl -fsSL https://raw.githubusercontent.com/open-policy-agent/contrib/main/junit/opa_test_to_junit.py \
            -o "${JUNIT_SCRIPT}"
        cat "${JUNIT_SCRIPT}"
    - name: convert-to-xml
      image: 'python:3.10.8-alpine3.16'
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      env:
        - name: OPA_RESULTS
          value: "$(params.OPA_RESULTS)"
        - name: JUNIT_SCRIPT
          value: "$(params.JUNIT_SCRIPT)"
      script: |
        set -e
        $(params.EXTRA_COMMANDS)
---
# Source: edp-tekton/templates/tasks/promote-images.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: promote-images
spec:
  params:
    - name: BASE_IMAGE
      description: The base image for the task.
      type: string
      default: epamedp/tekton-cd-pipeline:0.1.2
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: {"codebase1": {"imageTag": "version1", "customValues": true}, "codebase2": {"imageTag": "version2", "customValues": true}}. For example: {"demo": {"imageTag": "main-20240103-141431", "customValues": true}, "myapp": {"imageTag": "0.1.0-SNAPSHOT.1", "customValues": true}}
      type: string
    - name: CDPIPELINE_CR
      description: CDPipeline custom resource name
      type: string
    - name: CDPIPELINE_STAGE
      description: Stage name in CD Pipeline
      type: string
    - name: CBIS_CRD
      description: CodebaseImageStream custom resource definition.
      type: string
      default: "cbis.v2.edp.epam.com"
    - name: STAGE_CRD
      description: Stage custom resource definition.
      type: string
      default: "stages.v2.edp.epam.com"
    - name: CDPIPELINE_CRD
      description: CDPipeline custom resource definition.
      type: string
      default: "cdpipelines.v2.edp.epam.com"

  steps:
    - name: annotate
      image: $(params.BASE_IMAGE)
      env:
        - name: APPLICATIONS_PAYLOAD
          value: "$(params.APPLICATIONS_PAYLOAD)"
        - name: CDPIPELINE_CR
          value: "$(params.CDPIPELINE_CR)"
        - name: CDPIPELINE_STAGE
          value: "$(params.CDPIPELINE_STAGE)"
        - name: STAGE_CRD
          value: "$(params.STAGE_CRD)"
      script: |
        set -ex
        STAGE_CR="${CDPIPELINE_CR}-${CDPIPELINE_STAGE}"
        echo ${APPLICATIONS_PAYLOAD} | jq -r 'to_entries[] |
        "\(.key)=\(.value.imageTag)"' | while IFS= read -r i; do
          kubectl annotate --overwrite "${STAGE_CRD}" "${STAGE_CR}" "app.edp.epam.com/${i}"
        done
    - name: promote-images
      image: $(params.BASE_IMAGE)
      env:
        - name: CDPIPELINE_CR
          value: "$(params.CDPIPELINE_CR)"
        - name: CDPIPELINE_STAGE
          value: "$(params.CDPIPELINE_STAGE)"
        - name: CDPIPELINE_CRD
          value: "$(params.CDPIPELINE_CRD)"
        - name: CBIS_CRD
          value: "$(params.CBIS_CRD)"
        - name: STAGE_CRD
          value: "$(params.STAGE_CRD)"
      script: |
        set -ex

        APPS_PROMOTE=$(kubectl get "${CDPIPELINE_CRD}" "${CDPIPELINE_CR}" -o jsonpath='{.spec.applicationsToPromote[*]}')
        DATE_FORMAT_RFC3339=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
        STAGE_CR="${CDPIPELINE_CR}-${CDPIPELINE_STAGE}"

        for APP in ${APPS_PROMOTE}; do
          VERIFIED_SBIS="${STAGE_CR}-${APP}-verified"
          IMAGE_TAG=$(kubectl get "${STAGE_CRD}" "${STAGE_CR}" -o jsonpath="{.metadata.annotations.app\.edp\.epam\.com/${APP}}")

          if [ -n "${IMAGE_TAG}" ]; then
            CBIS_TAG=$(kubectl get "${CBIS_CRD}" "${VERIFIED_SBIS}" -o jsonpath='{.spec.tags[*].name}')
            NEW_CBIS_TAG="{\"name\":\"${IMAGE_TAG}\",\"created\":\"${DATE_FORMAT_RFC3339}\"}"

            if [ -n "${CBIS_TAG}" ] && [ "${CBIS_TAG}" = "$(printf '%s' "${CBIS_TAG}" | sed 's/'"${IMAGE_TAG}"'//g')" ]; then
              echo "[TEKTON][DEBUG] ImageStream ${VERIFIED_SBIS} doesn't contain ${IMAGE_TAG} tag ... it will be added."
              kubectl patch "${CBIS_CRD}" "${VERIFIED_SBIS}" --type json \
                -p "[{\"op\": \"add\", \"path\": \"/spec/tags/-\", \"value\": ${NEW_CBIS_TAG} }]"
            elif [ -z "${CBIS_TAG}" ]; then
              echo "[TEKTON][DEBUG] There're no tags in imageStream ${VERIFIED_SBIS} ... the first one will be added."
              kubectl patch "${CBIS_CRD}" "${VERIFIED_SBIS}" --type=merge \
                -p "{\"spec\":{\"tags\":[${NEW_CBIS_TAG}]}}"
            fi
          fi
        done
---
# Source: edp-tekton/templates/tasks/push-to-jira.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: push-to-jira
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/displayName: Push-to-Jira
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    The push-to-jira Task will create JiraIssueMetadata Custom Resource

  params:
    - name: TICKET_NAME_PATTERN
      type: string
    - name: COMMIT_MESSAGE
      type: string
    - name: COMMIT_ID
      type: string
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      type: string
    - name: CODEBASE_NAME
      type: string
    - name: PIPELINE_URL
      type: string
    - name: VCS_TAG
      type: string
    - name: VERSION
      type: string
  steps:
    - name: push-to-jira
      image: epamedp/tekton-autotest:0.1.3
      env:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(params.COMMIT_ID)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: PIPELINE_URL
          value: "$(params.PIPELINE_URL)"
        - name: VCS_TAG
          value: "$(params.VCS_TAG)"
        - name: VERSION
          value: "$(params.VERSION)"
      script: |
        #!/usr/bin/python

        import os
        import sys
        import re
        import json
        from random import randint

        ticket_message_pattern = os.getenv("TICKET_NAME_PATTERN")
        commit_message_with_change_id = os.getenv("COMMIT_MESSAGE")
        commit_id = os.getenv("COMMIT_ID")
        jira_issue_metadata_payload = os.getenv("JIRA_ISSUE_METADATA_PAYLOAD")
        codebase = os.getenv("CODEBASE_NAME")
        pipeline_url = os.getenv("PIPELINE_URL")
        vcs_tag = os.getenv("VCS_TAG")
        version = os.getenv("VERSION")

        print(f"[TEKTON][DEBUG] TICKET_NAME_PATTERN: {ticket_message_pattern}")
        print(f"[TEKTON][DEBUG] COMMIT_MESSAGE: \n{commit_message_with_change_id}")
        print(f"[TEKTON][DEBUG] COMMIT_ID: {commit_id}")
        print(f"[TEKTON][DEBUG] JIRA_ISSUE_METADATA_PAYLOAD: {jira_issue_metadata_payload}")
        print(f"[TEKTON][DEBUG] CODEBASE_NAME: {codebase}")
        print(f"[TEKTON][DEBUG] PIPELINE_URL: {pipeline_url}")
        print(f"[TEKTON][DEBUG] VCS_TAG: {vcs_tag}")
        print(f"[TEKTON][DEBUG] VERSION: {version}")
        print("")

        def search_pattern(message, pattern):
            result = re.search(pattern, message)
            if result == None:
                print(f"[TEKTON] Message is invalid. The required pattern is {pattern}")
                sys.exit(1)
            return result.group()

        def set_params_jira_issue_metadata(metadata_name, commits, tickets, codebase, payload):
            print("[TEKTON] Getting JiraIssueMetadata CR template")
            template = {
              "apiVersion": "v2.edp.epam.com/v1",
              "kind": "JiraIssueMetadata",
              "metadata": {
                "name": "replace"
              },
              "spec": {
                "commits": "replace",
                "tickets": "replace",
                "codebaseName": "replace",
                "payload": "replace"
              }
            }
            print("[TEKTON] JiraIssueMetadata template has been fetched:\n{}".format(json.dumps(template, indent = 4)))

            template["metadata"]["name"] = metadata_name
            template["spec"]["commits"] = commits
            template["spec"]["tickets"] = tickets
            template["spec"]["codebaseName"] = codebase
            template["spec"]["payload"] = payload
            print("[TEKTON] JiraIssueMetadata template has been parameterized:\n{}".format(json.dumps(template, indent = 4)))

            return json.dumps(template)

        print(f"[TEKTON] Ticket name pattern has been fetched: {ticket_message_pattern}")
        print(f"[TEKTON] Commit message to validate has been fetched:\n{commit_message_with_change_id}")

        print("[TEKTON] Getting Ticket number and Commit message")
        ticket_number = search_pattern(commit_message_with_change_id, ticket_message_pattern)
        print(f"[TEKTON] Ticket number is {ticket_number}")
        # Use the first line of commit message as a commit message for JiraIssueMetadata CR
        commit_message = commit_message_with_change_id.split("\n")[0]
        print(f"[TEKTON] Commit message was parsed: {commit_message}")

        print("[TEKTON] Preparing Jira Issue Link")
        linkInfo = {
            "ticket": ticket_number,
            "title": f"{commit_message} [{codebase}][{vcs_tag}]",
            "url": pipeline_url
        }
        print("[TEKTON] Issue Link:\n{}".format(json.dumps(linkInfo, indent = 4)))

        values = {
            "EDP_COMPONENT": codebase,
            "EDP_VERSION": version,
            "EDP_SEM_VERSION": re.sub("(-RC|-SNAPSHOT)\.\d+", "", version),
            "EDP_GITTAG": vcs_tag
        }
        print("[TEKTON] EDP predefined variables:\n{}".format(json.dumps(values, indent = 4)))

        payload = json.loads(jira_issue_metadata_payload)
        print("[TEKTON] JiraIssueMetadataPayload of {0} Codebase CR has been fetched:\n{1}".format(codebase, json.dumps(values, indent = 4)))

        if payload == None:
            payload = { "issuesLinks": [linkInfo] }
        else:
            for x in payload:
                for k in values:
                    payload[x] = payload[x].replace(k, values[k])
            payload["issuesLinks"] = [linkInfo]

        random_seed = ''.join(str(randint(0, 9)) for _ in range(8))
        metadata_name = f"{codebase}-{random_seed}"

        template_json = set_params_jira_issue_metadata(metadata_name, [commit_id], [ticket_number], codebase, json.dumps(payload, indent = 4))

        print("[TEKTON][DEBUG] Applying JiraIssueMetadata CR")
        os.system(f"kubectl apply -f - << EOF\n{template_json}\nEOF")

        print("[TEKTON][DEBUG] JiraIssueMetadata CR has been created")
---
# Source: edp-tekton/templates/tasks/python.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: python
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task can be used to run python goals on a project.
    It utilizes default PIP and Twine environment variables.
    Twine logs in to nexus using environment variables to upload packages.
    PIP does not support username and password environment variables yet.
    Thus, we use the ~/.netrc file for PIP to download packages.
    The ~/.config/pip/pip.conf file can also be used along with ~/.netrc.
  workspaces:
    - name: source
  params:
    - name: PATH_CONTEXT
      type: string
      default: "source"
      description: The path where package.json of the project is defined.
    - name: TWINE_REPOSITORY_URL
      type: string
      default: ""
      description: Nexus Repository URL Twine uploads to.
    - name: TWINE_NON_INTERACTIVE
      type: string
      default: "1"
      description: Do not interactively prompt for credentials if they are missing.
    - name: EXTRA_COMMANDS
      type: string
    - name: BASE_IMAGE
      type: string
      default: "python:3.8-slim"
      description: The python image you want to use.
    - name: ci-nexus
      type: string
      description: name of the secret for the Nexus integration
      default: ci-nexus
    - name: PIP_CACHE_DIR
      type: string
      description: Cache directory of the pip
      default: "$(workspaces.source.path)/cache/.cache/pip"
  steps:
    - name: python
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)
      env:
        - name: HOME
          value: $(workspaces.source.path)
        - name: PIP_CACHE_DIR
          value: $(params.PIP_CACHE_DIR)
        - name: TWINE_REPOSITORY_URL
          value: $(params.TWINE_REPOSITORY_URL)
        - name: TWINE_NON_INTERACTIVE
          value: $(params.TWINE_NON_INTERACTIVE)
        - name: TWINE_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: TWINE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
        - name: PIP_INDEX_PATH
          valueFrom:
            configMapKeyRef:
              name: custom-python-settings
              key: PIP_INDEX_PATH
              optional: true
        - name: PIP_INDEX_URL_PATH
          valueFrom:
            configMapKeyRef:
              name: custom-python-settings
              key: PIP_INDEX_URL_PATH
        - name: REPOSITORY_SNAPSHOTS_PATH
          valueFrom:
            configMapKeyRef:
              name: custom-python-settings
              key: REPOSITORY_SNAPSHOTS_PATH
        - name: REPOSITORY_RELEASES_PATH
          valueFrom:
            configMapKeyRef:
              name: custom-python-settings
              key: REPOSITORY_RELEASES_PATH
      script: |
        #!/usr/bin/env sh
        set -ex
        export PATH=$PATH:$HOME/.local/bin

        # Artifact Storage Repository host PIP connects to via HTTP. e.g. 'nexus'
        export PIP_TRUSTED_HOST=$(echo "${NEXUS_HOST_URL}" | cut -d '/' -f 3 | cut -d ':' -f 1)

        # Concatenate the base URL with the specific paths from the ConfigMap
        export PIP_INDEX="${NEXUS_HOST_URL}${PIP_INDEX_PATH}"
        export PIP_INDEX_URL="${NEXUS_HOST_URL}${PIP_INDEX_URL_PATH}"
        export REPOSITORY_URL_SNAPSHOTS="${NEXUS_HOST_URL}${REPOSITORY_SNAPSHOTS_PATH}"
        export REPOSITORY_URL_RELEASES="${NEXUS_HOST_URL}${REPOSITORY_RELEASES_PATH}"

        echo "[TEKTON][INFO] NEXUS_HOST_URL contains ${NEXUS_HOST_URL}"
        echo "[TEKTON][INFO] PIP_INDEX contains ${PIP_INDEX}"
        echo "[TEKTON][INFO] PIP_INDEX_URL contains ${PIP_INDEX_URL}"
        echo "[TEKTON][INFO] PIP_TRUSTED_HOST contains ${PIP_TRUSTED_HOST}"
        echo "[TEKTON][INFO] REPOSITORY_URL_SNAPSHOTS contains ${REPOSITORY_URL_SNAPSHOTS}"
        echo "[TEKTON][INFO] REPOSITORY_URL_RELEASES contains ${REPOSITORY_URL_RELEASES}"

        netcr_file="$HOME/.netrc"
        if [ ! -f "${netcr_file}" ]; then
          cat <<-EOF > "${netcr_file}"
        machine ${PIP_TRUSTED_HOST}
        login ${TWINE_USERNAME}
        password ${TWINE_PASSWORD}
        EOF
        chmod 0600 "${netcr_file}"
        fi

        $(params.EXTRA_COMMANDS)
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/run-quality-gate.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: run-quality-gate
spec:
  params:
    - name: BASE_IMAGE
      description: The base image for the task (different for buildtools).
      type: string
      default: ""
    - name: EXTRA_COMMANDS
      type: string
      description: Extra commands
      default: ""
    - name: KUBECONFIG_SECRET_NAME
      type: string
      description: The name of secret with Kubeconfig to connect to the remote cluster
      default: "in-cluster"
  volumes:
    - name: kubeconfig
      secret:
        secretName: $(params.KUBECONFIG_SECRET_NAME)
        optional: true
  steps:
    - name: run
      image: $(params.BASE_IMAGE)
      volumeMounts:
        - name: kubeconfig
          mountPath: /workspace/source/kube
      script: |
        set -ex
        export KUBECONFIG="workspace/source/kube/config"
        $(params.EXTRA_COMMANDS)
---
# Source: edp-tekton/templates/tasks/save-cache.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: save-cache
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/displayName: "save-cache"
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This Task is used to save the cache to the distribution server. It packs and uploads the root of workspace to the distribution server
  params:
    - name: CACHE_NAME
      description: "Cache name (filename) to be downloaded from the cache server."
      type: string
    - name: BASE_IMAGE
      description: "Base image"
      default: "epamedp/tekton-autotest:0.1.2"
      type: string

  workspaces:
    - name: cache

  steps:
    - name: save-cache
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.cache.path)

      script: |
        #!/usr/bin/env bash
        set -ex

        curl -o/dev/null -s -f -X POST -F path=test -F file=@/etc/motd  ${CACHE_SERVER_URL}/upload || {
            echo "No cache server found"
            exit 0
        }

        lm="$(curl -fsI ${CACHE_SERVER_URL}/${CACHE_NAME}.tar.gz|sed -n '/Last-Modified/ { s/Last-Modified: //;s/\r//; p}')"
        if [ -n "${lm}" ];then
          expired=$(python -c "import datetime, sys;print(datetime.datetime.now() > datetime.datetime.strptime(sys.argv[1], '%a, %d %b %Y %X %Z') + datetime.timedelta(days=1))" "${lm}")
          if [ "${expired}" = "False" ]; then
              echo "Cache is younger than a day"
              exit
          fi
        fi

        tar czf - . |curl -# -L -f -F path=${CACHE_NAME}.tar.gz -X POST -F "file=@-" ${CACHE_SERVER_URL}/upload
      env:
        - name: CACHE_SERVER_URL
          valueFrom:
            configMapKeyRef:
              name: tekton-cache
              key: url
              optional: true
        - name: CACHE_NAME
          value: "$(params.CACHE_NAME)"

      computeResources:
        limits:
          cpu: 500m
          memory: 1Gi
        requests:
          cpu: 100m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/security.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: security
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Scan Tools
    tekton.dev/tags: scan-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  workspaces:
    - name: source
      description: The workspace consisting of maven project.
  params:
    - name: BASE_IMAGE
      type: string
      description: Semgrep image
      default: returntocorp/semgrep:1.58.0
    - name: ci-defectdojo
      type: string
      description: name of the secret holding the DefectDojo CI integration data
      default: ci-defectdojo
    - name: reportDataPath
      type: string
      default: "security-semgrep-report.json"
    - name: reportDataProductName
      type: string
      default: ""
    - name: reportDataEngagementName
      type: string
      default: ""
    - name: PROJECT_NAME
      description: That is the name of the project that will be updated/created on the dependency track side
      default: ''
      type: string
    - name: PROJECT_BRANCH
      description: That is the branch of the project that will be updated/created on the dependency track side
      default: ''
      type: string
    - name: ci-dependency-track
      type: string
      description: Name of the secret holding the ci-dependency-track api token
      default: ci-dependency-track
  steps:
    - name: semgrep-scan-and-report
      image: $(params.BASE_IMAGE)
      computeResources: {}
      workingDir: $(workspaces.source.path)
      script: |
        set -e
        # The .docker/config.json file contained sensitive information, so it was added to the ignorelist.
        echo ".docker/config.json" >> .semgrepignore
        semgrep --jobs 1 --config=p/r2c-ci . --json --output $(params.reportDataPath) --disable-version-check

        if [ -z "$DD_HOST_URL" ]
        then
          exit 0
        fi

        reportDataActive="true"
        reportDataVerified="false"
        reportDataPath="security-semgrep-report.json"
        reportDataType="Semgrep JSON Report"
        reportDataProductTypeName="Tenant"
        reportDataProductName=$(params.reportDataProductName)
        reportDataEngagementName=$(params.reportDataEngagementName)
        reportDataAutoCreateContext="true"
        reportDataCloseOldFindings="true"
        reportDataPushToJira="false"
        reportDataEnvironment="Development"
        reportDataTestTitle="security"
        curl -X POST "${DD_HOST_URL}/api/v2/import-scan/" \
            -H "accept: application/json" \
            -H "Authorization: Token ${DD_TOKEN}" \
            -H "Content-Type: multipart/form-data" \
            -F "scan_date=$(date +%Y-%m-%d)" \
            -F "minimum_severity=Info" \
            -F "active=${reportDataActive}" \
            -F "verified=${reportDataVerified}" \
            -F "scan_type=${reportDataType}" \
            -F "file=@${reportDataPath};type=application/json" \
            -F "product_type_name=${reportDataProductTypeName}" \
            -F "product_name=${reportDataProductName}" \
            -F "engagement_name=${reportDataEngagementName}" \
            -F "auto_create_context=${reportDataAutoCreateContext}" \
            -F "close_old_findings=${reportDataCloseOldFindings}" \
            -F "push_to_jira=${reportDataPushToJira}" \
            -F "environment=${reportDataEnvironment}" \
            -F "test_title=${reportDataTestTitle}"

      env:
        - name: HOME
          value: "$(workspaces.source.path)"
        - name: SEMGREP_VERSION_CACHE_PATH
          value: "$(workspaces.source.path)/.cache"
        - name: DD_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-defectdojo)
              key: token
              optional: true
        - name: DD_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-defectdojo)
              key: url
              optional: true
    - env:
        - name: API_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-dependency-track)
              key: token
              optional: true
        - name: DEPTRACK_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-dependency-track)
              key: url
              optional: true
        - name: PROJECT_NAME
          value: $(params.PROJECT_NAME)
        - name: PROJECT_BRANCH
          value: $(params.PROJECT_BRANCH)
      image: >-
        ghcr.io/cyclonedx/cdxgen:v9.6.0@sha256:ea01324872d2c21b024264a2224d761ab63851b9cc4722903b5e74be56ca6fa6
      name: cdxgen
      computeResources: {}
      script: >
        #!/usr/bin/env sh

        set -e

        set +x

        /opt/cdxgen/bin/cdxgen.js --api-key=$API_TOKEN --server-url=$DEPTRACK_URL --project-name=$PROJECT_NAME --project-version=$PROJECT_BRANCH
      workingDir: $(workspaces.source.path)
---
# Source: edp-tekton/templates/tasks/send-to-microsoft-teams.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: send-to-microsoft-teams
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  description: >-
    These tasks post a message to a Microsoft Teams Channel.
    This task uses the Incoming Webhook functionality of Microsoft Teams
  params:
  - name: webhook-url-secret
    type: string
    description: Name of the secret with incoming webhook URL
  - name: webhook-url-secret-key
    type: string
    description: Key in the secret
  - name: message
    type: string
    description: The message to notify about
  steps:
  - name: post
    image: docker.io/curlimages/curl:7.70.0@sha256:031df77a11e5edded840bc761a845eab6e3c2edee22669fb8ad6d59484b6a1c4
    script: |
      #!/usr/bin/env sh
      MESSAGE=$(echo "${MESSAGE}" | sed -e 's/\"/\\\\"/g')
      JSON="{\"text\": \"${MESSAGE}\" }"
      curl -X POST -H 'Content-Type: application/json' -d "${JSON}" "${WEBHOOK_URL}"
    env:
    - name: WEBHOOK_URL
      valueFrom:
        secretKeyRef:
          name: $(params.webhook-url-secret)
          key: $(params.webhook-url-secret-key)
    - name: MESSAGE
      value: $(params.message)
---
# Source: edp-tekton/templates/tasks/sonar/sonarqube-dotnet.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: sonarqube-dotnet
  labels:
    app.kubernetes.io/version: "0.2"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Security
    tekton.dev/tags: security
    tekton.dev/displayName: "sonarqube scanner"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    The sonarqube-scanner Task will update parameters in the
    sonar-project.properties file or create a new sonar-project.properties
    file and put parameters of a sonar project into it.

    Task will run sonar-scanner for scanning after preparing the sonar-project.properties file.

  workspaces:
    - name: source
  params:
    - name: SONAR_PROJECT_KEY
      description: Project's unique key
      default: ""
    - name: SONAR_PROJECT_NAME
      description: Project's unique name
      default: ""
    - name: SONAR_QUALITYGATE_WAIT
      description: Forces the analysis step to poll the SonarQube instance and wait for the Quality Gate status.
      default: "true"
    - name: ci-sonarqube
      type: string
      description: name of the secret holding the Sonarqube CI integration data
      default: "ci-sonarqube"
    - name: branch
      type: string
      description: Branch of scanning (for build pipeline)
      default: ""
    - name: target-branch
      type: string
      description: Target branch of Merge Request
      default: ""
    - name: source-branch
      type: string
      description: Source branch of Merge Request
      default: ""
    - name: key-id
      type: string
      description: Change number from Merge Request
      default: ""
    - name: BASE_IMAGE
      description: DotNet base image.
      type: string
      default: "epamedp/tekton-dotnet:6.0.2"
    - name: PROJECT_DIR
      description: The directory containing build.gradle
      type: string
      default: "."
    - name: EXTRA_COMMANDS
      type: string
  steps:
    - image: epamedp/tekton-autotest:0.1.3
      name: prepare-project
      workingDir: $(workspaces.source.path)
      env:
        - name: SONAR_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: url
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: token
        - name: SONAR_PROJECT_KEY
          value: "$(params.SONAR_PROJECT_KEY)"
        - name: SONAR_PROJECT_NAME
          value: "$(params.SONAR_PROJECT_NAME)"
      script: |
        set -e

        PROJECT_EXISTS=$(curl -s -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/components/show?component=${SONAR_PROJECT_KEY}" | jq -r ".component.key")

        if [ "$PROJECT_EXISTS" == "null" ]; then
          default_branch=$(kubectl get codebase $SONAR_PROJECT_NAME -o jsonpath='{.spec.defaultBranch}')
          echo "Create project ${SONAR_PROJECT_KEY}"
          curl -X POST -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/projects/create?name=${SONAR_PROJECT_KEY}&project=${SONAR_PROJECT_KEY}&mainBranch=${default_branch}"
        else
          echo "Project ${SONAR_PROJECT_KEY} already exists"
        fi
    - name: sonar-scanner
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      env:
        - name: HOME
          value: $(workspaces.source.path)
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: token
        - name: SONAR_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: url
        - name: SONAR_PROJECT_KEY
          value: "$(params.SONAR_PROJECT_KEY)"
        - name: SONAR_PROJECT_NAME
          value: "$(params.SONAR_PROJECT_NAME)"
        - name: SONAR_QUALITYGATE_WAIT
          value: "$(params.SONAR_QUALITYGATE_WAIT)"
        - name: TARGET_BRANCH
          value: "$(params.target-branch)"
        - name: SOURCE_BRANCH
          value: "$(params.source-branch)"
        - name: KEY_ID
          value: "$(params.key-id)"
        - name: BRANCH
          value: "$(params.branch)"
      script: |
        #!/usr/bin/env sh
        set -e
        $(params.EXTRA_COMMANDS)
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/sonar/sonarqube-general.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: sonarqube-general
  labels:
    app.kubernetes.io/version: "0.2"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Security
    tekton.dev/tags: security
    tekton.dev/displayName: "sonarqube scanner"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    The sonarqube-scanner Task will update parameters in the
    sonar-project.properties file or create a new sonar-project.properties
    file and put parameters of a sonar project into it.

    Task will run sonar-scanner for scanning after preparing the sonar-project.properties file.

  workspaces:
    - name: source
  params:
    - name: SONAR_PROJECT_KEY
      description: Project's unique key
      default: ""
    - name: SONAR_PROJECT_NAME
      description: Project's unique name
      default: ""
    - name: SONAR_QUALITYGATE_WAIT
      description: Forces the analysis step to poll the SonarQube instance and wait for the Quality Gate status.
      default: "true"
    - name: ci-sonarqube
      type: string
      description: name of the secret holding the Sonarqube CI integration data
      default: "ci-sonarqube"
    - name: branch
      type: string
      description: Branch of scanning (for build pipeline)
      default: ""
    - name: target-branch
      type: string
      description: Target branch of Merge Request
      default: ""
    - name: source-branch
      type: string
      description: Source branch of Merge Request
      default: ""
    - name: key-id
      type: string
      description: Change number from Merge Request
      default: ""
  steps:
    - image: epamedp/tekton-autotest:0.1.3
      name: prepare-project
      workingDir: $(workspaces.source.path)
      env:
        - name: SONAR_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: url
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: token
        - name: SONAR_PROJECT_KEY
          value: "$(params.SONAR_PROJECT_KEY)"
        - name: SONAR_PROJECT_NAME
          value: "$(params.SONAR_PROJECT_NAME)"
      script: |
        set -e

        PROJECT_EXISTS=$(curl -s -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/components/show?component=${SONAR_PROJECT_KEY}" | jq -r ".component.key")

        if [ "$PROJECT_EXISTS" == "null" ]; then
          default_branch=$(kubectl get codebase $SONAR_PROJECT_NAME -o jsonpath='{.spec.defaultBranch}')
          echo "Create project ${SONAR_PROJECT_KEY}"
          curl -X POST -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/projects/create?name=${SONAR_PROJECT_KEY}&project=${SONAR_PROJECT_KEY}&mainBranch=${default_branch}"
        else
          echo "Project ${SONAR_PROJECT_KEY} already exists"
        fi
    - image: registry.access.redhat.com/ubi8/ubi-minimal:8.8
      name: prepare-sonar-project-properties
      computeResources: {}
      workingDir: $(workspaces.source.path)
      env:
        - name: SONAR_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: url
        - name: SONAR_PROJECT_KEY
          value: "$(params.SONAR_PROJECT_KEY)"
        - name: SONAR_PROJECT_NAME
          value: "$(params.SONAR_PROJECT_NAME)"
        - name: SONAR_QUALITYGATE_WAIT
          value: "$(params.SONAR_QUALITYGATE_WAIT)"
        - name: TARGET_BRANCH
          value: "$(params.target-branch)"
        - name: SOURCE_BRANCH
          value: "$(params.source-branch)"
        - name: KEY_ID
          value: "$(params.key-id)"
        - name: BRANCH
          value: "$(params.branch)"
      script: |
        #!/usr/bin/env bash

        replaceValues() {
          filename=$1
          thekey=$2
          newvalue=$3

          if ! grep -R "^[#]*\s*${thekey}=.*" $filename >/dev/null; then
            echo "APPENDING because '${thekey}' not found"
            echo "" >>$filename
            echo "$thekey=$newvalue" >>$filename
          else
            echo "SETTING because '${thekey}' found already"
            sed -ir "s|^[#]*\s*${thekey}=.*|$thekey=$newvalue|" $filename
          fi
        }

        if [[ -f $(workspaces.source.path)/sonar-project.properties ]]; then
          if [[ -n "${SONAR_HOST_URL}" ]]; then
            replaceValues $(workspaces.source.path)/sonar-project.properties sonar.host.url ${SONAR_HOST_URL}
          fi
          if [[ -n "${SONAR_PROJECT_KEY}" ]]; then
            replaceValues $(workspaces.source.path)/sonar-project.properties sonar.projectKey ${SONAR_PROJECT_KEY}
          fi
          if [[ -n "${SONAR_PROJECT_NAME}" ]]; then
            replaceValues $(workspaces.source.path)/sonar-project.properties sonar.projectName ${SONAR_PROJECT_NAME}
          fi
          if [[ -n "${SONAR_QUALITYGATE_WAIT}" ]]; then
            replaceValues $(workspaces.source.path)/sonar-project.properties sonar.qualitygate.wait ${SONAR_QUALITYGATE_WAIT}
          fi
          if [[ -n "${BRANCH}" ]]; then
            replaceValues $(workspaces.source.path)/sonar-project.properties sonar.branch.name ${BRANCH}
          fi
          if [[ -n "${KEY_ID}" ]]; then
            replaceValues $(workspaces.source.path)/sonar-project.properties sonar.pullrequest.key ${KEY_ID}
          fi
          if [[ -n "${SOURCE_BRANCH}" ]]; then
            replaceValues $(workspaces.source.path)/sonar-project.properties sonar.pullrequest.branch ${SOURCE_BRANCH}
          fi
          if [[ -n "${TARGET_BRANCH}" ]]; then
            replaceValues $(workspaces.source.path)/sonar-project.properties sonar.pullrequest.base ${TARGET_BRANCH}
          fi

        else
          touch sonar-project.properties
          test -z "${SONAR_HOST_URL}" || echo "sonar.host.url=${SONAR_HOST_URL}" >> sonar-project.properties
          test -z "${SONAR_PROJECT_KEY}" || echo "sonar.projectKey=${SONAR_PROJECT_KEY}" >> sonar-project.properties
          test -z "${SONAR_PROJECT_NAME}" || echo "sonar.projectName=${SONAR_PROJECT_NAME}" >> sonar-project.properties
          test -z "${SONAR_QUALITYGATE_WAIT}" || echo "sonar.qualitygate.wait=${SONAR_QUALITYGATE_WAIT}" >> sonar-project.properties
          test -z "${BRANCH}" || echo "sonar.branch.name=${BRANCH}" >> sonar-project.properties
          test -z "${KEY_ID}" || echo "sonar.pullrequest.key=${KEY_ID}" >> sonar-project.properties
          test -z "${SOURCE_BRANCH}" || echo "sonar.pullrequest.branch=${SOURCE_BRANCH}" >> sonar-project.properties
          test -z "${TARGET_BRANCH}" || echo "sonar.pullrequest.base=${TARGET_BRANCH}" >> sonar-project.properties
        fi

        echo "---------------------------"
        cat $(workspaces.source.path)/sonar-project.properties

    - image: sonarsource/sonar-scanner-cli:5.0.1
      name: sonar-scanner
      workingDir: $(workspaces.source.path)
      env:
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: token
      command:
        - sonar-scanner
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/sonar/sonarqube-gradle.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: sonarqube-gradle
  labels:
    app.kubernetes.io/version: "0.2"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Security
    tekton.dev/tags: security
    tekton.dev/displayName: "sonarqube scanner"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    The sonarqube-scanner Task will update parameters in the
    sonar-project.properties file or create a new sonar-project.properties
    file and put parameters of a sonar project into it.

    Task will run sonar-scanner for scanning after preparing the sonar-project.properties file.

  workspaces:
    - name: source
  params:
    - name: SONAR_PROJECT_KEY
      description: Project's unique key
      default: ""
    - name: SONAR_PROJECT_NAME
      description: Project's unique name
      default: ""
    - name: SONAR_QUALITYGATE_WAIT
      description: Forces the analysis step to poll the SonarQube instance and wait for the Quality Gate status.
      default: "true"
    - name: ci-sonarqube
      type: string
      description: name of the secret holding the Sonarqube CI integration data
      default: "ci-sonarqube"
    - name: branch
      type: string
      description: Branch of scanning (for build pipeline)
      default: ""
    - name: target-branch
      type: string
      description: Target branch of Merge Request
      default: ""
    - name: source-branch
      type: string
      description: Source branch of Merge Request
      default: ""
    - name: key-id
      type: string
      description: Change number from Merge Request
      default: ""
    - name: ci-nexus
      type: string
      description: name of the secret for the Nexus integration
      default: ci-nexus
    - name: BASE_IMAGE
      description: Gradle base image.
      type: string
      default: gradle:7.5.1-jdk11
    - name: PROJECT_DIR
      description: The directory containing build.gradle
      type: string
      default: "."
    - name: EXTRA_COMMANDS
      type: string
  volumes:
    - name: settings-gradle
      configMap:
        name: custom-gradle-settings
  steps:
    - image: epamedp/tekton-autotest:0.1.3
      name: prepare-project
      workingDir: $(workspaces.source.path)
      env:
        - name: SONAR_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: url
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: token
        - name: SONAR_PROJECT_KEY
          value: "$(params.SONAR_PROJECT_KEY)"
        - name: SONAR_PROJECT_NAME
          value: "$(params.SONAR_PROJECT_NAME)"
      script: |
        set -e

        PROJECT_EXISTS=$(curl -s -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/components/show?component=${SONAR_PROJECT_KEY}" | jq -r ".component.key")

        if [ "$PROJECT_EXISTS" == "null" ]; then
          default_branch=$(kubectl get codebase $SONAR_PROJECT_NAME -o jsonpath='{.spec.defaultBranch}')
          echo "Create project ${SONAR_PROJECT_KEY}"
          curl -X POST -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/projects/create?name=${SONAR_PROJECT_KEY}&project=${SONAR_PROJECT_KEY}&mainBranch=${default_branch}"
        else
          echo "Project ${SONAR_PROJECT_KEY} already exists"
        fi
    - name: gradle-tasks
      image: $(params.BASE_IMAGE)
      volumeMounts:
        - name: settings-gradle
          mountPath: /var/configmap
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      script: |
        #!/bin/bash
        set -e

        gradle \
          -I \
          /var/configmap/init.gradle \
          -PnexusLogin=${CI_USERNAME} \
          -PnexusPassword=${CI_PASSWORD} \
          $(params.EXTRA_COMMANDS)
      env:
        - name: XDG_CONFIG_HOME
          value: $(workspaces.source.path)/$(params.PROJECT_DIR)
        - name: GRADLE_USER_HOME
          value: $(workspaces.source.path)/$(params.PROJECT_DIR)
        - name: SONAR_USER_HOME
          value: $(workspaces.source.path)/$(params.PROJECT_DIR)
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: token
        - name: SONAR_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: url
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/sonar/sonarqube-maven.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: sonarqube-maven
  labels:
    app.kubernetes.io/version: "0.2"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Security
    tekton.dev/tags: security
    tekton.dev/displayName: "sonarqube scanner"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    The sonarqube-scanner Task will update parameters in the
    sonar-project.properties file or create a new sonar-project.properties
    file and put parameters of a sonar project into it.

    Task will run sonar-scanner for scanning after preparing the sonar-project.properties file.

  workspaces:
    - name: source
  params:
    - name: SONAR_PROJECT_KEY
      description: Project's unique key
      default: ""
    - name: SONAR_PROJECT_NAME
      description: Project's unique name
      default: ""
    - name: SONAR_QUALITYGATE_WAIT
      description: Forces the analysis step to poll the SonarQube instance and wait for the Quality Gate status.
      default: "true"
    - name: ci-nexus
      type: string
      description: name of the secret holding the Nexus CI integration data
      default: ci-nexus
    - name: ci-sonarqube
      type: string
      description: name of the secret holding the Sonarqube CI integration data
      default: "ci-sonarqube"
    - name: branch
      type: string
      description: Branch of scanning (for build pipeline)
      default: ""
    - name: target-branch
      type: string
      description: Target branch of Merge Request
      default: ""
    - name: source-branch
      type: string
      description: Source branch of Merge Request
      default: ""
    - name: key-id
      type: string
      description: Change number from Merge Request
      default: ""
    - name: CONTEXT_DIR
      type: string
      description: >-
        The context directory within the repository for sources on
        which we want to execute maven goals.
      default: "source"
    - name: MAVEN_IMAGE
      type: string
      description: Maven base image
      default: maven:3.9.0-eclipse-temurin-11
    - name: EXTRA_COMMANDS
      description: maven goals to run
      type: array
      default:
        - "package"
  volumes:
    - name: settings-maven
      configMap:
        name: custom-maven-settings
  steps:
    - image: epamedp/tekton-autotest:0.1.3
      name: prepare-project
      workingDir: $(workspaces.source.path)
      env:
        - name: SONAR_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: url
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: token
        - name: SONAR_PROJECT_KEY
          value: "$(params.SONAR_PROJECT_KEY)"
        - name: SONAR_PROJECT_NAME
          value: "$(params.SONAR_PROJECT_NAME)"
      script: |
        set -e

        PROJECT_EXISTS=$(curl -s -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/components/show?component=${SONAR_PROJECT_KEY}" | jq -r ".component.key")

        if [ "$PROJECT_EXISTS" == "null" ]; then
          default_branch=$(kubectl get codebase $SONAR_PROJECT_NAME -o jsonpath='{.spec.defaultBranch}')
          echo "Create project ${SONAR_PROJECT_KEY}"
          curl -X POST -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/projects/create?name=${SONAR_PROJECT_KEY}&project=${SONAR_PROJECT_KEY}&mainBranch=${default_branch}"
        else
          echo "Project ${SONAR_PROJECT_KEY} already exists"
        fi
    - name: mvn-goals
      image: $(params.MAVEN_IMAGE)
      volumeMounts:
        - name: settings-maven
          mountPath: /var/configmap
      workingDir: $(workspaces.source.path)/$(params.CONTEXT_DIR)
      command: ["/usr/bin/mvn"]
      args:
        - -s
        - /var/configmap/settings.xml
        - "$(params.EXTRA_COMMANDS)"
      env:
        - name: HOME
          value: $(workspaces.source.path)
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: token
        - name: SONAR_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: url
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/terraform-check.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: terraform-check
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task can be used to run opa tests on a project.
  workspaces:
    - name: source
  params:
    - name: PROJECT_DIR
      description: The directory containing terraform files
      type: string
      default: "."
    - name: EXTRA_COMMANDS
      type: string
    - name: BASE_IMAGE
      type: string
      default: epamedp/tekton-pre-commit:0.1.5
      description: The terraform-check image.
  steps:
    - name: terraform
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      script: |
        set -ex
        $(params.EXTRA_COMMANDS)
      securityContext:
        runAsUser: 0
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/terraform.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: terraform
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task can be used to run opa tests on a project.
  workspaces:
    - name: source
  params:
    - name: PROJECT_DIR
      description: The directory containing terraform files
      type: string
      default: "."
    - name: EXTRA_COMMANDS
      type: string
    - name: BASE_IMAGE
      type: string
      default: epamedp/tekton-tfenv:0.1.4
      description: The tfenv image.
    - name: TFENV_TERRAFORM_VERSION
      type: string
      default: "latest"
      description: Terraform version
  steps:
    - name: terraform
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      script: |
        set -ex
        $(params.EXTRA_COMMANDS)
      env:
        - name: TFENV_CONFIG_DIR
          value: /tekton/home
        - name: TFENV_TERRAFORM_VERSION
          value: $(params.TFENV_TERRAFORM_VERSION)
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/trivy-scan.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: trivy-scan
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Scan Tools
    tekton.dev/tags: scan-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  workspaces:
    - name: source
      description: The workspace consisting of maven project.
  params:
    - name: BASE_IMAGE
      type: string
      description: Semgrep image
      default: "aquasec/trivy:0.41.0"
    - name: targetImage
      type: string
      default: ""
  steps:
    - name: trivy
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: TARGET_IMAGE
          value: $(params.targetImage)
      script: |
        #!/usr/bin/env sh
        set -e

        trivy image --scanners vuln --severity HIGH,CRITICAL "${TARGET_IMAGE}"
---
# Source: edp-tekton/templates/tasks/update-cbb.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-cbb
spec:
  params:
    - name: CODEBASEBRANCH_NAME
      type: string
      description: "Codebase branch name with only letters and dashes"
    - name: CURRENT_BUILD_NUMBER
      type: string
    - name: BASE_IMAGE
      description: The base image for the task.
      type: string
      default: bitnami/kubectl:1.25.2
  steps:
    - name: update-cbis
      image: $(params.BASE_IMAGE)
      env:
        - name: CBB_NAME
          value: "$(params.CODEBASEBRANCH_NAME)"
        - name: CURRENT_BUILD_NUMBER
          value: "$(params.CURRENT_BUILD_NUMBER)"
      script: |
        #!/usr/bin/env bash
        set -ex

        kubectl patch codebasebranches.v2.edp.epam.com ${CBB_NAME} \
        --subresource=status \
        --type=merge \
        -p "{\"status\": {\"lastSuccessfulBuild\": \"${CURRENT_BUILD_NUMBER}\"}}"
---
# Source: edp-tekton/templates/tasks/update-cbis.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-cbis
spec:
  params:
    - name: CBIS_NAME
      type: string
      description: "Codebase name with only letters and dashes"
    - name: IMAGE_TAG
      type: string
    - name: BASE_IMAGE
      description: The base image for the task.
      type: string
      default: bitnami/kubectl:1.25.2
  steps:
    - name: update-cbis
      image: $(params.BASE_IMAGE)
      env:
        - name: CBIS_NAME
          value: "$(params.CBIS_NAME)"
        - name: IMAGE_TAG
          value: "$(params.IMAGE_TAG)"
      script: |
        #!/usr/bin/env bash
        set -e

        cbisCrTags=$(kubectl get cbis.v2.edp.epam.com ${CBIS_NAME} --output=jsonpath={.spec.tags})
        dateFormat=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
        newcbisTag="{\"name\":\"${IMAGE_TAG}\",\"created\":\"${dateFormat}\"}"

        if [ "${cbisCrTags}" = "" ] ; then
            echo "[TEKTON][DEBUG] There're no tags in imageStream ${CBIS_NAME} ... the first one will be added."
            kubectl patch cbis.v2.edp.epam.com ${CBIS_NAME} --type=merge -p "{\"spec\":{\"tags\":[${newcbisTag}]}}"
        fi

        cbisTagsList=$(kubectl get cbis.v2.edp.epam.com ${CBIS_NAME} --output=jsonpath={.spec.tags[*].name})
        if [[ ! ${cbisTagsList} == *"${IMAGE_TAG}"* ]]; then
            echo "[TEKTON][DEBUG] ImageStream ${CBIS_NAME} doesn't contain ${IMAGE_TAG} tag ... it will be added."
            kubectl patch cbis.v2.edp.epam.com ${CBIS_NAME} --type json -p="[{\"op\": \"add\", \"path\": \"/spec/tags/-\", \"value\": ${newcbisTag} }]"
        fi
---
# Source: edp-tekton/templates/triggers/gerrit/trigger-build.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: Trigger
metadata:
  name: gerrit-build
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  interceptors:
    - ref:
        name: "cel"
      params:
        - name: "filter"
          value: "body.change.status in ['MERGED']"
    - ref:
        name: "edp"
        kind: NamespacedInterceptor
    - ref:
        name: "cel"
      params:
        - name: "overlays"
          value:
          - key: cbtype_short
            expression: "extensions.spec.type.truncate(3)"
  bindings:
    - ref: gerrit-binding-build
  template:
    ref: gerrit-build-template
---
# Source: edp-tekton/templates/triggers/gerrit/trigger-review.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: Trigger
metadata:
  name: gerrit-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  interceptors:
    - ref:
        name: "cel"
      params:
        - name: "filter"
          value: "body.change.status in ['NEW']"
    - ref:
        name: "edp"
        kind: NamespacedInterceptor
    - ref:
        name: "cel"
      params:
        - name: "overlays"
          value:
            - key: cbtype_short
              expression: "extensions.spec.type.truncate(3)"
  bindings:
    - ref: gerrit-binding-review
  template:
    ref: gerrit-review-template
---
# Source: edp-tekton/templates/triggers/github/trigger-build.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: Trigger
metadata:
  name: github-build
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  interceptors:
    - ref:
        name: "github"
      params:
        - name: "secretRef"
          value:
            secretName: ci-github
            secretKey: secretString
        - name: "eventTypes"
          value: ["pull_request"]
    - ref:
        name: "cel"
      params:
        - name: "filter"
          value: "body.action in ['closed'] && body.pull_request.merged == true"
    - ref:
        name: "edp"
        kind: NamespacedInterceptor
    - ref:
        name: "cel"
      params:
        - name: "overlays"
          value:
            - key: cbtype_short
              expression: "extensions.spec.type.truncate(3)"
  bindings:
    - ref: github-binding-build
  template:
    ref: github-build-template
---
# Source: edp-tekton/templates/triggers/github/trigger-review.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: Trigger
metadata:
  name: github-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  interceptors:
    - ref:
        name: "github"
      params:
        - name: "secretRef"
          value:
            secretName: ci-github
            secretKey: secretString
        - name: "eventTypes"
          value: ["pull_request", "issue_comment"]
    - ref:
        name: "cel"
      params:
        - name: "filter"
          value: "body.action in ['opened', 'synchronize', 'created']"
    - ref:
        name: "edp"
        kind: NamespacedInterceptor
    - ref:
        name: "cel"
      params:
        - name: "overlays"
          value:
            - key: cbtype_short
              expression: "extensions.spec.type.truncate(3)"
  bindings:
    - ref: github-binding-review
  template:
    ref: github-review-template
---
# Source: edp-tekton/templates/triggers/gitlab/trigger-build.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: Trigger
metadata:
  name: gitlab-build
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  interceptors:
    - ref:
        name: "gitlab"
      params:
        - name: "secretRef"
          value:
            secretName: ci-gitlab
            secretKey: secretString
        - name: "eventTypes"
          value: ["Merge Request Hook"]
    - ref:
        name: "cel"
      params:
        - name: "filter"
          value: "body.object_attributes.action in ['merge']"
    - ref:
        name: "edp"
        kind: NamespacedInterceptor
    - ref:
        name: "cel"
      params:
        - name: "overlays"
          value:
          - key: cbtype_short
            expression: "extensions.spec.type.truncate(3)"
  bindings:
    - ref: gitlab-binding-build
  template:
    ref: gitlab-build-template
---
# Source: edp-tekton/templates/triggers/gitlab/trigger-review.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: Trigger
metadata:
  name: gitlab-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  interceptors:
    - ref:
        name: "gitlab"
      params:
        - name: "secretRef"
          value:
            secretName: ci-gitlab
            secretKey: secretString
        - name: "eventTypes"
          value: ["Merge Request Hook", "Note Hook"]
    - ref:
        name: "cel"
      params:
        - name: "filter"
          value: "body.object_attributes.action in ['open', 'reopen', 'update'] || (body.object_kind == 'note' && has(body.merge_request))"
    - ref:
        name: "edp"
        kind: NamespacedInterceptor
    - ref:
        name: "cel"
      params:
        - name: "overlays"
          value:
          - key: cbtype_short
            expression: "extensions.spec.type.truncate(3)"
  bindings:
    - ref: gitlab-binding-review
  template:
    ref: gitlab-review-template
---
# Source: edp-tekton/templates/triggers/gerrit/triggerbinding-build.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerBinding
metadata:
  name: gerrit-binding-build
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  params:
    - name: gitrevision
      value: "$(body.change.branch)"
    - name: gerritproject
      value: "$(body.change.project)"
    - name: buildtool
      value: "$(extensions.spec.buildTool)"
    - name: framework
      value: "$(extensions.spec.framework)"
    # Truncated cbtype type name to reduce string length
    - name: cbtype
      value: "$(extensions.cbtype_short)"
    - name: versioning-type
      value: "$(extensions.spec.versioning.type)"
    - name: changeNumber
      value: "$(body.change.number)"
    - name: patchsetNumber
      value: "$(body.patchSet.number)"
    - name: codebase
      value: "$(extensions.codebase)"
    - name: codebasebranch
      value: "$(extensions.codebasebranch)"
    # commitMessage is used for 'push-to-jira' Task
    - name: commitMessage
      value: "$(body.change.commitMessage)"
    # commitMessagePattern is used for 'commit-validate' Tasks
    - name: commitMessagePattern
      value: "$(extensions.spec.commitMessagePattern)"
    # jiraIssueMetadataPayload is used for 'push-to-jira' Task
    - name: jiraIssueMetadataPayload
      value: "$(extensions.spec.jiraIssueMetadataPayload)"
    # ticketNamePattern is used for 'push-to-jira' Task
    - name: ticketNamePattern
      value: "$(extensions.spec.ticketNamePattern)"
    # jiraServer is used for 'push-to-jira' Task
    - name: jiraServer
      value: "$(extensions.spec.jiraServer)"
---
# Source: edp-tekton/templates/triggers/gerrit/triggerbinding-review.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerBinding
metadata:
  name: gerrit-binding-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  params:
    - name: gitrevision
      value: "FETCH_HEAD"
    - name: gerritproject
      value: "$(body.change.project)"
    - name: gerritrefspec
      value: "$(body.patchSet.ref)"
    - name: buildtool
      value: "$(extensions.spec.buildTool)"
    - name: framework
      value: "$(extensions.spec.framework)"
    # Truncated cbtype type name to reduce string length
    - name: cbtype
      value: "$(extensions.cbtype_short)"
    - name: targetBranch
      value: "$(body.change.branch)"
    - name: changeNumber
      value: "$(body.change.number)"
    - name: patchsetNumber
      value: "$(body.patchSet.number)"
    - name: commitMessage
      value: "$(body.change.commitMessage)"
    - name: commitMessagePattern
      value: "$(extensions.spec.commitMessagePattern)"
    - name: codebase
      value: "$(extensions.codebase)"
    - name: codebasebranch
      value: "$(extensions.codebasebranch)"
---
# Source: edp-tekton/templates/triggers/github/triggerbinding-build.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerBinding
metadata:
  name: github-binding-build
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  params:
    - name: gitrevision
      value: "$(body.pull_request.base.ref)"
    - name: gitrepositoryurl
      value: "$(body.repository.ssh_url)"
    - name: gitrepositoryname
      value: "$(body.repository.name)"
    - name: buildtool
      value: "$(extensions.spec.buildTool)"
    - name: framework
      value: "$(extensions.spec.framework)"
    # Truncated cbtype type name to reduce string length
    - name: cbtype
      value: "$(extensions.cbtype_short)"
    - name: versioning-type
      value: "$(extensions.spec.versioning.type)"
    - name: codebase
      value: "$(extensions.codebase)"
    - name: codebasebranch
      value: "$(extensions.codebasebranch)"
    # commitMessage is used for 'push-to-jira' Task
    - name: commitMessage
      value: "$(body.pull_request.title)"
    # commitMessagePattern is used for 'commit-validate' Tasks
    - name: commitMessagePattern
      value: "$(extensions.spec.commitMessagePattern)"
    # jiraIssueMetadataPayload is used for 'push-to-jira' Task
    - name: jiraIssueMetadataPayload
      value: "$(extensions.spec.jiraIssueMetadataPayload)"
    # ticketNamePattern is used for 'push-to-jira' Task
    - name: ticketNamePattern
      value: "$(extensions.spec.ticketNamePattern)"
    # jiraServer is used for 'push-to-jira' Task
    - name: jiraServer
      value: "$(extensions.spec.jiraServer)"
---
# Source: edp-tekton/templates/triggers/github/triggerbinding-review.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerBinding
metadata:
  name: github-binding-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  params:
    - name: gitrevision
      value: $(extensions.pullRequest.headRef)
    - name: gitrepositoryurl
      value: $(body.repository.ssh_url)
    - name: gitrepositoryname
      value: $(body.repository.name)
    - name: gitfullrepositoryname
      value: $(body.repository.full_name)
    - name: gitsha
      value: $(extensions.pullRequest.headSha)
    - name: targetBranch
      value: "$(extensions.targetBranch)"
    - name: changeNumber
      value: "$(extensions.pullRequest.changeNumber)"
    - name: buildtool
      value: "$(extensions.spec.buildTool)"
    - name: framework
      value: "$(extensions.spec.framework)"
    # Truncated cbtype type name to reduce string length
    - name: cbtype
      value: "$(extensions.cbtype_short)"
    - name: commitMessage
      value: "$(extensions.pullRequest.lastCommitMessage)"
    - name: commitMessagePattern
      value: "$(extensions.spec.commitMessagePattern)"
    - name: codebase
      value: "$(extensions.codebase)"
    - name: codebasebranch
      value: "$(extensions.codebasebranch)"
---
# Source: edp-tekton/templates/triggers/gitlab/triggerbinding-build.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerBinding
metadata:
  name: gitlab-binding-build
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  params:
    - name: gitrevision
      value: $(body.object_attributes.target_branch)
    - name: gitrepositoryurl
      value: $(body.project.git_ssh_url)
    - name: gitrepositoryname
      value: $(body.project.name)
    - name: buildtool
      value: "$(extensions.spec.buildTool)"
    - name: framework
      value: "$(extensions.spec.framework)"
    - name: cbtype
      value: "$(extensions.cbtype_short)"
    - name: versioning-type
      value: "$(extensions.spec.versioning.type)"
    - name: codebase
      value: "$(extensions.codebase)"
    - name: codebasebranch
      value: "$(extensions.codebasebranch)"
    # commitMessage is used for 'push-to-jira' Task
    - name: commitMessage
      value: "$(body.object_attributes.title)"
    # commitMessagePattern is used for 'commit-validate' Tasks
    - name: commitMessagePattern
      value: "$(extensions.spec.commitMessagePattern)"
    # jiraIssueMetadataPayload is used for 'push-to-jira' Task
    - name: jiraIssueMetadataPayload
      value: "$(extensions.spec.jiraIssueMetadataPayload)"
    # ticketNamePattern is used for 'push-to-jira' Task
    - name: ticketNamePattern
      value: "$(extensions.spec.ticketNamePattern)"
    # jiraServer is used for 'push-to-jira' Task
    - name: jiraServer
      value: "$(extensions.spec.jiraServer)"
---
# Source: edp-tekton/templates/triggers/gitlab/triggerbinding-review.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerBinding
metadata:
  name: gitlab-binding-review
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  params:
    - name: gitrevision
      value: "$(extensions.pullRequest.headSha)"
    - name: gitrepositoryurl
      value: $(body.project.git_ssh_url)
    - name: gitrepositoryname
      value: $(body.project.name)
    - name: gitfullrepositoryname
      value: $(body.project.path_with_namespace)
    - name: targetBranch
      value: "$(extensions.targetBranch)"
    - name: changeNumber
      value: "$(extensions.pullRequest.changeNumber)"
    - name: buildtool
      value: "$(extensions.spec.buildTool)"
    - name: framework
      value: "$(extensions.spec.framework)"
    # Truncated cbtype type name to reduce string length
    - name: cbtype
      value: "$(extensions.cbtype_short)"
    - name: commitMessagePattern
      value: "$(extensions.spec.commitMessagePattern)"
    - name: commitMessage
      value: "$(extensions.pullRequest.lastCommitMessage)"
    - name: codebase
      value: "$(extensions.codebase)"
    - name: codebasebranch
      value: "$(extensions.codebasebranch)"
---
# Source: edp-tekton/templates/triggers/cd/deploy-with-autotests.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: deploy-with-autotests
  labels:
    app.edp.epam.com/pipelinetype: deploy
spec:
  params:
    - name: CDPIPELINE
      description: |
        EDP kind:CDPipeline name used for deployment. For example: mypipe, myfeature
    - name: CDSTAGE
      description: |
        EDP kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: {"codebase1": {"imageTag": "version1", "customValues": true}, "codebase2": {"imageTag": "version2", "customValues": true}}. For example: {"demo": {"imageTag": "main-20240103-141431", "customValues": true}, "myapp": {"imageTag": "0.1.0-SNAPSHOT.1", "customValues": true}}
    - name: KUBECONFIG_SECRET_NAME
      description: The name of secret with Kubeconfig to connect to the remote cluster
  resourcetemplates:
    - apiVersion: tekton.dev/v1
      kind: PipelineRun
      metadata:
        generateName: deploy-$(tt.params.CDPIPELINE)-$(tt.params.CDSTAGE)-auto-
        labels:
          app.edp.epam.com/cdpipeline: $(tt.params.CDPIPELINE)
          app.edp.epam.com/cdstage: $(tt.params.CDPIPELINE)-$(tt.params.CDSTAGE)
          app.edp.epam.com/pipelinetype: deploy
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
      spec:
        taskRunTemplate:
          serviceAccountName: tekton
        pipelineRef:
          name: deploy-with-autotests
        params:
          - name: APPLICATIONS_PAYLOAD
            value: $(tt.params.APPLICATIONS_PAYLOAD)
          - name: CDSTAGE
            value: $(tt.params.CDSTAGE)
          - name: CDPIPELINE
            value: $(tt.params.CDPIPELINE)
          - name: KUBECONFIG_SECRET_NAME
            value: $(tt.params.KUBECONFIG_SECRET_NAME)
        timeouts:
          pipeline: 1h00m0s
        workspaces:
          - name: shared-workspace
            volumeClaimTemplate:
              spec:
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: "1Gi"
            subPath: codebase
---
# Source: edp-tekton/templates/triggers/cd/deploy.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: deploy
  labels:
    app.edp.epam.com/pipelinetype: deploy
spec:
  params:
    - name: CDPIPELINE
      description: |
        EDP kind:CDPipeline name used for deployment. For example: mypipe, myfeature
    - name: CDSTAGE
      description: |
        EDP kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: {"codebase1": {"imageTag": "version1", "customValues": true}, "codebase2": {"imageTag": "version2", "customValues": true}}. For example: {"demo": {"imageTag": "main-20240103-141431", "customValues": true}, "myapp": {"imageTag": "0.1.0-SNAPSHOT.1", "customValues": true}}
    - name: KUBECONFIG_SECRET_NAME
      description: The name of secret with Kubeconfig to connect to the remote cluster
  resourcetemplates:
    - apiVersion: tekton.dev/v1
      kind: PipelineRun
      metadata:
        generateName: deploy-$(tt.params.CDPIPELINE)-$(tt.params.CDSTAGE)-
        labels:
          app.edp.epam.com/cdpipeline: $(tt.params.CDPIPELINE)
          app.edp.epam.com/cdstage: $(tt.params.CDPIPELINE)-$(tt.params.CDSTAGE)
          app.edp.epam.com/pipelinetype: deploy
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
      spec:
        taskRunTemplate:
          serviceAccountName: tekton
        pipelineRef:
          name: deploy
        params:
          - name: APPLICATIONS_PAYLOAD
            value: $(tt.params.APPLICATIONS_PAYLOAD)
          - name: CDSTAGE
            value: $(tt.params.CDSTAGE)
          - name: CDPIPELINE
            value: $(tt.params.CDPIPELINE)
          - name: KUBECONFIG_SECRET_NAME
            value: $(tt.params.KUBECONFIG_SECRET_NAME)
        timeouts:
          pipeline: 1h00m0s
---
# Source: edp-tekton/templates/triggers/gerrit/tt-build.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: gerrit-build-template
spec:
  params:
    - name: gitrevision
      description: The git revision
      default: master
    - name: gerritproject
      description: Gerrit project name
    - name: buildtool
      description: Build tool for codebase. Used to generate build pipeline name. Populated by edp interceptor
    - name: framework
      description: Framework for codebase. Used to generate build pipeline name. Populated by edp interceptor
    - name: cbtype
      description: Application or library type for codebase. Used to generate build pipeline name. Populated by edp interceptor
    - name: versioning-type
      description: Versioning type for codebase. Used to generate build pipeline name. Populated by edp interceptor
    - name: codebase
      description: Codebase name used in pipeline
    - name: codebasebranch
      description: Codebasebranch name used in pipeline
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: ticketNamePattern
      description: Ticket name pattern
    - name: commitMessagePattern
      description: Commit message pattern to run commit-validate task
    - name: commitMessage
      description: Commit message
    - name: jiraIssueMetadataPayload
      description: Jira issue payload
    - name: jiraServer
      description: Jira server name
  resourcetemplates:
    - apiVersion: tekton.dev/v1
      kind: PipelineRun
      metadata:
        generateName: $(tt.params.codebasebranch)-build-
        labels:
          # used by UI to sort pipelines for codebasebranches
          app.edp.epam.com/codebasebranch: $(tt.params.codebasebranch)
          app.edp.epam.com/codebase: $(tt.params.codebase)
          app.edp.epam.com/pipelinetype: build
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
      spec:
        taskRunTemplate:
          serviceAccountName: tekton
        pipelineRef:
          name: gerrit-$(tt.params.buildtool)-$(tt.params.framework)-$(tt.params.cbtype)-build-$(tt.params.versioning-type)
        params:
          - name: git-source-url
            value: "ssh://edp-ci@gerrit:/$(tt.params.gerritproject)"
          - name: git-source-revision
            value: $(tt.params.gitrevision)
          - name: CODEBASE_NAME
            value: $(tt.params.codebase)
          - name: CODEBASEBRANCH_NAME
            value: $(tt.params.codebasebranch)
          - name: changeNumber
            value: $(tt.params.changeNumber)
          - name: patchsetNumber
            value: $(tt.params.patchsetNumber)
          - name: TICKET_NAME_PATTERN
            value: $(tt.params.ticketNamePattern)
          - name: COMMIT_MESSAGE_PATTERN
            value: $(tt.params.commitMessagePattern)
          - name: COMMIT_MESSAGE
            value: $(tt.params.commitMessage)
          - name: JIRA_ISSUE_METADATA_PAYLOAD
            value: $(tt.params.jiraIssueMetadataPayload)
          - name: JIRA_SERVER
            value: $(tt.params.jiraServer)
        workspaces:
          - name: shared-workspace
            volumeClaimTemplate:
              spec:
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 5Gi
            subPath: codebase
          - name: ssh-creds
            secret:
              secretName: gerrit-ciuser-sshkey
---
# Source: edp-tekton/templates/triggers/gerrit/tt-review.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: gerrit-review-template
spec:
  params:
    - name: gitrevision
      description: The git revision
      default: master
    - name: gerritproject
      description: Gerrit project name
    - name: gerritrefspec
      description: Gerrit PatchSet Reference in format "refs/changes/62/62/2"
    - name: buildtool
      description: Build tool for codebase. Used to generate code-review pipeline name. Populated by edp interceptor
    - name: framework
      description: Framework for codebase. Used to generate code-review pipeline name. Populated by edp interceptor
    - name: cbtype
      description: Application or library type for codebase. Used to generate build pipeline name. Populated by edp interceptor
    - name: targetBranch
      description: Target branch of Merge Request
    - name: codebase
      description: Codebase name used in pipeline
    - name: codebasebranch
      description: Codebasebranch name used in pipeline
    - name: changeNumber
      description: Change number from Merge Request
    - name: patchsetNumber
      description: Patchset number from Merge Request
    - name: commitMessage
      description: Commit message
    - name: commitMessagePattern
      description: Commit message pattern to run commit-validate task
  resourcetemplates:
    - apiVersion: tekton.dev/v1
      kind: PipelineRun
      metadata:
        generateName: $(tt.params.codebasebranch)-review-
        labels:
          # used by UI to sort pipelines for codebasebranches
          app.edp.epam.com/codebasebranch: $(tt.params.codebasebranch)
          app.edp.epam.com/codebase: $(tt.params.codebase)
          app.edp.epam.com/pipelinetype: review
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
      spec:
        taskRunTemplate:
          serviceAccountName: tekton
        pipelineRef:
          name: gerrit-$(tt.params.buildtool)-$(tt.params.framework)-$(tt.params.cbtype)-review
        params:
          - name: git-source-url
            value: "ssh://edp-ci@gerrit:/$(tt.params.gerritproject)"
          - name: git-source-revision
            value: $(tt.params.gitrevision)
          - name: git-refspec
            value: $(tt.params.gerritrefspec)
          - name: CODEBASE_NAME
            value: $(tt.params.codebase)
          - name: CODEBASEBRANCH_NAME
            value: $(tt.params.codebasebranch)
          - name: targetBranch
            value: $(tt.params.targetBranch)
          - name: changeNumber
            value: $(tt.params.changeNumber)
          - name: patchsetNumber
            value: $(tt.params.patchsetNumber)
          - name: COMMIT_MESSAGE
            value: $(tt.params.commitMessage)
          - name: COMMIT_MESSAGE_PATTERN
            value: $(tt.params.commitMessagePattern)
        workspaces:
          - name: shared-workspace
            volumeClaimTemplate:
              spec:
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 5Gi
            subPath: codebase
          - name: ssh-creds
            secret:
              secretName: gerrit-ciuser-sshkey
---
# Source: edp-tekton/templates/triggers/github/tt-build.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: github-build-template
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  params:
    - name: gitrevision
    - name: gitrepositoryurl
    - name: gitrepositoryname
    - name: buildtool
      description: Build tool for codebase. Used to generate build pipeline name. Populated by edp interceptor
    - name: framework
      description: Framework for codebase. Used to generate build pipeline name. Populated by edp interceptor
    - name: cbtype
      description: Application or library type for codebase. Used to generate build pipeline name. Populated by edp interceptor
    - name: versioning-type
      description: Versioning type for codebase. Used to generate build pipeline name. Populated by edp interceptor
    - name: codebase
      description: Codebase name used in pipeline
    - name: codebasebranch
      description: Codebasebranch name used in pipeline
    - name: ticketNamePattern
      description: Ticket name pattern
    - name: commitMessagePattern
      description: Commit message pattern to run commit-validate task
    - name: commitMessage
      description: Commit message
    - name: jiraIssueMetadataPayload
      description: Jira issue payload
    - name: jiraServer
      description: Jira server name
  resourcetemplates:
    - apiVersion: tekton.dev/v1
      kind: PipelineRun
      metadata:
        generateName: $(tt.params.codebasebranch)-build-
        labels:
          # used by UI to sort pipelines for codebasebranches
          app.edp.epam.com/codebasebranch: $(tt.params.codebasebranch)
          app.edp.epam.com/codebase: $(tt.params.codebase)
          app.edp.epam.com/pipelinetype: build
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
      spec:
        taskRunTemplate:
          serviceAccountName: tekton
        pipelineRef:
          name: github-$(tt.params.buildtool)-$(tt.params.framework)-$(tt.params.cbtype)-build-$(tt.params.versioning-type)
        params:
          - name: git-source-url
            value: $(tt.params.gitrepositoryurl)
          - name: git-source-revision
            value: $(tt.params.gitrevision)
          - name: CODEBASE_NAME
            value: $(tt.params.codebase)
          - name: CODEBASEBRANCH_NAME
            value: $(tt.params.codebasebranch)
          - name: TICKET_NAME_PATTERN
            value: $(tt.params.ticketNamePattern)
          - name: COMMIT_MESSAGE_PATTERN
            value: $(tt.params.commitMessagePattern)
          - name: COMMIT_MESSAGE
            value: $(tt.params.commitMessage)
          - name: JIRA_ISSUE_METADATA_PAYLOAD
            value: $(tt.params.jiraIssueMetadataPayload)
          - name: JIRA_SERVER
            value: $(tt.params.jiraServer)
        workspaces:
          - name: shared-workspace
            volumeClaimTemplate:
              spec:
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 5Gi
            subPath: codebase
          - name: ssh-creds
            secret:
              secretName: ci-github
---
# Source: edp-tekton/templates/triggers/github/tt-review.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: github-review-template
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  params:
    - name: gitrevision
    - name: gitrepositoryurl
    - name: gitrepositoryname
    - name: gitfullrepositoryname
    - name: gitsha
    - name: buildtool
      description: Build tool for codebase. Used to generate code-review pipeline name. Populated by edp interceptor
    - name: framework
      description: Framework for codebase. Used to generate code-review pipeline name. Populated by edp interceptor
    - name: cbtype
      description: Application or library type for codebase. Used to generate build pipeline name. Populated by edp interceptor
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: codebase
      description: Codebase name used in pipeline
    - name: codebasebranch
      description: Codebasebranch name used in pipeline
    - name: commitMessagePattern
      description: Commit message pattern to run commit-validate task
    - name: commitMessage
      description: Commit message
  resourcetemplates:
    - apiVersion: tekton.dev/v1
      kind: PipelineRun
      metadata:
        generateName: $(tt.params.codebasebranch)-review-
        labels:
          # used by UI to sort pipelines for codebasebranches
          app.edp.epam.com/codebasebranch: $(tt.params.codebasebranch)
          app.edp.epam.com/codebase: $(tt.params.codebase)
          app.edp.epam.com/pipelinetype: review
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
      spec:
        taskRunTemplate:
          serviceAccountName: tekton
        pipelineRef:
          name: github-$(tt.params.buildtool)-$(tt.params.framework)-$(tt.params.cbtype)-review
        params:
          - name: git-source-url
            value: $(tt.params.gitrepositoryurl)
          - name: git-source-revision
            value: $(tt.params.gitrevision)
          - name: CODEBASE_NAME
            value: $(tt.params.codebase)
          - name: CODEBASEBRANCH_NAME
            value: $(tt.params.codebasebranch)
          - name: targetBranch
            value: $(tt.params.targetBranch)
          - name: changeNumber
            value: $(tt.params.changeNumber)
          - name: gitfullrepositoryname
            value: $(tt.params.gitfullrepositoryname)
          - name: gitsha
            value: $(tt.params.gitsha)
          - name: COMMIT_MESSAGE_PATTERN
            value: $(tt.params.commitMessagePattern)
          - name: COMMIT_MESSAGE
            value: $(tt.params.commitMessage)
        workspaces:
          - name: shared-workspace
            volumeClaimTemplate:
              spec:
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 5Gi
            subPath: codebase
          - name: ssh-creds
            secret:
              secretName: ci-github
---
# Source: edp-tekton/templates/triggers/gitlab/tt-build.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: gitlab-build-template
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  params:
    - name: gitrevision
    - name: gitrepositoryurl
    - name: gitrepositoryname
    - name: buildtool
      description: Build tool for codebase. Used to generate build pipeline name. Populated by edp interceptor
    - name: framework
      description: Framework for codebase. Used to generate build pipeline name. Populated by edp interceptor
    - name: cbtype
      description: Application or library type for codebase. Used to generate build pipeline name. Populated by edp interceptor
    - name: versioning-type
      description: Versioning type for codebase. Used to generate build pipeline name. Populated by edp interceptor
    - name: codebase
      description: Codebase name used in pipeline
    - name: codebasebranch
      description: Codebasebranch name used in pipeline
    - name: ticketNamePattern
      description: Ticket name pattern
    - name: commitMessagePattern
      description: Commit message pattern to run commit-validate task
    - name: commitMessage
      description: Commit message
    - name: jiraIssueMetadataPayload
      description: Jira issue payload
    - name: jiraServer
      description: Jira server name
  resourcetemplates:
    - apiVersion: tekton.dev/v1
      kind: PipelineRun
      metadata:
        generateName: $(tt.params.codebasebranch)-build-
        labels:
          # used by UI to sort pipelines for codebasebranches
          app.edp.epam.com/codebasebranch: $(tt.params.codebasebranch)
          app.edp.epam.com/codebase: $(tt.params.codebase)
          app.edp.epam.com/pipelinetype: build
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
      spec:
        taskRunTemplate:
          serviceAccountName: tekton
        pipelineRef:
          name: gitlab-$(tt.params.buildtool)-$(tt.params.framework)-$(tt.params.cbtype)-build-$(tt.params.versioning-type)
        params:
          - name: git-source-url
            value: $(tt.params.gitrepositoryurl)
          - name: git-source-revision
            value: $(tt.params.gitrevision)
          - name: CODEBASE_NAME
            value: $(tt.params.codebase)
          - name: CODEBASEBRANCH_NAME
            value: $(tt.params.codebasebranch)
          - name: TICKET_NAME_PATTERN
            value: $(tt.params.ticketNamePattern)
          - name: COMMIT_MESSAGE_PATTERN
            value: $(tt.params.commitMessagePattern)
          - name: COMMIT_MESSAGE
            value: $(tt.params.commitMessage)
          - name: JIRA_ISSUE_METADATA_PAYLOAD
            value: $(tt.params.jiraIssueMetadataPayload)
          - name: JIRA_SERVER
            value: $(tt.params.jiraServer)
        workspaces:
          - name: shared-workspace
            volumeClaimTemplate:
              spec:
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 5Gi
            subPath: codebase
          - name: ssh-creds
            secret:
              secretName: ci-gitlab
---
# Source: edp-tekton/templates/triggers/gitlab/tt-review.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: gitlab-review-template
  labels:
    helm.sh/chart: edp-tekton-0.12.0
    app.kubernetes.io/version: "0.12.0"
    app.kubernetes.io/managed-by: Helm
spec:
  params:
    - name: gitrevision
    - name: gitrepositoryurl
    - name: gitrepositoryname
    - name: gitfullrepositoryname
      description: Full Repo name. Used in "gitlab-set-status" step as REPO_PATH_ONLY
    - name: buildtool
      description: Build tool for codebase. Used to generate build pipeline name. Populated by edp interceptor
    - name: framework
      description: Framework for codebase. Used to generate build pipeline name. Populated by edp interceptor
    - name: cbtype
      description: Application or library type for codebase. Used to generate build pipeline name. Populated by edp interceptor
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: codebase
      description: Codebase name used in pipeline
    - name: codebasebranch
      description: Codebasebranch name used in pipeline
    - name: commitMessagePattern
      description: Commit message pattern to run commit-validate task
    - name: commitMessage
      description: Commit message
  resourcetemplates:
    - apiVersion: tekton.dev/v1
      kind: PipelineRun
      metadata:
        generateName: $(tt.params.codebasebranch)-review-
        labels:
          # used by UI to sort pipelines for codebasebranches
          app.edp.epam.com/codebasebranch: $(tt.params.codebasebranch)
          app.edp.epam.com/codebase: $(tt.params.codebase)
          app.edp.epam.com/pipelinetype: review
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
      spec:
        taskRunTemplate:
          serviceAccountName: tekton
        pipelineRef:
          name: gitlab-$(tt.params.buildtool)-$(tt.params.framework)-$(tt.params.cbtype)-review
        params:
          - name: git-source-url
            value: $(tt.params.gitrepositoryurl)
          - name: git-source-revision
            value: $(tt.params.gitrevision)
          - name: CODEBASE_NAME
            value: $(tt.params.codebase)
          - name: CODEBASEBRANCH_NAME
            value: $(tt.params.codebasebranch)
          - name: targetBranch
            value: $(tt.params.targetBranch)
          - name: changeNumber
            value: $(tt.params.changeNumber)
          - name: gitfullrepositoryname
            value: $(tt.params.gitfullrepositoryname)
          - name: COMMIT_MESSAGE_PATTERN
            value: $(tt.params.commitMessagePattern)
          - name: COMMIT_MESSAGE
            value: $(tt.params.commitMessage)
        workspaces:
          - name: shared-workspace
            volumeClaimTemplate:
              spec:
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 5Gi
            subPath: codebase
          - name: ssh-creds
            secret:
              secretName: ci-gitlab
