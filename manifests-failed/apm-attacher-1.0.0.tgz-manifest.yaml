---
# Source: apm-attacher/templates/webhook.yaml
apiVersion: v1
kind: Secret
metadata:
  name: my-release
  namespace: apm-attacher-1.0.0.tgz
  labels:    
    app.kubernetes.io/name: my-release
    app.kubernetes.io/component: webhook
    app.kubernetes.io/instance: my-release
data:
  cert.pem: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURTekNDQWpPZ0F3SUJBZ0lRWW5RUXowc1ZHTStrTkE0TFFnMjlUakFOQmdrcWhraUc5dzBCQVFzRkFEQVkKTVJZd0ZBWURWUVFERXcxdGVTMXlaV3hsWVhObExXTmhNQjRYRFRJME1EWXlNREUwTlRVd01sb1hEVE0wTURZeApPREUwTlRVd01sb3dGVEVUTUJFR0ExVUVBeE1LYlhrdGNtVnNaV0Z6WlRDQ0FTSXdEUVlKS29aSWh2Y05BUUVCCkJRQURnZ0VQQURDQ0FRb0NnZ0VCQU1RdjRYcVBSd2htWjBtNXdDQVZpSElCdyt0ODgweiticU84Z2xGMllJNHcKWUVSam82dGFqMTBGRDg5S3dTc2FCZUNHazRpYy9HWndyV2dQZTlYVlg1OVlRNFgvSlY1M2NsNnAxeVlucDgwbAoxRk1YT09DOEdNeXNRMk40UmNTZHFYVVo3MC8rT0RGNGYxUk5SeVZDdzd4ZUZWSjcxM1FTeER3RDVaSUxCM04zClduYjA1UVZlSE41V3YzRGlDcDVlaHFzTEZMbksySVJkSDN5bGJGL1d0SjZzck1QTFdYTTZYaDZ4NFlvUjZ6dXIKZFlWbEd5OWh3UFRHc1BxRmZtVzRLZ29sSzlRbEJNcjl5eDVqYUhadTJoelN6d3V6RmViSjJMTTZjT1ByK3JkcApCRldrSmFhRmdDWTBUMmNVd0ovT3JaamlGYzltUllvUlNOL21LYzFSNnRVQ0F3RUFBYU9Ca3pDQmtEQU9CZ05WCkhROEJBZjhFQkFNQ0JhQXdIUVlEVlIwbEJCWXdGQVlJS3dZQkJRVUhBd0VHQ0NzR0FRVUZCd01DTUF3R0ExVWQKRXdFQi93UUNNQUF3SHdZRFZSMGpCQmd3Rm9BVXRMbXJlREVBUTF4bm8yS09zNGRhSForbStUY3dNQVlEVlIwUgpCQ2t3SjRJbGJYa3RjbVZzWldGelpTNWhjRzB0WVhSMFlXTm9aWEl0TVM0d0xqQXVkR2Q2TG5OMll6QU5CZ2txCmhraUc5dzBCQVFzRkFBT0NBUUVBUlNzWDZFRzZQYmttZTRHUVJ4ZU5WZjlyOTZIaGdMYjRMSmE5aHhWTStRZUgKbFlVcWJISUFvdnF5UWd4cTBVR05DcnlNQ1Bza3Q3YUxwVnRzQUsrRDZNZHdMWDVtOW8yTTBGd2wrdDFRaEdYVApEelJESWdJanJnSVI0Tm9Fc09OUk1GZlNoV3VrRUEvc1JESHBrRmN3VGhjSGd2cm9RUjhNdzZoMTNDbmtSdWVmClJGUWRqbGVYTzdpbWtQbFBGOVZrTWh0dGtsbUNIdG14LzJFeTFyajQ5a05pRDhONXlCZnNCaSs2UWhJV0Mrb2EKODhyMUtTcnoyQlJoNVpBYW1SWFFRaHIxajVaZlBBY0hNRUgySjNXQzJPRytoTFErMkpBcFdRY3MvMnVzMTFjUwoxQ09sZEZpbitqRjFpOS9FdXdmdXZidzk0YVZoNEY5ZmU0ZjdNVGpBUnc9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  key.pem: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBeEMvaGVvOUhDR1puU2JuQUlCV0ljZ0hENjN6elRQNXVvN3lDVVhaZ2pqQmdSR09qCnExcVBYUVVQejByQkt4b0Y0SWFUaUp6OFpuQ3RhQTk3MWRWZm4xaERoZjhsWG5keVhxblhKaWVuelNYVVV4YzQKNEx3WXpLeERZM2hGeEoycGRSbnZULzQ0TVhoL1ZFMUhKVUxEdkY0VlVudlhkQkxFUEFQbGtnc0hjM2RhZHZUbApCVjRjM2xhL2NPSUtubDZHcXdzVXVjclloRjBmZktWc1g5YTBucXlzdzh0WmN6cGVIckhoaWhIck82dDFoV1ViCkwySEE5TWF3K29WK1piZ3FDaVVyMUNVRXl2M0xIbU5vZG03YUhOTFBDN01WNXNuWXN6cHc0K3Y2dDJrRVZhUWwKcG9XQUpqUlBaeFRBbjg2dG1PSVZ6MlpGaWhGSTMrWXB6VkhxMVFJREFRQUJBb0lCQUNNRDdMbUVNd2hqeHBHWgpEcHByWFhRRHJxVXNJdnlkK0w5T21PL1RNZjZPMGMvQy9PWkxmb1Q2cjB5dktmVDRhdzRjMXQ0dUxycFY2QTFICm5qR1hLTDcyOE81TWtLM2dvZEFWZmluNEwvSGtpNVhjOGpEaVFZYmVSQlRQMVp2M0M5U3pzVXZVc3REWmtkaEoKQnFhMjJOcVk3RE5SbVMzRlg3TGFlekhxdUFTNmUwVUQ2YXllbzJUN0grdU9ISFdqendjL2Z2dDcyaXlhbzdmZQpGdFFCYVY0OGZCWFpTelNUbGZYT1drRjVQTXNlaXFGRklGa2U0U1lRc211eUFVWXd0dFRtcVZZOTV6VkdoZ083CndoYXRha1p3Z3NxT0FuS1Voc3ZVdFo0WEZKS1lGaEhFSHBUMVByUEt6OFh0Q0hxVlFPSFlJZjh6TmVIQ3REb2UKY1ZaSjBhRUNnWUVBK0lFMXk1OVBiYWF2anViV0dNWnNSNE9OMTUxWmQzZm5oVG9ZMUlnRzdGZkRPU21LczNDTwpCMHlVcU1XMlNYMGZvdXZqSUNxalZiWGMxYkE4ZDhYNkdLRnZzZ05sUk9YTS9Id3h3ODVVVlJpRjhleXRpZUJPCnFtNnNCZEh5S08xOUVqcWwrYmtkZFNjZURnN3k2Q29xeU9ubnB4UnBhZ0NyaGdNTisvanNsbGtDZ1lFQXlocTEKTnF1Z1AyTjFHRVpVc1h0K2Y4aEFnQW51VlYrYnN1K3IybG96OGpmYmpBVWRCRmQ4WUJIbnBNR1JUKzFEN3NyNQpydVRPcHdSN08vN2creEJlS2N4amZHRFJxaEl4clI3Y2ZTU2FETktEcnRwVGRmN0JpU3lhSGc3VXRWSi9XdUJ4Cm5NVUgxdmtEWmltRTlVcXZGclp3NTVsby9vaHhqdGY0bXFGeElOMENnWUJqM0lpaHF3TmdMUHVma1dPMzBRVHkKT0F0bitmTlo3dlU2dEg0RjZpUGVGZVo5c2hQcXgvQkxQcHIrdDNUcFV6N0RXY2VMeFphZGV0ZWpoNDdGRXVuTgp2QklHbHhhNitSM0cyS0dtN2VNMXp3VUVrdmVwMEZuTVkyejlhY0RHY2FreENpQm9tZHNjbVB1YTZxYnlaUCtNCmZYSjUwZG9LbnZwT2dDdStkZW1kQVFLQmdRQzR6RVVJa1ZQOHdoOXVxOWlEVk8xdFFCa2lPbkp3SS9VRlg3dGUKOC8zdHEvK1cvNUh4eDJFVm95bVJiK0ZFR1NwMXJha3lyMHI2VXRHd0lUVnN2Q0d0ekpMblJzeFAyMFVMREY0RwpHN0swcU1UNTIrNVd4VFFJRHYxNUlJeUVvOE9Kd0JLQ2kzTElzWGJYTW4yOW9LV0tlaFd3MzRpdXZPcEE5OS84CjNFUEtEUUtCZ0VYOEdnM0NkWENxNmZaQjVCZDQvalFUc0w3ODRKcGxjVWpTdkNmcTNwMk1TT3JyVWxzTE4xbEcKR2VOTHFvZnhROFJjbytaN1p4aFUvMU9DekJFVExETlA4VUdnZjB1T0wwblpZSzd3RHQ2bzEwaEd1R3puN1dlTwo4b2RjRFVXRFd3U1BuTUlhK0ViYUxpR3A0ZFVuSlByR2x2OUl0NG1FNy94TytCc0NPWldTCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
---
# Source: apm-attacher/templates/webhook.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: webhook-config
  namespace: apm-attacher-1.0.0.tgz
data:
  webhook.yaml: |
    agents:
      dotnet:
        artifact: /usr/agent/apm-dotnet-agent
        environment:
          CORECLR_ENABLE_PROFILING: "1"
          CORECLR_PROFILER: '{FA65FE15-F085-4681-9B20-95E04F6C03CC}'
          CORECLR_PROFILER_PATH: /usr/agent/apm-dotnet-agent/libelastic_apm_profiler.so
          ELASTIC_APM_PROFILER_HOME: /usr/agent/apm-dotnet-agent
          ELASTIC_APM_PROFILER_INTEGRATIONS: /usr/agent/apm-dotnet-agent/integrations.yml
        image: docker.elastic.co/observability/apm-agent-dotnet:latest
      java:
        artifact: /usr/agent/elastic-apm-agent.jar
        environment:
          JAVA_TOOL_OPTIONS: -javaagent:/elastic/apm/agent/elastic-apm-agent.jar
        image: docker.elastic.co/observability/apm-agent-java:latest
      nodejs:
        artifact: /opt/nodejs/node_modules/elastic-apm-node
        environment:
          NODE_OPTIONS: -r /elastic/apm/agent/elastic-apm-node/start
        image: docker.elastic.co/observability/apm-agent-nodejs:latest
---
# Source: apm-attacher/templates/webhook.yaml
apiVersion: v1
kind: Service
metadata:
  name: my-release
  namespace: apm-attacher-1.0.0.tgz
spec:
  publishNotReadyAddresses: true
  ports:
    - port: 443
      targetPort: https
  selector:    
    app.kubernetes.io/name: my-release
    app.kubernetes.io/component: webhook
    app.kubernetes.io/instance: my-release
---
# Source: apm-attacher/templates/webhook.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-release
  namespace: apm-attacher-1.0.0.tgz
  labels:    
    app.kubernetes.io/name: my-release
    app.kubernetes.io/component: webhook
    app.kubernetes.io/instance: my-release
spec:
  replicas: 1
  selector:
    matchLabels:      
      app.kubernetes.io/name: my-release
      app.kubernetes.io/component: webhook
      app.kubernetes.io/instance: my-release
  template:
    metadata:
      annotations:
        generated-cert: 852a1c2e900f7ef8bb44fa61db1449bc0493780dffa038f161ee474e88551b47
      labels:        
        app.kubernetes.io/name: my-release
        app.kubernetes.io/component: webhook
        app.kubernetes.io/instance: my-release
    spec:
      containers:
        - name: my-release
          image: "docker.elastic.co/observability/apm-attacher:v1.0.0"
          imagePullPolicy: Always
          args:
            - -certFile=/opt/webhook/certs/cert.pem
            - -keyFile=/opt/webhook/certs/key.pem
            - -config=/opt/webhook/config/webhook.yaml
          volumeMounts:
            - name: my-release-certs
              mountPath: /opt/webhook/certs
              readOnly: true
            - name: config
              mountPath: /opt/webhook/config
              readOnly: true
          ports:
            - name: https
              containerPort: 8443
              protocol: TCP
      volumes:
        - name: my-release-certs
          secret:
            secretName: my-release
        - name: config
          configMap:
            name: webhook-config
---
# Source: apm-attacher/templates/webhook.yaml
# This file is based on modifications to Kubernetes Mutating Webhook by Expedia, Inc., which is licensed under Apache 2.0.
# https://github.com/ExpediaGroup/kubernetes-sidecar-injector
---
# Source: apm-attacher/templates/webhook.yaml
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: my-release
  labels:    
    app.kubernetes.io/name: my-release
    app.kubernetes.io/component: webhook
    app.kubernetes.io/instance: my-release
webhooks:
  - name: my-release.apm-attacher-1.0.0.tgz.svc.cluster.local
    clientConfig:
      service:
        name: my-release
        namespace: apm-attacher-1.0.0.tgz
        path: "/"
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURIRENDQWdTZ0F3SUJBZ0lSQUwrajFrZjdtL2lsT0N6cjZCWGJwWEF3RFFZSktvWklodmNOQVFFTEJRQXcKR0RFV01CUUdBMVVFQXhNTmJYa3RjbVZzWldGelpTMWpZVEFlRncweU5EQTJNakF4TkRVMU1ESmFGdzB6TkRBMgpNVGd4TkRVMU1ESmFNQmd4RmpBVUJnTlZCQU1URFcxNUxYSmxiR1ZoYzJVdFkyRXdnZ0VpTUEwR0NTcUdTSWIzCkRRRUJBUVVBQTRJQkR3QXdnZ0VLQW9JQkFRQ25PSW1vajRDN1FhckIvSWs3MmFzV0VOU2UvWCtndHovcG5lREMKWE1obnpYWEE3VnFWSUpSYU8ydy95T0ExVjkwNzdHL3A5cGFUSGwra0s1RVNMSDNFNlBZYlNTUzlvelJ3T1A1WQp4bmNDeWdWZzQ1dzFyZEZIWkhMNVpwdEdJaVpqblpNOXJpcTZTYlZOcWowNWQxRFlveGhVQXFocjBvK2gxNkh4Ck44T01jYU83VEVqRnorOWlxSHk2MDNqM2RwVVdyWU1wNmtGY0diQU0zd1NIM1ZtQXczdTd3anpzb3Z2M0dKSUkKMkgrekRZaDFMOHN0dEQ3bnN3TnNjYlpIL0xHWnFSQkp0cHo0cVhDbTVWQy9vWFZ5eTZTRkdBbXZYdzc1eWJtdwpZRWlSTTRuYitVK0M2a2Mvc0puVXZsaFRERnc2Y2ovcXJaaDh2dlJZWU10TFRxN0RBZ01CQUFHallUQmZNQTRHCkExVWREd0VCL3dRRUF3SUNwREFkQmdOVkhTVUVGakFVQmdnckJnRUZCUWNEQVFZSUt3WUJCUVVIQXdJd0R3WUQKVlIwVEFRSC9CQVV3QXdFQi96QWRCZ05WSFE0RUZnUVV0TG1yZURFQVExeG5vMktPczRkYUhaK20rVGN3RFFZSgpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFGeUxqZkpkZE5JT1padXo2bjlPTjZhdGlWUFJkbUJTWWZCSkZwbEF6NDI1CmMvY1d6dGp2QTQxRnJyMExYQTl0MzZvNDY5OEVLa0NpMnM5MUt6VlZSQ3hFV25hMHJqWnE3TTh2TFpJQW44amgKZ01IeU05aWc3VEt1L1p4cGZ1b1dGZFRvVmtuWHdmTVRZd0JjYjdIYzRrOGdIY1BHajhuUVFPMTRiNEdsaTh2WApZZ1BZMW8ySGk4NXZIczdPYVU3Tm5WZXY3SVRnS0xNbkFRb0JwUUhHUUVrb1dHOWwzeXRadWJFR2RVdGtMbTc4Ck00NTJROTcxOEpsZ1dQK3laOXlGRUpRN1NxVFh4L0NxMmpTZDFOOWUzbmpZVU0wcy9kMnpwamdXRmhmbGkybjUKQzFFZUphZ2FEMHRIZlVVT1ZTU1lldmRKVHRORjAweE91YUg0bWlsY2FjUT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
    failurePolicy: Fail
    admissionReviewVersions: [ "v1", "v1beta1" ]
    sideEffects: None
    rules:
      - operations: ["CREATE"]
        apiGroups: [""]
        apiVersions: ["*"]
        resources: ["pods"]
    namespaceSelector:
      matchExpressions:
        - key: kubernetes.io/metadata.name
          operator: NotIn
          values:
            - kube-system
            - kube-public
            # The webhook has to be deployed to its own namespace, or else
            # attempts at scaling up pods will fail when trying to call
            # themself.
            - apm-attacher-1.0.0.tgz
