---
# Source: gitlab-omnibus/templates/rbac-backup.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: my-release-gitlab-omnibus-backup
  namespace: gitlab-omnibus-0.1.3.tgz
---
# Source: gitlab-omnibus/templates/secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: my-release-gitlab-omnibus
  namespace: gitlab-omnibus-0.1.3.tgz
  labels:
    helm.sh/chart: gitlab-omnibus-0.1.3
    app.kubernetes.io/name: gitlab-omnibus
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "15.2.1-ee.0"
    app.kubernetes.io/managed-by: Helm
data:
  gitlab.rb: "ZXh0ZXJuYWxfdXJsICdodHRwczovL2dpdGxhYi5leGFtcGxlLmNvbScKZ2l0bGFiX3JhaWxzWydnaXRsYWJfcmVwb3NpdG9yeV9kb3dubG9hZHNfcGF0aCddID0gJy9vcHQvdG1wL3JlcG9zaXRvcmllcycKZ2l0bGFiX3JhaWxzWydvYmplY3Rfc3RvcmUnXVsnZW5hYmxlZCddID0gdHJ1ZQpnaXRsYWJfcmFpbHNbJ29iamVjdF9zdG9yZSddWydjb25uZWN0aW9uJ10gPSB7CiAgJ3Byb3ZpZGVyJyA9PiAnQVdTJywKICAnYXdzX2FjY2Vzc19rZXlfaWQnID0+ICdYWFgnLAogICdhd3Nfc2VjcmV0X2FjY2Vzc19rZXknID0+ICdYWFgnLAp9CmdpdGxhYl9yYWlsc1snb2JqZWN0X3N0b3JlJ11bJ29iamVjdHMnXVsnYXJ0aWZhY3RzJ11bJ2J1Y2tldCddID0gJ2dpdGxhYi9hcnRpZmFjdHMnCmdpdGxhYl9yYWlsc1snb2JqZWN0X3N0b3JlJ11bJ29iamVjdHMnXVsnZXh0ZXJuYWxfZGlmZnMnXVsnYnVja2V0J10gPSAnZ2l0bGFiL2V4dGVybmFsX2RpZmZzJwpnaXRsYWJfcmFpbHNbJ29iamVjdF9zdG9yZSddWydvYmplY3RzJ11bJ2xmcyddWydidWNrZXQnXSA9ICdnaXRsYWIvbGZzJwpnaXRsYWJfcmFpbHNbJ29iamVjdF9zdG9yZSddWydvYmplY3RzJ11bJ3VwbG9hZHMnXVsnYnVja2V0J10gPSAnZ2l0bGFiL3VwbG9hZHMnCmdpdGxhYl9yYWlsc1snb2JqZWN0X3N0b3JlJ11bJ29iamVjdHMnXVsncGFja2FnZXMnXVsnYnVja2V0J10gPSAnZ2l0bGFiL3BhY2thZ2VzJwpnaXRsYWJfcmFpbHNbJ29iamVjdF9zdG9yZSddWydvYmplY3RzJ11bJ2RlcGVuZGVuY3lfcHJveHknXVsnYnVja2V0J10gPSAnZ2l0bGFiL2RlcGVuZGVuY3lfcHJveHknCmdpdGxhYl9yYWlsc1snb2JqZWN0X3N0b3JlJ11bJ29iamVjdHMnXVsndGVycmFmb3JtX3N0YXRlJ11bJ2J1Y2tldCddID0gJ2dpdGxhYi90ZXJyYWZvcm1fc3RhdGUnCmdpdGxhYl9yYWlsc1snb2JqZWN0X3N0b3JlJ11bJ29iamVjdHMnXVsnY2lfc2VjdXJlX2ZpbGVzJ11bJ2J1Y2tldCddID0gJ2dpdGxhYi9jaV9zZWN1cmVfZmlsZXMnCmdpdGxhYl9yYWlsc1snZXh0ZXJuYWxfZGlmZnNfZW5hYmxlZCddID0gdHJ1ZQpnaXRsYWJfcmFpbHNbJ2V4dGVybmFsX2RpZmZzX3doZW4nXSA9ICdvdXRkYXRlZCcKZ2l0bGFiX3JhaWxzWydzaGFyZWRfcGF0aCddID0gJy9vcHQvdG1wL3NoYXJlZCcKZ2l0bGFiX3JhaWxzWydiYWNrdXBfcGF0aCddID0gIi9vcHQvdG1wL2JhY2t1cHMiCmdpdGxhYl9yYWlsc1snYmFja3VwX3VwbG9hZF9jb25uZWN0aW9uJ10gPSB7CiAgJ3Byb3ZpZGVyJyA9PiAnQVdTJywKICAnYXdzX2FjY2Vzc19rZXlfaWQnID0+ICdYWFgnLAogICdhd3Nfc2VjcmV0X2FjY2Vzc19rZXknID0+ICdYWFgnLAp9CmdpdGxhYl9yYWlsc1snYmFja3VwX3VwbG9hZF9yZW1vdGVfZGlyZWN0b3J5J10gPSAnZ2l0bGFiL2JhY2t1cHMnCmdpdGxhYl9yYWlsc1sndXBsb2Fkc19kaXJlY3RvcnknXSA9ICIvb3B0L3RtcC91cGxvYWRzIgpnaXRsYWJfcmFpbHNbJ2luaXRpYWxfcm9vdF9wYXNzd29yZCddID0gRU5WWydHSVRMQUJfSU5JVElBTF9ST09UX1BBU1NXT1JEJ10KZ2l0bGFiX3JhaWxzWydpbml0aWFsX3NoYXJlZF9ydW5uZXJzX3JlZ2lzdHJhdGlvbl90b2tlbiddID0gRU5WWydHSVRMQUJfUlVOTkVSX1RPS0VOJ10KZ2l0bGFiX3JhaWxzWydkYl9hZGFwdGVyJ10gPSAicG9zdGdyZXNxbCIKZ2l0bGFiX3JhaWxzWydkYl9kYXRhYmFzZSddID0gImdpdGxhYiIKZ2l0bGFiX3JhaWxzWydkYl91c2VybmFtZSddID0gRU5WWydQR19VU0VSJ10KZ2l0bGFiX3JhaWxzWydkYl9wYXNzd29yZCddID0gRU5WWydQR19QQVNTV09SRCddCmdpdGxhYl9yYWlsc1snZGJfaG9zdCddID0gImdpdGxhYi1wb3N0Z3JlcyIKZ2l0bGFiX3JhaWxzWydkYl9wb3J0J10gPSA1NDMyCmdpdGxhYl9yYWlsc1sncmVkaXNfaG9zdCddID0gImdpdGxhYi1yZWRpcy1tYXN0ZXIiCmdpdGxhYl9yYWlsc1sncmVkaXNfcG9ydCddID0gNjM3OQpnaXRsYWJfcmFpbHNbJ3JlZ2lzdHJ5X2VuYWJsZWQnXSA9IGZhbHNlCnJlZ2lzdHJ5WydlbmFibGUnXSA9IGZhbHNlCmdpdGxhYl93b3JraG9yc2VbJ2xpc3Rlbl9uZXR3b3JrJ10gPSAidGNwIgpnaXRsYWJfd29ya2hvcnNlWydsaXN0ZW5fYWRkciddID0gIjAuMC4wLjA6ODAwNSIKc2lkZWtpcVsnbWV0cmljc19lbmFibGVkJ10gPSBmYWxzZQpzaWRla2lxWydoZWFsdGhfY2hlY2tzX2VuYWJsZWQnXSA9IGZhbHNlCnBvc3RncmVzcWxbJ2VuYWJsZSddID0gZmFsc2UKcmVkaXNbJ2VuYWJsZSddID0gZmFsc2UKbmdpbnhbJ2VuYWJsZSddID0gZmFsc2UKcGFnZXNfbmdpbnhbJ2VuYWJsZSddID0gZmFsc2UKZ2l0bGFiX2NpWydidWlsZHNfZGlyZWN0b3J5J10gPSAnL29wdC90bXAvY2ktYnVpbGRzJwpnaXRsYWJfcmFpbHNbJ2dpdGxhYl9rYXNfZW5hYmxlZCddID0gZmFsc2UKZ2l0bGFiX2thc1snZW5hYmxlJ10gPSBmYWxzZQptb25pdG9yaW5nX3JvbGVbJ2VuYWJsZSddID0gZmFsc2UKcHJvbWV0aGV1c1snZW5hYmxlJ10gPSBmYWxzZQpwcm9tZXRoZXVzX21vbml0b3JpbmdbJ2VuYWJsZSddID0gZmFsc2UKYWxlcnRtYW5hZ2VyWydlbmFibGUnXSA9IGZhbHNlCmdyYWZhbmFbJ2VuYWJsZSddID0gZmFsc2UKZ2l0bGFiX2V4cG9ydGVyWydlbmFibGUnXSA9IGZhbHNlCmdpdGxhYl9yYWlsc1sncGFja2FnZXNfZW5hYmxlZCddID0gZmFsc2UKZ2l0bGFiX3JhaWxzWydkZXBlbmRlbmN5X3Byb3h5X2VuYWJsZWQnXSA9IGZhbHNl"
---
# Source: gitlab-omnibus/templates/rbac-backup.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: my-release-gitlab-omnibus-backup
  namespace: gitlab-omnibus-0.1.3.tgz
rules:
  - apiGroups:
      - apps
    resources:
      - statefulsets
    verbs:
      - get
      - list
  - apiGroups:
      - ''
    resources:
      - pods
    verbs:
      - get
      - list
  - apiGroups:
      - ''
    resources:
      - pods/exec
    verbs:
      - create
---
# Source: gitlab-omnibus/templates/rbac-backup.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: my-release-gitlab-omnibus-backup
  namespace: gitlab-omnibus-0.1.3.tgz
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: my-release-gitlab-omnibus-backup
subjects:
  - kind: ServiceAccount
    name: my-release-gitlab-omnibus-backup
---
# Source: gitlab-omnibus/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: my-release-gitlab-omnibus
  namespace: gitlab-omnibus-0.1.3.tgz
  labels:
    helm.sh/chart: gitlab-omnibus-0.1.3
    app.kubernetes.io/name: gitlab-omnibus
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "15.2.1-ee.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: http
    - name: ssh
      port: 22
      targetPort: ssh
  selector:
    app.kubernetes.io/name: gitlab-omnibus
    app.kubernetes.io/instance: my-release
---
# Source: gitlab-omnibus/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: my-release-gitlab-omnibus
  namespace: gitlab-omnibus-0.1.3.tgz
  labels:
    helm.sh/chart: gitlab-omnibus-0.1.3
    app.kubernetes.io/name: gitlab-omnibus
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "15.2.1-ee.0"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: gitlab-omnibus
      app.kubernetes.io/instance: my-release
  serviceName: my-release-gitlab-omnibus
  template:
    metadata:
      labels:
        app.kubernetes.io/name: gitlab-omnibus
        app.kubernetes.io/instance: my-release
      annotations:
        checksum/config: 11712634ed6cd80ceb185f29bca5b9e9ff75fbc0da9f4f163b65f97b43555fd1
    spec:
      serviceAccountName: default
      securityContext:
        {}
      containers:
        - name: gitlab-omnibus
          securityContext:
            {}
          image: "gitlab/gitlab-ee:15.2.1-ee.0"
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8005
              name: http
            - containerPort: 22
              name: ssh
          livenessProbe:
            httpGet:
              path: /-/liveness?token=CHANGE_ME
              port: http
          readinessProbe:
            httpGet:
              path: /-/readiness?token=CHANGE_ME
              port: http
          startupProbe:
            initialDelaySeconds: 60
            failureThreshold: 300
            periodSeconds: 2
            httpGet:
              path: /-/readiness?token=CHANGE_ME
              port: http
          resources:
            {}
          env:
            - name: GITLAB_OMNIBUS_CONFIG
              value: 'from_file "/etc/gitlab-provisioned-config.rb"'
            - name: GITLAB_POST_RECONFIGURE_CODE
              value: |
                include Gitlab::CurrentSettings
                Gitlab::CurrentSettings.current_application_settings.update_attribute(:health_check_access_token, 'CHANGE_ME')
                
            - name: GITLAB_POST_RECONFIGURE_SCRIPT
              value: |
                /opt/gitlab/bin/gitlab-rails runner -e production "$GITLAB_POST_RECONFIGURE_CODE"
          volumeMounts:
            - name: provisioned-config
              mountPath: /etc/gitlab-provisioned-config.rb
              subPath: gitlab.rb
      volumes:
        - name: provisioned-config
          secret:
            secretName: my-release-gitlab-omnibus
            items:
              - key: gitlab.rb
                path: gitlab.rb
                mode: 292 # 0444
---
# Source: gitlab-omnibus/templates/cronjob-backup.yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: my-release-gitlab-omnibus-backup
  namespace: gitlab-omnibus-0.1.3.tgz
  labels:
    helm.sh/chart: gitlab-omnibus-0.1.3
    app.kubernetes.io/name: gitlab-omnibus
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "15.2.1-ee.0"
    app.kubernetes.io/managed-by: Helm
    component: 'backup'
spec:
  concurrencyPolicy: Forbid
  schedule: "@daily"
  jobTemplate:
    metadata:
      labels:
        app.kubernetes.io/name: gitlab-omnibus
        app.kubernetes.io/instance: my-release
        component: 'backup'
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: gitlab-omnibus
            app.kubernetes.io/instance: my-release
            component: 'backup'
          annotations:
            {}
        spec:
          serviceAccountName: my-release-gitlab-omnibus-backup
          restartPolicy: Never
          containers:
            - name: gitlab-omnibus
              image: daedalusproject/base_kubectl
              command:
                - kubectl
              args:
                - exec
                - sts/my-release-gitlab-omnibus
                - -ngitlab-omnibus-0.1.3.tgz
                - --
                - gitlab-backup
                - create
                - SKIP=uploads,builds,artifacts,terraform_state,registry,pages,packages
                - GZIP_RSYNCABLE=yes
                - STRATEGY=copy
              resources:
                requests:
                  cpu: 10m
                  memory: 32Mi
