---
# Source: filebeat/templates/cm.yml
apiVersion: v1
kind: ConfigMap
metadata:
  name: filebeat-config
  # namespace: elastic-system
  labels:
    k8s-app: filebeat
data:
  filebeat.yml: |-
    filebeat:
      inputs:
      # - enabled: false
      #   paths:
      #   - /var/logs/*.log
      #   type: log
      # - enabled: false
      #   paths:
      #   - /var/log/*.log
      #   type: filestream
      - enabled: true
        recursive_glob.enabled: true
        paths:
        - /data/offlineLogFolder//*/*/*
        exclude_files: ['\.swp$']
        fields:
          type: junos_offlog
        close_inactive: 3000m

    filebeat.config.modules:
      path: ${path.config}/modules.d/*.yml
      reload.enabled: true
      reload.period: 30s
    logging.metrics.enabled: false
    setup:
      filebeat.modules:
        module: cisco

    filebeat.modules:
    - module: cisco
      ios:
        enabled: true
        var.input: syslog
        var.syslog_host: 0.0.0.0
        var.syslog_port: 9001
        var.syslog_protocol: udp
    - module: juniper
      junos:
        enabled: true
        var.input: udp
        var.syslog_host: 0.0.0.0
        var.syslog_port: 9006

    # output.elasticsearch:
    #   hosts: ["https://${ELASTICSEARCH_HOST}:${ELASTICSEARCH_PORT}"]
    #   username: "${ELASTICSEARCH_USERNAME}"
    #   password: "${ELASTICSEARCH_PASSWORD}"
    #   # If using Elasticsearch's default certificate
    #   # ssl.ca_trusted_fingerprint: "<es cert fingerprint>"
    #   ssl.verification_mode: none
    setup.kibana:
      host: mbf-kb-http:5601

    ###############################################################################
    ############################# Libbeat Config ##################################
    # Base config file used by all other beats for using libbeat features

    ############################# Output ##########################################
    # fix this
    output:
      logstash:
        bulk_max_size: 50
        hosts:
        # - 10.98.100.101:30555
        # - 10.98.100.102:30555
        # - 10.98.100.103:30555
        - 172.168.1.2:5555 # one logstash at a time, since ExtTrafPo: Local
        #- 10.98.0.152:6666
        loadbalance: true


    ############################# Logging #########################################

    # logging:
    #   files:
    #     rotateeverybytes: 10485760
    #   level: warning

    http.enabled: true
    http.port: 5067
    monitoring.enabled: false
    http.host: 0.0.0.0
---
# Source: filebeat/templates/filebeat.yml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: my-release-filebeat
  labels:
    app.kubernetes.io/name: filebeat
    helm.sh/chart: filebeat-1.0.0
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: debuger
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: filebeat
      app.kubernetes.io/instance: my-release
  template:
    metadata:
      labels:
        app.kubernetes.io/name: filebeat
        helm.sh/chart: filebeat-1.0.0
        app.kubernetes.io/instance: my-release
        app.kubernetes.io/managed-by: Helm
    spec:
      # hostNetwork: true
      affinity:
        podAffinity:
          
        podAntiAffinity:
          
        nodeAffinity:
          
      containers:
        - name: filebeat
          image: docker.elastic.co/beats/filebeat:8.9.1
          args: [
            "-c", "/etc/filebeat.yml",
            "-e",
          ]
          env:
          - name: ELASTICSEARCH_HOST
            value: mbf-es-http
          - name: ELASTICSEARCH_PORT
            value: "9200"
          - name: ELASTICSEARCH_USERNAME
            valueFrom:
                secretKeyRef:
                  name: es-basic-auth
                  key: username
          - name: ELASTICSEARCH_PASSWORD
            valueFrom:
                secretKeyRef:
                  name: es-basic-auth
                  key: password
          - name: ELASTIC_CLOUD_ID
            value:
          - name: ELASTIC_CLOUD_AUTH
            value:
          - name: NODE_NAME
            valueFrom:
              fieldRef:
                fieldPath: spec.nodeName
          securityContext:
            runAsUser: 0
            # If using Red Hat OpenShift uncomment this:
            #privileged: true
          volumeMounts:
          - name: config
            mountPath: /etc/filebeat.yml
            readOnly: true
            subPath: filebeat.yml
          - name: offline-log
            mountPath: /data/offlineLogFolder/
          # - name: varlibdockercontainers
          #   mountPath: /var/lib/docker/containers
          #   readOnly: true
          # - name: varlog
          #   mountPath: /var/log
          #   readOnly: true
          # - name: index-syslog
          #   mountPath: /var/tmp/index_syslog/
          #   readOnly: true
      volumes:
      - name: config
        configMap:
          defaultMode: 0640
          name: filebeat-config
      - name: offline-log
        hostPath:
          path: /data/offlineLogFolder/
          type: DirectoryOrCreate
      # - name: varlibdockercontainers
      #   hostPath:
      #     path: /var/lib/docker/containers
      # - name: varlog
      #   hostPath:
      #     path: /var/log
      # - name: index-syslog
      #   hostPath:
      #     path: /data/syslog-rundeck/index_syslog/
