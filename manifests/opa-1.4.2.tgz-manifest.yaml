---
# Source: opa/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: my-release-opa
  labels:
    app: my-release-opa
    chart: opa-1.4.2
    release: "my-release"
    heritage: "Helm"
---
# Source: opa/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: my-release-opa-config
  labels:
    app: my-release-opa
    chart: "opa-1.4.2"
    release: "my-release"
    heritage: "Helm"
type: Opaque
data:
  config.yaml: YnVuZGxlOgogIG5hbWU6IGhlbG0ta3ViZXJuZXRlcy1xdWlja3N0YXJ0CiAgc2VydmljZTogY29udHJvbGxlcgpkZWZhdWx0X2RlY2lzaW9uOiAvaGVsbV9rdWJlcm5ldGVzX3F1aWNrc3RhcnQvbWFpbgpzZXJ2aWNlczoKICBjb250cm9sbGVyOgogICAgdXJsOiBodHRwczovL3d3dy5vcGVucG9saWN5YWdlbnQub3Jn
---
# Source: opa/templates/webhookconfiguration.yaml
apiVersion: v1
kind: Secret
metadata:
  name: my-release-opa-cert
  labels:
    app: my-release-opa
    chart: "opa-1.4.2"
    release: "my-release"
    heritage: "Helm"
type: Opaque
data:

  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURLekNDQWhPZ0F3SUJBZ0lSQU82c2tKbUtXdi90VGtGZ29QbkxNeUV3RFFZSktvWklodmNOQVFFTEJRQXcKR3pFWk1CY0dBMVVFQXhNUWIzQmhMV0ZrYldsemMybHZiaTFqWVRBZUZ3MHlOREEyTVRZd01ETXpNamxhRncwegpOREEyTVRRd01ETXpNamxhTUNVeEl6QWhCZ05WQkFNVEdtMTVMWEpsYkdWaGMyVXRiM0JoTG1SbFptRjFiSFF1CmMzWmpNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQTBXb0tPWGMvOVpqTFVSR3UKLzdoUC9nUjhJRE9TUktVRUo1UXgwUUpJWHp4VDF5MUt2V3ZuWkNnWXRieS9OWXJWMzBpcXppdmtXeGFjTFlDNAo4dVBlMUp5L1JCUU8yckxLZzRtNDlFd09QVUVTdkx6amoxTFRHSlRWc2U0NmtBMWFjOGl0ZjdlRm16MkVJdnFWCmsvUG5oaHVseFpKNFlKYTY1TUNLSzl4MEpRaWJWNEgwV0NhZXZrZ2x2dWhudHdaWnF1b1J4T1d1Tmh4ejF4RzQKWFJhTlNZbGovcXZZcUdmeCtrSFROUzhJZ2t5c1BaMkdmRG53WnprMDNObDdCcnEreHhPdHVSaEtsalpaWVZsZApqdlpkTHpBZS8zaVQxV1lKWlJYdXM1dWFWZm45QzhybDVtVmZ4N3ZURVNxek9sZmQwUUJyUy9Jc0ovZG9aWDdLCk1KWmIvd0lEQVFBQm8yQXdYakFPQmdOVkhROEJBZjhFQkFNQ0JhQXdIUVlEVlIwbEJCWXdGQVlJS3dZQkJRVUgKQXdFR0NDc0dBUVVGQndNQ01Bd0dBMVVkRXdFQi93UUNNQUF3SHdZRFZSMGpCQmd3Rm9BVU56WHVEOHk4UHIvNApXK1pITU1GaUhkSGhNcHN3RFFZSktvWklodmNOQVFFTEJRQURnZ0VCQUVuZ3JVN3VUZ24zN3VjdHBndFNwNUhEClhFU21yR1Nvc1VEWFJheld3dkxST2xGY0grMWdhT3VhK2FHNTdEMDd0eEFPK2RkTnBRQjZneHpRUlptTkRFNDcKalRTUU95N0JQT21CR0RFN0s1WEV5QVR3bmkxTzRUckhHWWlOOTdhYTQ3WFc0K1EvQmF3MFNLdkR3UUJrV0pBMgpKUVVQN25ueFFRdjFKTXNkNVQybnZVWUMvMDRIN1h0RnV1SGpmeGs3RlpubGllbnJzZ1VhV25pa1VFekdpVWxyCnVFUXZVMFdMOTJLbTdRaGlCN0pFaXdPc2swd0o3THZ1NWxoOGlDVXE4M2dpek1OU1hBV2RVVnE5OWNMWEFqTVcKVGE2dW9lcHMvSGJmN1VoaEk3V2YwenBTTzloTVFTRTdVdGxxcnFUUWxvM2N3V0hrdjkwMWxQaEJidzRnWis4PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb2dJQkFBS0NBUUVBMFdvS09YYy85WmpMVVJHdS83aFAvZ1I4SURPU1JLVUVKNVF4MFFKSVh6eFQxeTFLCnZXdm5aQ2dZdGJ5L05ZclYzMGlxeml2a1d4YWNMWUM0OHVQZTFKeS9SQlFPMnJMS2c0bTQ5RXdPUFVFU3ZMemoKajFMVEdKVFZzZTQ2a0ExYWM4aXRmN2VGbXoyRUl2cVZrL1BuaGh1bHhaSjRZSmE2NU1DS0s5eDBKUWliVjRIMApXQ2FldmtnbHZ1aG50d1pacXVvUnhPV3VOaHh6MXhHNFhSYU5TWWxqL3F2WXFHZngra0hUTlM4SWdreXNQWjJHCmZEbndaemswM05sN0JycSt4eE90dVJoS2xqWlpZVmxkanZaZEx6QWUvM2lUMVdZSlpSWHVzNXVhVmZuOUM4cmwKNW1WZng3dlRFU3F6T2xmZDBRQnJTL0lzSi9kb1pYN0tNSlpiL3dJREFRQUJBb0lCQUIzaUMrTjNhT0ViRktoVQo1YXdJR1NJZWNiZ0dvL0MzdTRnS1ZiR0ZxZDR0TmFtWEJQdFMwb293VHBaZ2dNaWJMem5Wbk1vZTZVODJRc01iCmcwamx5MzU3ZjYrdlRROVlSQjNSSVZ0N0h1ME94Q1c2cnA1ZEsxSnVxcS9oVnVvSGZjalg4aW92ZmhsUkJmSVgKNEJCazFiMEZaUHAwbEVqME9XYzdNbnhmMFJNWGpUY21DN3VqQ09rSFRqeUxrYnZ0U1Q5ckkwSjdrcVVFVEl0egpMNFoxU0JsbmlvSzFLUUR4TC9OQnF4SWxJSmVaZDl0bUFNa2s0VmxZOG9xTzZwTElwU3NXSmdLY21mREVFR1RwCkl2TXcwMnlVcnpTZFRubTVUM0x3M1dGWHNPVSsyTTM3dTJQWXR6cDM1Q2gwT2V3eFVMYmVOY3pmMTdob0pSeWMKaExGd2NvRUNnWUVBNE0rSXZtYUhLeExOWGtDdXBLOXFRYXh0VmlPSGQzSitYZFVzeDlIdlZWSlB2OXZpaWZYZAoyYkNSZUMrb2U4QUZid0lRdTVvdktnZW5rcHJPakdNbkoyZVV6Qm5HdU9lN252a0FFUEVpUzNBamsyZ3RnVjI2ClBYMFRXOUkrK0MrWjJVT2czaGY5aTdnMUlJOGFuYy9JSzVGREs2RGRzcWVseUZ3UlFmNFBYamNDZ1lFQTduZXQKekpBMHJjOWpYZzJkY3h5bzMxMmd5d1pheWVqZjlacUp3aEtUcUpBWEp3ZmNDZngvanhQOTdJdkM2cE9Ucm9sWgpwelg2dUdnTDhXL0ZsemNXaklwVHRjMnNVMWRnTXROa3NNdTJpeU5YL2s1M0FUR1pscE5BaWc5dUYyVExmNkF2CkI1bE1Kc0Irb2RyMlpZNHJDNWVWZTg1bTZJWE1HOXIxRFM0NXpIa0NnWUFhVVRFNDJOZkoreEYvanlMaXRJWkQKMmVPU3llWDUzYlZkVnE4L1ZSd25hTk5kS21pQ3JmMmlsa0R4U09MNFdhcEpMSHk0K1h1Nzk5bHVHQ0ZGM2ZXZgpiMGpEKytCL2xPRXA0d3hXNzJPTVlUeEk3VkVtYThwNW1FTEQ1UURxSE9odHZyVCtTdUNya296bG10c0t6bUFvCmVZRGJncUZ4WUo3UHJiZDNlajVpVVFLQmdHTTJRNGF5RUZpbnljMmRtSDRGMUhScHZiWDZCTmV3SFUxUGFEVG8KQ2FxOW1BUlREc2JRMkRrc3RoNHQzNEE4dWRxSnBsVWM3aHkrblFscjJTY2FjalV5YjdWWnhuSStEZlhYWVRMMAo3aE5oTndERW9GcE15bnVNOC9MOGpHOExMbWNBdTlCTGhSVXlUUDBGM2pGT1ByWnA4SFU3NERDcFNjdmxBc0xqCkVvVHhBb0dBUWlBS2hMdlY2alRTbzFxZ2ljSnpYNHd0V1VlRERjbGRzanpxUkYvc3gxNFBucUhGU1F4VG95eXEKVllHOERhbkxoSFlxWTRacER3QldqQW5KVzkrR0pwUlZnSVBvUE1meUlWdEhlUHZVWStvQmhrdVVRVEhOR3BJQQpSdlRkWmpOSnJaMFd0MS9MWWdYVmh3Z0pPdHp4eVVBTzMvQXJFb0IxZVJQU1N3U2l1R2M9Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
---
# Source: opa/templates/mgmt-clusterrole.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app: opa
    chart: opa-1.4.2
    heritage: Helm
    release: my-release
    component: mgmt
  name: my-release-opa-mgmt
rules:
  []
---
# Source: opa/templates/mgmt-clusterrolebinding.yaml
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  labels:
    app: opa
    chart: opa-1.4.2
    heritage: Helm
    release: my-release
    component: mgmt
  name: my-release-opa-mgmt
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: my-release-opa-mgmt
subjects:
  - kind: ServiceAccount
    name: my-release-opa
    namespace: default
---
# Source: opa/templates/service.yaml
kind: Service
apiVersion: v1
metadata:
  name: my-release-opa
  labels:
    app: my-release-opa
    chart: "opa-1.4.2"
    release: "my-release"
    heritage: "Helm"
spec:
  selector:
    app: my-release-opa
  ports:
  - name: https
    protocol: TCP
    port: 443
    targetPort: 443
---
# Source: opa/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-release-opa
  labels:
    app: my-release-opa
    chart: "opa-1.4.2"
    release: "my-release"
    heritage: "Helm"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: my-release-opa
  template:
    metadata:
      labels:
        app: my-release-opa
      name: my-release-opa
    spec:
      initContainers:
        - name: initpolicy
          image: openpolicyagent/kube-mgmt:0.8
          imagePullPolicy: IfNotPresent
          resources:
            {}
          command:
          - /bin/sh
          - -c
          - |
            tr -dc 'A-F0-9' < /dev/urandom | dd bs=1 count=32 2>/dev/null > /authz/mgmt-token
            TOKEN=`cat /authz/mgmt-token`
            cat > /authz/authz.rego <<EOF
            package system.authz
            default allow = false
            allow { input.path = [""]; input.method = "POST" }
            allow { input.path = [""]; input.method = "GET" }
            allow { input.identity = "$TOKEN" }
            EOF
          volumeMounts:
            - name: authz
              mountPath: /authz
      containers:
        - name: opa
          image: openpolicyagent/opa:0.10.7
          imagePullPolicy: IfNotPresent
          resources:
            {}
          args:
            - "run"
            - "--server"
            - "--config-file=/config/config.yaml"
            - "--tls-cert-file=/certs/tls.crt"
            - "--tls-private-key-file=/certs/tls.key"
            - "--addr=0.0.0.0:443"
            - "--log-level=info"
            - "--log-format=text"
            - "--authentication=token"
            - "--authorization=basic"
            - "/authz/authz.rego"
            - "--ignore=.*"
            - "--insecure-addr=127.0.0.1:8181"
          volumeMounts:
            - name: certs
              readOnly: true
              mountPath: /certs
            - name: config
              readOnly: true
              mountPath: /config
            - name: authz
              readOnly: true
              mountPath: /authz
        - name: mgmt
          image: openpolicyagent/kube-mgmt:0.8
          imagePullPolicy: IfNotPresent
          resources:
            {}
          args:
            - --opa-auth-token-file=/authz/mgmt-token
            - --opa-url=http://127.0.0.1:8181/v1
            - --replicate-path=kubernetes
            - --enable-policies=false
          volumeMounts:
            - name: authz
              readOnly: true
              mountPath: /authz
          readinessProbe:
            httpGet:
              initialDelaySeconds: 3
              path: /
              periodSeconds: 5
              port: 443
              scheme: HTTPS
          livenessProbe:
            httpGet:
              initialDelaySeconds: 3
              path: /
              periodSeconds: 5
              port: 443
              scheme: HTTPS
      serviceAccountName: my-release-opa
      volumes:
        - name: certs
          secret:
            secretName: my-release-opa-cert
        - name: config
          secret:
            secretName: my-release-opa-config
        - name: authz
          emptyDir: {}
      nodeSelector:
        {}
      tolerations:
        []
---
# Source: opa/templates/webhookconfiguration.yaml
kind: ValidatingWebhookConfiguration
apiVersion: admissionregistration.k8s.io/v1beta1
metadata:
  name: my-release-opa
  annotations:
  labels:
    app: my-release-opa
    chart: "opa-1.4.2"
    release: "my-release"
    heritage: "Helm"
webhooks:
  - name: webhook.openpolicyagent.org
    namespaceSelector:
      matchExpressions:
        - {key: openpolicyagent.org/webhook, operator: NotIn, values: [ignore]}
    failurePolicy: Ignore
    rules:
      - apiGroups:
        - '*'
        apiVersions:
        - '*'
        operations:
        - '*'
        resources:
        - '*'
    clientConfig:


      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURJVENDQWdtZ0F3SUJBZ0lRWDBvZ1V2aUNkWVpXeFlLbUYzS3UvVEFOQmdrcWhraUc5dzBCQVFzRkFEQWIKTVJrd0Z3WURWUVFERXhCdmNHRXRZV1J0YVhOemFXOXVMV05oTUI0WERUSTBNRFl4TmpBd016TXlPRm9YRFRNMApNRFl4TkRBd016TXlPRm93R3pFWk1CY0dBMVVFQXhNUWIzQmhMV0ZrYldsemMybHZiaTFqWVRDQ0FTSXdEUVlKCktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQU0wQnR2RVR3ejVZaFJVWFN4N21wSzYraGdQMWJDOFMKVG1NQktaTFREb1M5UGovb25TbzZHemVqUFllKy9xa0pRcGwrQkFrM1RnSUx1UWlUejRsVVVYNmJDSTRFcWc4Ngpsejl6SjhubnNNSUpJM096cm8vUWRsdERKWXVyclR0Yll0YnBMQkMzaDcwYlQ0ZnJkckkrY3lJemdOSWEvbmV3CnQ0K29EaDMwQkUzSmFRY2ZVVVZtTFVLY3lqRTRyeWkzQzF6bzVYWmo3dXFMU3FYTGdibUY4MHppQ3k5Y0lGYVAKSUd0cks1cTdFN1NSQWd0anFkNHVXbGpqZ0xXT2ZRZnFSZ3Yybyt5MlNXMnBtZ01HYnU1Z290WmwrdEJOU3AzbwpycWZSZGFRZlVKR3NwdzZuZnZIR2E1RUZJL3NUWDlxZncwNUpiMXRydm9CVVoxT08wLzc5NUQwQ0F3RUFBYU5oCk1GOHdEZ1lEVlIwUEFRSC9CQVFEQWdLa01CMEdBMVVkSlFRV01CUUdDQ3NHQVFVRkJ3TUJCZ2dyQmdFRkJRY0QKQWpBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUIwR0ExVWREZ1FXQkJRM05lNFB6THcrdi9oYjVrY3d3V0lkMGVFeQptekFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBaWVielJUQU1QeEk3OWs3YjZ1OGpLc29vdkkyUFF1Zi9WMkkvCnlIQmwzQ2h5U0docnJTSE5Qdm9RVENVZVFEZDJFR2I1UWcrZXVaSlRWZGdpbnVXZ21IZEpQUXArajMwUytyTlcKYXBaZWZIalgrQWR0VTB3enJVZldUWXlQUnpvUXJmZVpGSVc4SHVUdXhxaHNnWEJ2UitmUUZleXhJeU0vclRibworMjJjaERYMTd2cGcvazFmQVRqSWhjMHlXWG82YnEwN0NkSDhVUHV5TzhqeDRtRDd2aENoNU1sa2JxSktjL1dCCmJGUTErNktRTy9WTXRnWVdrdVptQ1d2T0xkaEZnaGRDQ0FTQlhncUlNYWkzMVZwckxTUzBadlNmTGdPWGZGOUMKdDVLYzZ6OGE1bUJkdWZoeXNQYlVLZ2NFcExxZlRLMERmY09oVDZiMlkrWTJpMWh3MEE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==


      service:
        name: my-release-opa
        namespace: default
