---
# Source: argo-rollouts/templates/rollout-crd-view.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    bundle.kubegems.io/ignore-options: OnUpdate
  labels:
    app: rollout-crd-view
    rbac.authorization.k8s.io/aggregate-to-view: "true"
  name: rollout-crd-view
rules:
- apiGroups:
  - argoproj.io
  resources:
  - rollouts
  verbs:
  - get
  - list
  - watch
---
# Source: argo-rollouts/templates/argo-rollouts.yaml
apiVersion: argoproj.io/v1alpha1
kind: ClusterAnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  - name: namespace
    valueFrom:
      fieldRef:
        fieldPath: metadata.namespace
  metrics:
  - interval: 1m
    count: 5
    failureLimit: 3
    name: success-rate
    successCondition: result[0] >= 0.95
    provider:
      prometheus:
        address: 
        query: |
          sum(irate(
              istio_requests_total{reporter="source",destination_service_name=~"{{args.service-name}}",destination_service_namespace="{{args.namespace}}",response_code!~"5.*"}[5m]
          )) /
          sum(irate(
              istio_requests_total{reporter="source",destination_service_name=~"{{args.service-name}}",destination_service_namespace="{{args.namespace}}"}[5m]
          )) > 0 or vector(1)
---
# Source: argo-rollouts/templates/argo-rollouts.yaml
# https://github.com/argoproj/argo-helm/tree/master/charts/argo-rollouts
apiVersion: plugins.kubegems.io/v1beta1
kind: Plugin
metadata:
  name: argo-rollouts
  namespace: default
spec:
  kind: helm
  url: https://argoproj.github.io/argo-helm
  version: 2.14.0
  values:
    controller:
      image:
