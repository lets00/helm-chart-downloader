---
# Source: mariadb/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: my-release-mariadb
  labels: 
    helm.sh/chart: mariadb-10.10.4-0
    app.kubernetes.io/name: mariadb
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "10.10.2"
    app.kubernetes.io/managed-by: Helm
---
# Source: mariadb/templates/secret.yaml
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: my-release-mariadb
  labels: 
    helm.sh/chart: mariadb-10.10.4-0
    app.kubernetes.io/name: mariadb
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "10.10.2"
    app.kubernetes.io/managed-by: Helm
data:
  mariadb-root-password: "SHNVSExSOGNYeW5MeTJuVGZzUVFRQVJaVTFSZTZnZmg="
stringData:
  root-my.cnf: |
    [client]
    password="HsUHLR8cXynLy2nTfsQQQARZU1Re6gfh"
---
# Source: mariadb/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: my-release-mariadb
  labels: 
    helm.sh/chart: mariadb-10.10.4-0
    app.kubernetes.io/name: mariadb
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "10.10.2"
    app.kubernetes.io/managed-by: Helm
data:
  my.cnf: |
    [mysqld]
    innodb_use_native_aio=OFF
    log-bin=ON
    log-basename=binary_log
  entrypoint.sh: |
    #!/bin/bash
    set -eo pipefail
    shopt -s nullglob
    # Override sleep to be 10x slower
    sleep() { echo "Waiting...";/usr/bin/sleep ${1}0; }
    source /usr/local/bin/docker-entrypoint.sh
    _main mariadbd "$@"
---
# Source: mariadb/templates/service-headless.yaml
apiVersion: v1
kind: Service
metadata:
  name: my-release-mariadb-headless
  labels:
    helm.sh/chart: mariadb-10.10.4-0
    app.kubernetes.io/name: mariadb
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "10.10.2"
    app.kubernetes.io/managed-by: Helm
spec:
  clusterIP: None  # Headless service
  ports:
    - name: mysql
      containerPort: 3306
      protocol: TCP
  selector: 
    app.kubernetes.io/name: mariadb
    app.kubernetes.io/instance: my-release
---
# Source: mariadb/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: my-release-mariadb
  labels: 
    helm.sh/chart: mariadb-10.10.4-0
    app.kubernetes.io/name: mariadb
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "10.10.2"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  selector: 
    app.kubernetes.io/name: mariadb
    app.kubernetes.io/instance: my-release
  ports:
  - name: mysql
    targetPort: 3306
    protocol: TCP
    port: 3306
---
# Source: mariadb/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: my-release-mariadb
  labels: 
    helm.sh/chart: mariadb-10.10.4-0
    app.kubernetes.io/name: mariadb
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "10.10.2"
    app.kubernetes.io/managed-by: Helm
spec:
  serviceName: my-release-mariadb-headless
  replicas: 1
  selector:
    matchLabels: 
      app.kubernetes.io/name: mariadb
      app.kubernetes.io/instance: my-release
  template:
    metadata:
      labels: 
        app.kubernetes.io/name: mariadb
        app.kubernetes.io/instance: my-release
    spec:
      serviceAccountName: my-release-mariadb
      securityContext: 
        fsGroup: 10000
      containers:
      - name: mariadb
        securityContext: 
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsGroup: 10000
          runAsNonRoot: true
          runAsUser: 10000
        image: "mariadb:10.10.2"
        imagePullPolicy: IfNotPresent
        # command: ["sleep", "infinity"]  # for debugging
        command: ["/usr/local/bin/entrypoint.sh"]
        args: 
        env:
        - name: MYSQL_ROOT_PASSWORD_FILE
          value: /run/credentials/mariadb-root-password
        ports:
        - name: mysql
          containerPort: 3306
          protocol: TCP
        readinessProbe:
          initialDelaySeconds: 30
          periodSeconds: 60
          exec:
            command:
            - /usr/bin/bash
            - -c
            - "mysqladmin ping -uroot -p\"$(cat $MYSQL_ROOT_PASSWORD_FILE)\""
        resources: 
          {}
        volumeMounts:
        - name: my-release-mariadb-run-db
          mountPath: /run/mysqld
        - name: my-release-mariadb-data
          mountPath: /var/lib/mysql
        - name: my-release-mariadb-temp
          mountPath: /tmp
        - name: my-release-mariadb-config
          mountPath: /usr/local/bin/entrypoint.sh
          subPath: entrypoint.sh
        - name: my-release-mariadb-config
          mountPath: /etc/mysql/conf.d/my.cnf
          subPath: my.cnf
          readOnly: true
        - name: my-release-mariadb-creds
          mountPath: /run/credentials/mariadb-root-password
          subPath: mariadb-root-password
          readOnly: true
      volumes: 
      - name: my-release-mariadb-init
        configMap:
          name: my-release-mariadb
          items:
      - name: my-release-mariadb-config
        configMap:
          name: my-release-mariadb
          defaultMode: 0775
          items:
          - key: "entrypoint.sh"
            path: "entrypoint.sh"
          - key: "my.cnf"
            path: "my.cnf"
      - name: my-release-mariadb-data
        emptyDir:
      - name: my-release-mariadb-temp
        emptyDir:
      - name: my-release-mariadb-run-db
        emptyDir:
      - name: my-release-mariadb-run-ldap
        emptyDir:
      - name: my-release-mariadb-creds
        secret:
          secretName: my-release-mariadb
          defaultMode: 0400
          items:
          - key: "mariadb-root-password"
            path: "mariadb-root-password"
